function initializeFileManager(e,t,r,a){let i="1"===r?a:"null";document.addEventListener("click",function(a){if(a.target.classList.contains("fa-edit")){let n=a.target.dataset.file;renameFile(n,e,t,i,r)}}),document.addEventListener("click",function(a){if(a.target.classList.contains("directory-link")){a.preventDefault();let n=a.target.dataset.path;n&&n!==t&&loadDirectory(t=n,1,e,i,r)}}),loadDirectory(t,1,e,i,r)}function sendRequest(e,t,r){if(!e.csrf)throw Error("CSRF token is missing.");let a=JSON.stringify(e),i="1"===r?encrypt(a,t):a;return new Promise((e,a)=>{$.post("",i).done(i=>{try{let n="1"===r?decrypt(i,t):i,o=JSON.parse(n);o.error?a(o.error):e(o)}catch(l){a("Failed to parse server response."),triggerAlert("warning","Failed to parse server response")}}).fail((e,t,r)=>{a(`Network error: ${t} - ${r}`),triggerAlert("warning","Failed to response")})})}function showRenameDialog(e,t,r,a,i){let n=document.documentElement.classList.contains("dark");Swal.fire({title:e,input:"text",inputLabel:t,inputValue:a,showCancelButton:!0,confirmButtonText:r,cancelButtonText:"Cancel",customClass:{popup:n?"bg-gray-900 text-white":"bg-white text-gray-900",confirmButton:n?"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded":"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",cancelButton:n?"bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded":"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded",input:n?"bg-gray-800 text-white border-gray-700":"bg-white text-gray-900 border-gray-300"}}).then(e=>{if(e.isConfirmed){let t=e.value.trim();i(t)}})}function showConfirmation(e,t,r,a){let i=document.documentElement.classList.contains("dark");Swal.fire({title:e,text:t,icon:"warning",showCancelButton:!0,confirmButtonText:r,cancelButtonText:"Cancel",customClass:{popup:i?"bg-gray-900 text-white":"bg-white text-gray-900",confirmButton:i?"bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded":"bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded",cancelButton:i?"bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded":"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded"}}).then(e=>{e.isConfirmed&&a()})}function renameFile(e,t,r,a,i){showRenameDialog("Rename File","Enter the new name for the file:","Rename",e,n=>{n&&n.trim()!==e&&sendRequest({csrf:t,action:"rename",oldName:e,newName:n.trim(),dir:r},a,i).then(()=>{triggerAlert("success","File renamed successfully!"),loadDirectory(r,1,t,a,i)}).catch(e=>{triggerAlert("warning",e),console.error("Error renaming file:",e)})})}function deleteFile(e,t,r,a,i){console.log("currentDir : "+r),showConfirmation("Delete File",`Are you sure you want to delete "${e}"?`,"Delete",()=>{sendRequest({csrf:t,action:"delete",file:e,dir:r},a,i).then(()=>{triggerAlert("success",`"${e}" has been deleted successfully!`),loadDirectory(r,1,t,a,i)}).catch(e=>{triggerAlert("warning",e),console.error("Error deleting file:",e)})})}function progr(){isLoading||(isLoading=!0,NProgress.start())}function dprogr(){NProgress.done(),isLoading=!1}function loadDirectory(e,t,r,a,i,n=40){progr();let o=JSON.stringify({csrf:r,action:"list",dir:e,page:t,itemsPerPage:n}),l="1"===i?encrypt(o,a):o;$.post("",l,function(n){handleDirectoryResponse(n,i,a,e,t,r),dprogr()}).fail(function(){triggerAlert("warning","An error occurred while loading the directory."),dprogr()})}function handleDirectoryResponse(e,t,r,a,i,n){try{let o="1"===t?decrypt(e,r):e;if(o){let l=JSON.parse(o);l.error?triggerAlert("warning",l.error):(fileManagerState.files=l.files,fileManagerState.totalPages=l.totalPages,1===i?renderFiles(l.files,a,n,r,t):appendFiles(l.files,a,n,r,t),$("#currentPath").text("Current Path: "+a))}else triggerAlert("warning","Failed to decrypt response.")}catch(s){triggerAlert("warning","An error occurred while loading the directory."),console.error("Error:",s.message)}}function createFileRow(e,t,r,a,i){if(".."===e.name){let n=t.split("/").slice(0,-1).join("/")||"/";return`
            <tr class="border-b border-gray-200 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700">
                <td class="py-1 px-3 text-left">
                    <input type="checkbox" class="file-checkbox" data-file="${t+"/"+e.name}" disabled />
                </td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">
                    <i class="fas ${e.icon} mr-2"></i>
                    <a href="#" class="font-medium directory-link" data-path="${n}">${e.name}</a>
                </td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.size}</td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.mtime}</td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.owner}</td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.perms}</td>
                <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300"></td>
            </tr>
        `}return`
        <tr class="border-b border-gray-200 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700">
            <td class="py-1 px-3 text-left">
                <input type="checkbox" class="file-checkbox" data-file="${t+"/"+e.name}" />
            </td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">
                <i class="fas ${e.icon} mr-2"></i>
                ${e.is_dir?`<a href="#" class="font-medium directory-link" data-path="${t}/${e.name}">${e.name}</a>`:e.name}
            </td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.size}</td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.mtime}</td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.owner}</td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.perms}</td>
            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">
                ${e.is_dir?`<i class="fas fa-edit text-yellow-600 dark:text-yellow-400 mr-2" title="Rename" data-file="${e.name}"></i>
                <i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${e.name}"></i>`:`<i class="fas fa-edit text-yellow-600 dark:text-yellow-400 mr-2" title="Rename" data-file="${e.name}"></i>
                      <i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${t+"/"+e.name}"></i>
                      <i class="fas fa-file-edit text-blue-600 dark:text-blue-400" title="View/Edit" data-file="${t+"/"+e.name}"></i>`}
            </td>
        </tr>
    `}function triggerAlert(e,t){document.dispatchEvent(new CustomEvent("show-alert",{detail:{type:e,message:t}}))}function encrypt(e,t){return CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(e),t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString()}function decrypt(e,t){return CryptoJS.AES.decrypt(e,t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}function renderFiles(e,t,r,a,i){let n=$("#searchBar").val().toLowerCase(),o=document.getElementById("fileList"),l=e.filter(e=>e.name.toLowerCase().includes(n));o.innerHTML=l.map(e=>createFileRow(e,t,r,a,i)).join("")}function appendFiles(e,t,r,a,i){let n=$("#searchBar").val().toLowerCase(),o=document.getElementById("fileList"),l=e.filter(e=>e.name.toLowerCase().includes(n)),s=l.map(e=>createFileRow(e,t,r,a,i)).join("");o.innerHTML+=s}function sortFiles(){let{column:e,direction:t}=fileManagerState.currentSort;fileManagerState.files.sort((r,a)=>{let i,n;switch(e){case"name":default:i=r.name.toLowerCase(),n=a.name.toLowerCase();break;case"size":i="dir"===r.size?-1:parseFloat(r.size),n="dir"===a.size?-1:parseFloat(a.size);break;case"mtime":i=new Date(r.mtime).getTime(),n=new Date(a.mtime).getTime();break;case"owner":i=r.owner.toLowerCase(),n=a.owner.toLowerCase();break;case"perms":i=r.perms,n=a.perms}return"asc"===t?i>n?1:-1:i<n?1:-1})}function updateSelectedFiles(e,t){t?fileManagerState.selectedFiles.push(e):fileManagerState.selectedFiles=fileManagerState.selectedFiles.filter(t=>t!==e),console.log("Selected Files:",fileManagerState.selectedFiles)}function performBulkAction(e,t,r,a,i,n,o=""){progr();let l=JSON.stringify({csrf:a,action:e,file:t,dir:r,zipExt:o}),s="1"===n?encrypt(l,i):l;$.post("",s,function(e){handleBulkActionResponse(e,n,i,r,a),resBulk(),dprogr()}).fail(function(){triggerAlert("warning","An error occurred while performing the bulk action."),dprogr()})}function handleBulkActionResponse(e,t,r,a,i){try{let n="1"===t?decrypt(e,r):e,o=JSON.parse(n);console.error("result:",t),o.error?triggerAlert("warning",o.error):(triggerAlert("success","Bulk action completed successfully!"),loadDirectory(a,1,i,r,t),fileManagerState.selectedFiles=[],document.getElementById("selectAll").checked=!1,resBulk()),freeclipbroad()}catch(l){triggerAlert("warning","Failed to parse server response."),freeclipbroad(),console.error("Error:"+l)}}function resBulk(){document.getElementById("bulkActions").value=""}function saveToLocalStorage(e){try{localStorage.setItem("copiedFiles",JSON.stringify(e)),console.log("File names saved to localStorage:",e)}catch(t){console.error("Failed to save file names to localStorage:",t),triggerAlert("warning","Failed to save file names to local storage.")}}function getFromLocalStorage(){try{let e=JSON.parse(localStorage.getItem("copiedFiles"));return console.log("File names retrieved from localStorage:",e),e||[]}catch(t){return console.error("Failed to retrieve file names from localStorage:",t),triggerAlert("warning","Failed to retrieve file names from local storage."),[]}}function freeclipbroad(){localStorage.getItem("copiedFiles"),localStorage.removeItem("copiedFiles")}function handleCreate(e,t,r,a,i,n){if(!["file","folder"].includes(t)){triggerAlert("warning","Invalid type. Only file or folder are allowed");return}sendRequest(e,r,a).then(()=>{loadDirectory(i,1,n,r,a)}).catch(e=>{triggerAlert("warning",e)})}function viewEditFile(e,t,r,a){sendRequest({csrf:t,action:"view_content",file:e},r,a).then(i=>{showEditDialog(e,i.content,t,r,a)}).catch(e=>{triggerAlert("warning",e)})}function showEditDialog(e,t,r,a,i){let n=document.documentElement.classList.contains("dark");Swal.fire({title:"Edit File Content",html:`
            <textarea id="fileContent" class="w-full h-64 p-2 border rounded ${n?"bg-gray-800 text-white border-gray-700":"bg-white text-gray-900 border-gray-300"}">${t}</textarea>
        `,showCancelButton:!0,confirmButtonText:"Save",cancelButtonText:"Cancel",customClass:{popup:n?"bg-gray-900 text-white":"bg-white text-gray-900",confirmButton:n?"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded":"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",cancelButton:n?"bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded":"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded",input:n?"bg-gray-800 text-white border-gray-700":"bg-white text-gray-900 border-gray-300"},didOpen(){document.getElementById("fileContent").focus()}}).then(t=>{if(t.isConfirmed){let n=document.getElementById("fileContent").value;saveFileContent(e,n,r,a,i)}})}function saveFileContent(e,t,r,a,i){sendRequest({csrf:r,action:"save_content",file:e,content:t},a,i).then(()=>{triggerAlert("success","File content saved successfully!")}).catch(e=>{triggerAlert("warning",e)})}
