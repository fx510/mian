document.addEventListener("DOMContentLoaded",function(){console.log("DOM fully loaded and parsed");let e=phpVars.csrf,t=phpVars.currentDir,n=phpVars.isEnc,l=CryptoJS.enc.Utf8.parse(phpVars.encryptionKey),i=phpVars.currentDir,r;var a=phpVars.terPWD,c="",s=[],o=0,d=!1,u=0,f=0,h="",g=[],p="";let m=phpVars.cmList,b;console.log("CSRF Token:",e),console.log("Current Directory:",t),console.log("Is Encrypted:",n),initializeFileManager(e,t,n,l);let v=document.getElementById("selectAll");v&&v.addEventListener("change",function(e){let t=e.target.checked,n=document.querySelectorAll(".file-checkbox");n.forEach(e=>{e.checked=t,updateSelectedFiles(e.dataset.file,t)})});let y=document.getElementById("fileList");function k(){let e=Array.from(document.querySelectorAll(".file-checkbox:checked")).map(e=>e.dataset.file).filter(e=>"."!==e&&".."!==e);return localStorage.setItem("selectedFiles",JSON.stringify(e)),e}function E(){_(t)}function _(e){let t=$("#breadcrumbs ol"),n=e.split("/").filter(e=>""!==e),l="";l+=`
    <li class="inline-flex items-center">
        <a href="#" class="breadcrumb-link" data-path="/">
            /
        </a>
    </li>
`,n.forEach((e,t)=>{let i="/"+n.slice(0,t+1).join("/");l+=`
        <li class="inline-flex items-center">
            <i class="fas fa-chevron-right mx-2 text-gray-500"></i>
            <a href="#" class="breadcrumb-link" data-path="${i}">${e}</a>
        </li>
    `}),t.html(l)}y&&y.addEventListener("change",function(e){if(e.target.classList.contains("file-checkbox")){let t=e.target.checked;updateSelectedFiles(e.target.dataset.file,t);let n=document.querySelectorAll(".file-checkbox"),l=Array.from(n).every(e=>e.checked),i=Array.from(n).some(e=>e.checked);v&&(v.checked=l,v.indeterminate=!l&&i)}}),document.addEventListener("click",function(i){if(i.target.classList.contains("fa-trash-alt")){let r=i.target.dataset.file;deleteFile(r,e,t,l,n)}}),$(".fa-folder-plus").click(function(){showRenameDialog("Create Folder","Enter the name of new folder: ","mkdir","NewFolder",i=>{i&&handleCreate(data={csrf:e,action:"mkdir",dir:t,dirName:i},"folder",l,n,t,e)})}),$(".fa-file-circle-plus").click(function(){showRenameDialog("Create File","Enter the name of new File: ","touch","File",i=>{i&&handleCreate(data={csrf:e,action:"touch",dir:t,dirName:i},"file",l,n,t,e)})}),$("#searchBar").on("keyup",function(){renderFiles(fileManagerState.files,t,e,l,n)}),$(window).on("scroll",function(){$(window).scrollTop()+$(window).height()>=$(document).height()-100&&fileManagerState.currentPage<fileManagerState.totalPages&&!fileManagerState.isLoading&&(fileManagerState.currentPage++,loadDirectory(t,fileManagerState.currentPage,e,l,n))}),$("th[data-sort]").click(function(){let i=$(this).data("sort");fileManagerState.currentSort.column===i?fileManagerState.currentSort.direction="asc"===fileManagerState.currentSort.direction?"desc":"asc":(fileManagerState.currentSort.column=i,fileManagerState.currentSort.direction="asc"),sortFiles(),renderFiles(fileManagerState.files,t,e,l,n)}),$(document).on("click",".directory-link",function(i){i.preventDefault();let a=$(this).data("path");a&&a!==t&&(r=t=a,console.log(r),E(),loadDirectory(t,1,e,l,n))}),$("#breadcrumbs").on("dblclick",function(i){console.log("Double-click detected"),i.preventDefault();let r=$("#breadcrumbs ol"),a=t,c=$("<input>",{type:"text",value:a,class:"w-96 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"});console.log("originalPath"+a),r.html(`<li class="inline-flex items-center">${c.prop("outerHTML")}</li>`),r.find("input").focus(),r.find("input").on("blur",function(){let t=$(this).val().trim();t&&t!==a?(_(t),loadDirectory(t,1,e,l,n),console.log(`Updated breadcrumb path to: ${t}`)):(loadDirectory(t,1,e,l,n),_(a))}),r.find("input").on("keypress",function(e){13===e.which&&$(this).blur()})}),$("#goHome").click(function(){t=i,E(),loadDirectory(t,1,e,l,n)}),$(document).on("click",".breadcrumb-link",function(i){i.preventDefault();let a=$(this).data("path");a&&a!==t&&(t=a,E(),r=t,console.log(r),loadDirectory(t,1,e,l,n))}),$("#bulkActions").change(function(){let i=$(this).val();if(0===fileManagerState.selectedFiles.length&&"paste"!==i){triggerAlert("info","No files selected! Please select files to perform bulk actions."),resBulk();return}switch(i){case"delete":showConfirmation("Delete Files",`Are you sure you want to delete ${fileManagerState.selectedFiles.length} file(s)?`,"Delete",()=>{performBulkAction("delete",fileManagerState.selectedFiles,t,e,l,n)});break;case"zip":showRenameDialog("Create Zip Archive","Enter the name for the zip file: ","Create","archive.zip",i=>{i&&performBulkAction("zip",fileManagerState.selectedFiles,t,e,l,n,i)});break;case"unzip":showConfirmation("Extract archive","Don't select different archive types","Extract",()=>{performBulkAction("unzip",fileManagerState.selectedFiles,t,e,l,n)});break;case"copy":saveToLocalStorage(fileManagerState.selectedFiles),triggerAlert("success","Files have been copied to clipboard!");break;case"paste":let r=getFromLocalStorage();r&&r.length>0?performBulkAction("paste",r,t,e,l,n):triggerAlert("warning","No file names found in local storage."),resBulk(),freeclipbroad()}});let L=document.getElementById("dropZone"),w=document.getElementById("fileInput"),x=document.getElementById("uploadForm"),I=document.getElementById("uploadProgress"),B=document.getElementById("progressBar"),C=document.getElementById("progressText");if(L&&w&&x&&I&&B&&C){function F(e){e.preventDefault(),e.stopPropagation()}function D(i){I.classList.remove("hidden"),B.style.width="0%",C.textContent="Uploading...";let r=new FormData(x);r.append("updir",t),r.append("csrf",e),fetch("",{method:"POST",body:r}).then(e=>e.json()).then(i=>{i.success?(C.textContent="Upload complete!",setTimeout(()=>I.classList.add("hidden"),3e3),loadDirectory(t,1,e,l,n)):C.textContent=i.error||"Upload failed. Please try again."}).catch(e=>{C.textContent="Upload failed. Please try again.",console.error("Error:",e)})}["dragenter","dragover","dragleave","drop"].forEach(e=>{L.addEventListener(e,F,!1)}),["dragenter","dragover"].forEach(e=>{L.addEventListener(e,()=>L.classList.add("bg-blue-50","dark:bg-gray-600"),!1)}),["dragleave","drop"].forEach(e=>{L.addEventListener(e,()=>L.classList.remove("bg-blue-50","dark:bg-gray-600"),!1)}),L.addEventListener("drop",function e(n){let l=n.dataTransfer.files;l.length>0&&(w.files=l,D(r=t))},!1),w.addEventListener("change",D),L.addEventListener("click",()=>w.click())}function P(e){require.config({paths:{vs:"https://unpkg.com/monaco-editor@0.45.0/min/vs"}}),require(["vs/editor/editor.main"],function(){b=monaco.editor.create(document.getElementById("editorContainer"),{value:e,language:"plaintext",theme:document.documentElement.classList.contains("dark")?"vs-dark":"vs",automaticLayout:!0,lineNumbers:"on",minimap:{enabled:!1}})})}function S(e,t,n,l){sendRequest({csrf:t,action:"view_content",file:e},n,l).then(e=>{document.getElementById("editorModal").classList.remove("hidden"),P(e.content)}).catch(e=>{triggerAlert("warning",e)})}function S(e,t,n,l){sendRequest({csrf:t,action:"view_content",file:e},n,l).then(t=>{document.getElementById("editorModal").classList.remove("hidden"),document.getElementById("editorModal").dataset.filePath=e;let n=function e(t){let n=t.split(".").pop();switch(n){case"js":return"javascript";case"php":return"php";case"html":return"html";case"css":return"css";case"json":return"json";default:return"plaintext"}}(e);P(t.content,n)}).catch(e=>{triggerAlert("warning",e)})}function P(e,t="plaintext"){require.config({paths:{vs:"https://unpkg.com/monaco-editor@0.45.0/min/vs"}}),require(["vs/editor/editor.main"],function(){b=monaco.editor.create(document.getElementById("editorContainer"),{value:e,language:t,theme:document.documentElement.classList.contains("dark")?"vs-dark":"vs",automaticLayout:!0,lineNumbers:"on",minimap:{enabled:!1}})})}function j(){c="",o=0,u=0,f=0,p="",d=!1}function T(){$("line.current bl").remove(),$("line.current").removeClass("current")}function M(){$("terminal content").append('<line class="current"><path>'+a+"</path> <sp></sp> <t><bl></bl></t></line>")}function N(){let e=$("line.current t").html(),t=1==e.split(" ").length?"<cm>"+e+"</cm>":"<cm>"+e.split(" ")[0]+"</cm> <code>"+e.split(" ").slice(1).join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</code>";$("line.current t").html(t.replace("&lt;bl&gt;&lt;/bl&gt;","<bl></bl>"))}function A(e=""){""===e?e=c:u=0;let t=e.substr(0,e.length+u),n=e.substr(e.length+u);$("line.current t").html(t+"<bl></bl>"+n)}document.addEventListener("click",function(t){if(t.target.classList.contains("fa-file-edit")){let i=t.target.dataset.file;S(i,e,l,n)}}),document.getElementById("cancelEdit").addEventListener("click",function(){document.getElementById("editorModal").classList.add("hidden"),b&&b.dispose()}),document.getElementById("saveEdit").addEventListener("click",function(){let t=b.getValue(),i=document.getElementById("editorModal").dataset.filePath;(function e(t,n,l,i,r){if(!n){triggerAlert("warning","File content is empty.");return}sendRequest({csrf:l,action:"save_content",file:t,content:n},i,r).then(()=>{triggerAlert("success","File content saved successfully!"),document.getElementById("editorModal").classList.add("hidden"),b&&b.dispose()}).catch(e=>{triggerAlert("warning",e)})})(i,t,e,l,n)}),$(document).ready(function(){function e(e){var t,n="number"==typeof e.which?e.which:e.keyCode;let l,i,r;8===n||9===n||46===n?(e.preventDefault(),""!==c&&(8===n?(0!==f&&(f=0,c=p),l=c.substr(0,c.length+u),i=c.substr(c.length+u),c=l.substr(0,l.length-1)+i,A(),N()):46===n?(c=c.substr(0,c.length+u)+c.substr(c.length+u).substr(1),0!==u&&u++,A(),N()):9===n&&function e(){if(h!==c){if(h=c,g=[],1===c.split(" ").length)g=m.concat(Object.keys(O)).filter(function(e){return e.length>c.length&&e.substr(0,c.length).toLowerCase()==c.toLowerCase()}).reverse().sort(function(e,t){return t.length-e.length});else if(2===c.split(" ").length){let t=c.split(" ")[0],n=c.split(" ")[1];var l="";if("cd"===t||"cp"===t||"mv"===t||"cat"===t){switch(t){case"cd":case"cp":case"mv":l="ls -d "+n+"*/";break;case"cat":l="ls -p | grep -v /";break;default:l=""}$.ajax({type:"POST",async:!1,data:{command:l,path:a},cache:!1,success:function(e){g=(e=$.parseJSON(e)).result.split("<br>").filter(function(e){return 0!==e.length})}})}}}g.length&&g.length>Math.abs(f)?(f--,A(p=(2===c.split(" ").length?c.split(" ")[0]+" ":"")+g[g.length+f]),N()):(f=0,p="",A(),N())}())):e.ctrlKey&&67===n?(f=0,T(),M(),j()):13===n?(0!==f&&(f=0,c=p),c.toLowerCase().split(" ")[0]in O?O[c.toLowerCase().split(" ")[0]](c.split(" ").slice(1)):0!==c.length&&$.ajax({type:"POST",async:!1,data:{command:c,path:a},cache:!1,success:function(e){a=(e=$.parseJSON(e)).path,$("terminal content").append("<line><br>"+e.result+"</line>")}}),T(),(t=c).length>=2&&(0===s.length||s[s.length-1]!==t)&&(s[s.length]=t),M(),j(),$("terminal content").scrollTop($("terminal content").prop("scrollHeight"))):(35===n||36===n||37===n||39===n)&&""!==c?(e.preventDefault(),$("line.current bl").remove(),0!==f&&(f=0,c=p),35===n&&(u=0),36===n&&(u=-1*c.length),37===n&&c.length!==Math.abs(u)&&u--,39===n&&0!==u&&u++,A(),N()):(38===n||40===n)&&(""===c||d)?(e.preventDefault(),38===n&&s.length&&s.length>=-1*o+1?(o--,c=s[s.length+o],A(),N(),d=!0):40===n&&s.length&&s.length>=-1*o&&0!==o&&(c=0==++o?"":s[s.length+o],A(),N(),d=0!==o)):(32===n||222===n||220===n||n>=45&&n<=195&&!(n>=112&&n<=123)&&46!=n&&91!=n&&93!=n&&144!=n&&145!=n&&45!=n)&&(function e(t){if(o=0,d=!1,0!==f&&(f=0,c=p),"/"===c[c.length-1]&&"/"===t)return;let n;c=c.substr(0,c.length+u)+t+c.substr(c.length+u),A(),N()}(e.key),$("terminal content").scrollTop($("terminal content").prop("scrollHeight")))}function t(){$("#terminal").is(":visible")?($(document).on("keydown",e),console.log("Keydown listener attached")):($(document).off("keydown",e),console.log("Keydown listener removed"))}t(),$("[data-tabs-target]").on("click",function(){setTimeout(()=>{t()},100)})});var O={clear:function e(){$("terminal content").html("")},history:function e(t){var n=[];let l=t.length&&Number.isInteger(Number(t[0]))?Number(t[0]):0;if(0!=l&&l<=s.length)for(var i=s.length-l;i<s.length;i++)n[n.length]=i+1+" &nbsp;"+s[i];else s.forEach(function(e,t){n[n.length]=t+1+" &nbsp;"+e});$("terminal content").append("<line>"+n.join("<br>")+"</line>")}};E()});