function initializeFileManager(csrf,currentDir,isEnc,encryptionKey){const key=isEnc==='1' ?(encryptionKey):"null";document.addEventListener('click',function(event){if(event.target.classList.contains('fa-edit')){const oldName=event.target.dataset.file;renameFile(oldName,csrf,currentDir,key,isEnc);}});document.addEventListener('click',function(event){if(event.target.classList.contains('directory-link')){event.preventDefault();const newDir=event.target.dataset.path;if(newDir && newDir !==currentDir){currentDir=newDir;loadDirectory(currentDir,1,csrf,key,isEnc);}}});document.addEventListener('click',function(event){const td=event.target.closest('td');if(!td)return;if(event.target.tagName==='INPUT' || event.target.tagName==='A' || event.target.tagName==='BUTTON' || event.target.tagName==='I' || event.target.tagName==='TH'){return;}if(td.closest('thead')|| !td.closest('#fileList')){return;}const tr=td.closest('tr');if(!tr)return;const checkbox=tr.querySelector('.file-checkbox');if(!checkbox)return;checkbox.checked=!checkbox.checked;if(checkbox.dataset.file){updateSelectedFiles(checkbox.dataset.file,checkbox.checked);if(checkbox.checked){tr.classList.add('bg-blue-50','dark:bg-blue-900/20');}else{tr.classList.remove('bg-blue-50','dark:bg-blue-900/20');}}});loadDirectory(currentDir,1,csrf,key,isEnc);}function sendRequest(data,key,isEnc){if(!data.csrf){throw new Error('CSRF token is missing.');}const jsonData=JSON.stringify(data);const encryptedData=(isEnc==='1')? encrypt(jsonData,key):jsonData;return new Promise((resolve,reject)=>{$.post('',encryptedData).done(response=>{try{let decryptedResponse=isEnc==='1' ? decrypt(response,key):response;const result=JSON.parse(decryptedResponse);if(result.error){reject(new Error(result.error));}else{resolve(result);}}catch(error){console.error('Failed to parse response:',error);console.error('Raw response:',response);reject(new Error('Failed to parse server response. Check console for details.'));triggerAlert('warning',"Failed to parse server response");}}).fail((jqXHR,textStatus,errorThrown)=>{console.error('Network error:',textStatus,errorThrown);console.error('Status code:',jqXHR.status);console.error('Response text:',jqXHR.responseText);reject(new Error(`Network error:${textStatus}-${errorThrown || jqXHR.status}`));triggerAlert('warning',`Request failed:${textStatus}${errorThrown || ''}`);});});}function showDialog(title,inputLabel,confirmButtonText,oldName,onConfirm){const isDarkMode=document.documentElement.classList.contains('dark');Swal.fire({title:title,input:'text',inputLabel:inputLabel,inputValue:oldName,showCancelButton:true,confirmButtonText:confirmButtonText,cancelButtonText:'Cancel',customClass:{popup:isDarkMode ? 'bg-gray-900 text-white':'bg-white text-gray-900',confirmButton:isDarkMode ? 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded':'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded',cancelButton:isDarkMode ? 'bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded':'bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded',input:isDarkMode ? 'bg-gray-800 text-white border-gray-700':'bg-white text-gray-900 border-gray-300'},}).then((result)=>{if(result.isConfirmed){const newName=result.value.trim();onConfirm(newName);}});}function showConfirmation(title,text,confirmButtonText,onConfirm){const isDarkMode=document.documentElement.classList.contains('dark');Swal.fire({title:title,text:text,icon:'warning',showCancelButton:true,confirmButtonText:confirmButtonText,cancelButtonText:'Cancel',customClass:{popup:isDarkMode ? 'bg-gray-900 text-white':'bg-white text-gray-900',confirmButton:isDarkMode ? 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded':'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded',cancelButton:isDarkMode ? 'bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded':'bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded'}}).then((result)=>{if(result.isConfirmed){onConfirm();}});}function renameFile(oldName,csrf,currentDir,key,isEnc){showDialog('Rename File','Enter the new name for the file:','Rename',oldName,(newName)=>{if(newName && newName.trim()!==oldName){sendRequest({csrf,action:'rename',oldName,newName:newName.trim(),dir:currentDir},key,isEnc).then(()=>{triggerAlert('success','File renamed successfully!');loadDirectory(currentDir,1,csrf,key,isEnc);}).catch(error=>{triggerAlert('warning',error);console.error('Error renaming file:',error);});}});}function deleteFile(fileName,csrf,currentDir,key,isEnc){console.log("currentDir:"+currentDir);showConfirmation('Delete File',`Are you sure you want to delete tjis "${fileName}"?`,'Delete',()=>{sendRequest({csrf,action:'delete',file:fileName,dir:currentDir},key,isEnc).then(()=>{triggerAlert('success',`"${fileName}" has been deleted successfully!`);loadDirectory(currentDir,1,csrf,key,isEnc);}).catch(error=>{triggerAlert('warning',error);console.error('Error deleting file:',error);});});}function progr(){if(isLoading)return;isLoading=true;NProgress.start();}function dprogr(){NProgress.done();isLoading=false;}function loadDirectory(dir,page,csrf,key,isEnc,itemsPerPage){progr();if(!itemsPerPage){const defaultItemsPerPage=localStorage.getItem('default-items-per-page');itemsPerPage=defaultItemsPerPage ? parseInt(defaultItemsPerPage,10):50;}if(typeof itemsPerPage==='string'){if(itemsPerPage.toLowerCase()==='all'){}else{itemsPerPage=parseInt(itemsPerPage,10);}}if(itemsPerPage !=='all' &&(isNaN(itemsPerPage)|| itemsPerPage<=0)){itemsPerPage=50;}console.log(`Loading directory with ${itemsPerPage}items per page`);const data={csrf:csrf,action:'list',dir:dir,page:page,itemsPerPage:itemsPerPage};const jsonData=JSON.stringify(data);const encryptedData=isEnc==='1' ? encrypt(jsonData,key):jsonData;$.post('',encryptedData,function(response){handleDirectoryResponse(response,isEnc,key,dir,page,csrf);dprogr();}).fail(function(){triggerAlert('warning','An error occurred while loading the directory.');dprogr();});}function handleDirectoryResponse(response,isEnc,key,dir,page,csrf){try{let decryptedResponse=isEnc==='1' ? decrypt(response,key):response;const result=JSON.parse(decryptedResponse);if(!window.fileManagerState){window.fileManagerState={files:[],totalPages:1,currentPage:1,totalItems:0,itemsPerPage:50,currentSort:{column:'name',direction:'asc'},selectedFiles:[]};}if(result.error){triggerAlert('warning',result.error);}else{window.fileManagerState.files=result.files;window.fileManagerState.totalPages=result.totalPages;window.fileManagerState.currentPage=page;window.fileManagerState.currentDir=dir;window.fileManagerState.totalItems=result.totalItems || 0;const itemLimitElement=document.getElementById('itemLimit');window.fileManagerState.itemsPerPage=itemLimitElement ?(itemLimitElement.value==='all' ? 'all':parseInt(itemLimitElement.value,10)):50;if(typeof window.updateCurrentPath==='function'){window.updateCurrentPath(dir);}renderFiles(result.files,dir,csrf,key,isEnc);if(typeof window.updateBreadcrumbs==='function'){window.updateBreadcrumbs(dir);}if(typeof window.updateActiveTabPath==='function'){window.updateActiveTabPath(dir);if(typeof window.saveTabsToLocalStorage==='function'){window.saveTabsToLocalStorage();}}updateFileTableFooter();}}catch(error){triggerAlert('warning','Failed to parse server response.');console.error('Error parsing directory response:',error);}}function createFileRow(file,currentDir,csrf,key,isEnc){let iconColorClass='text-blue-600 dark:text-blue-400';let permsColor=file.wr ? 'text-green-600 dark:text-green-400':'text-red-600 dark:text-red-400';let permsTooltip=file.wr ? 'Writable':'Not writable';let permsIcon=file.wr ? '<i title="Writable"></i>':'<i title="Not writable"></i>';if(file.is_dir){iconColorClass='text-yellow-600 dark:text-yellow-400';}else if(file.name.endsWith('.php')|| file.name.endsWith('.py')|| file.name.endsWith('.js')){iconColorClass='text-green-600 dark:text-green-400';}else if(file.name.endsWith('.zip')|| file.name.endsWith('.tar')|| file.name.endsWith('.gz')){iconColorClass='text-amber-600 dark:text-amber-400';}const fullPath=`${currentDir}/${file.name}`;const checkboxId=`file-checkbox-${file.name.replace(/[^a-zA-Z0-9]/g,'_')}`;const isSelected=window.fileManagerState && window.fileManagerState.selectedFiles &&(window.fileManagerState.selectedFiles.includes(fullPath)|| window.fileManagerState.selectedFiles.includes(file.name));const checkedAttr=isSelected ? 'checked':'';const rowClass=isSelected ? 'border-b border-gray-200 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700 transition-colors duration-150 bg-blue-50 dark:bg-blue-900/20':'border-b border-gray-200 hover:bg-gray-100 dark:border-gray-700 dark:hover:bg-gray-700 transition-colors duration-150';return `<tr class="${rowClass}" data-file="${file.name}" data-full-path="${fullPath}"><td class="py-1 px-3 text-left"><input type="checkbox" id="${checkboxId}" class="file-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" data-file="${file.name}" data-full-path="${fullPath}" ${checkedAttr}/></td><td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300"><div class="flex items-center"><i class="fas ${file.icon}mr-2 ${iconColorClass}"></i>${file.is_dir ? `<a href="#" class="font-medium directory-link hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-150" data-path="${fullPath}">${file.name}</a>`:`<a href="#" class="font-medium file-link hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-150" data-file="${fullPath}">${file.name}</a>`}</div></td><td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${file.size}</td><td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${file.mtime}</td><td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${file.owner}</td><td class="py-3 px-6 text-left ${permsColor}" title="${permsTooltip}">${file.perms}${permsIcon}</td><td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300"><div class="flex space-x-2">${!file.is_dir ? `<button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150"><i class="fas fa-edit text-yellow-600 dark:text-yellow-400" title="Rename" data-file="${file.name}"></i></button><button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150"><i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${fullPath}"></i></button><button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150"><i class="fas fa-download text-green-600 dark:text-green-400" title="Download" data-file="${fullPath}"></i></button>`:`<button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150"><i class="fas fa-edit text-yellow-600 dark:text-yellow-400" title="Rename" data-file="${file.name}"></i></button><button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150"><i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${fullPath}"></i></button>`}</div></td></tr>`;}function triggerAlert(type,message){document.dispatchEvent(new CustomEvent('show-alert',{detail:{type:type,message:message}}));}function encrypt(message,key){return CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(message),key,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString();}function decrypt(encryptedMessage,key){return CryptoJS.AES.decrypt(encryptedMessage,key,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8);}function searchFiles(files,query){if(!files || !Array.isArray(files)){console.error('Invalid files array provided to searchFiles');return [];}if(!query || query.trim()===''){return files;}const normalizedQuery=query.toLowerCase().trim();return files.filter(file=>{if(!file)return false;return((file.name && file.name.toLowerCase().includes(normalizedQuery))||(file.owner && file.owner.toLowerCase().includes(normalizedQuery))||(file.perms && file.perms.toLowerCase().includes(normalizedQuery))||(file.size && file.size.toString().toLowerCase().includes(normalizedQuery))||(file.mtime && file.mtime.toLowerCase().includes(normalizedQuery)));});}function renderFiles(files,currentDir,csrf,key,isEnc){const searchBar=document.getElementById('searchBar')|| document.querySelector('#searchBar');const searchQuery=searchBar ? searchBar.value.toLowerCase().trim():'';console.log('Rendering files with search query:',searchQuery);console.log('Number of files before filtering:',files ? files.length:0);const fileList=document.getElementById('fileList');if(!fileList){console.error('File list element not found');return;}if(!files || files.length===0){fileList.innerHTML='<tr><td colspan="7" class="py-4 text-center text-gray-500">No files found</td></tr>';updateFileTableFooter();return;}const filteredFiles=searchFiles(files,searchQuery);console.log('Number of files after filtering:',filteredFiles.length);if(filteredFiles.length===0){fileList.innerHTML='<tr><td colspan="7" class="py-4 text-center text-gray-500">No matching files found</td></tr>';}else{fileList.innerHTML=filteredFiles.map(file=>createFileRow(file,currentDir,csrf,key,isEnc)).join('');}addCheckboxEventListeners();updateFileTableFooter();}function appendFiles(files,currentDir,csrf,key,isEnc){const searchBar=document.getElementById('searchBar')|| document.querySelector('#searchBar');const searchQuery=searchBar ? searchBar.value.toLowerCase().trim():'';console.log('Appending files with search query:',searchQuery);const fileList=document.getElementById('fileList');if(!fileList){console.error('File list element not found');return;}if(!files || files.length===0){return;}const filteredFiles=searchFiles(files,searchQuery);if(filteredFiles.length>0){const html=filteredFiles.map(file=>createFileRow(file,currentDir,csrf,key,isEnc)).join('');fileList.innerHTML+=html;addCheckboxEventListeners();}}function addCheckboxEventListeners(){console.log('Adding checkbox event listeners');const checkboxes=document.querySelectorAll('.file-checkbox');console.log('Found checkboxes:',checkboxes.length);if(!window.fileManagerState){window.fileManagerState={selectedFiles:[]};}if(!window.fileManagerState.selectedFiles){window.fileManagerState.selectedFiles=[];}console.log('Current selected files:',window.fileManagerState.selectedFiles);checkboxes.forEach(checkbox=>{checkbox.removeEventListener('change',checkboxChangeHandler);checkbox.addEventListener('change',checkboxChangeHandler);const fullPath=checkbox.dataset.fullPath || checkbox.dataset.file;if(window.fileManagerState.selectedFiles.includes(fullPath)){console.log(`Setting checkbox for ${fullPath}to checked based on fileManagerState`);checkbox.checked=true;const row=checkbox.closest('tr');if(row){row.classList.add('bg-blue-50','dark:bg-blue-900/20');}}else{checkbox.checked=false;const row=checkbox.closest('tr');if(row){row.classList.remove('bg-blue-50','dark:bg-blue-900/20');}}});updateSelectAllCheckbox();}function updateSelectAllCheckbox(){const selectAllCheckbox=document.getElementById('selectAll');if(!selectAllCheckbox)return;const fileCheckboxes=document.querySelectorAll('.file-checkbox');if(fileCheckboxes.length===0)return;const allChecked=Array.from(fileCheckboxes).every(checkbox=>checkbox.checked);const anyChecked=Array.from(fileCheckboxes).some(checkbox=>checkbox.checked);selectAllCheckbox.checked=allChecked;selectAllCheckbox.indeterminate=!allChecked && anyChecked;console.log('Updated selectAll checkbox:',allChecked ? 'all checked':(anyChecked ? 'some checked':'none checked'));}function checkboxChangeHandler(){const row=this.closest('tr');const fileName=this.dataset.file;const fullPath=this.dataset.fullPath || fileName;console.log('Checkbox changed:',fileName);console.log('Checkbox state:',this.checked ? 'checked':'unchecked');console.log('Full path:',fullPath);console.log('Selected files before update:',window.fileManagerState?.selectedFiles ? [...window.fileManagerState.selectedFiles]:[]);if(this.checked){row.classList.add('bg-blue-50','dark:bg-blue-900/20');updateSelectedFiles(fullPath,true,true);}else{row.classList.remove('bg-blue-50','dark:bg-blue-900/20');updateSelectedFiles(fullPath,false,true);}console.log('Selected files after update:',window.fileManagerState?.selectedFiles ? [...window.fileManagerState.selectedFiles]:[]);const checkedBoxes=document.querySelectorAll('.file-checkbox:checked');console.log('Total checked checkboxes:',checkedBoxes.length);updateSelectAllCheckbox();}function sortFiles(){if(!window.fileManagerState){window.fileManagerState={files:[],totalPages:1,currentPage:1,currentSort:{column:'name',direction:'asc'},selectedFiles:[]};return;}const{column,direction}=window.fileManagerState.currentSort;window.fileManagerState.files.sort((a,b)=>{let valueA,valueB;switch(column){case 'name':valueA=a.name.toLowerCase();valueB=b.name.toLowerCase();break;case 'size':valueA=a.size==='dir' ?-1:parseFloat(a.size);valueB=b.size==='dir' ?-1:parseFloat(b.size);break;case 'mtime':case 'modified':valueA=new Date(a.mtime).getTime();valueB=new Date(b.mtime).getTime();break;case 'owner':valueA=a.owner.toLowerCase();valueB=b.owner.toLowerCase();break;case 'perms':valueA=a.perms;valueB=b.perms;break;default:valueA=a.name.toLowerCase();valueB=b.name.toLowerCase();}if(direction==='asc'){return valueA>valueB ? 1:-1;}else{return valueA<valueB ? 1:-1;}});}window.sortFiles=sortFiles;function updateSelectedFiles(fileName,isChecked,isFullPath=false){console.log(`updateSelectedFiles called:${fileName},checked:${isChecked},isFullPath:${isFullPath}`);if(!window.fileManagerState){console.log('Initializing fileManagerState');window.fileManagerState={selectedFiles:[]};}if(!window.fileManagerState.selectedFiles){console.log('Initializing selectedFiles array');window.fileManagerState.selectedFiles=[];}let fullPath=fileName;if(!isFullPath){const checkbox=document.querySelector(`.file-checkbox[data-file="${fileName}"]`);console.log('Checkbox found:',checkbox ? 'yes':'no');if(checkbox && checkbox.dataset.fullPath){fullPath=checkbox.dataset.fullPath;console.log(`Using fullPath from checkbox:${fullPath}`);}else if(!fileName.includes('/')){const currentDir=window.fileManagerState.currentDir || '';if(currentDir){fullPath=`${currentDir}/${fileName}`;console.log(`Constructed fullPath:${fullPath}`);}}}else{console.log(`Using provided fullPath:${fullPath}`);}if(isChecked){if(!window.fileManagerState.selectedFiles.includes(fullPath)){console.log(`Adding to selectedFiles:${fullPath}`);window.fileManagerState.selectedFiles.push(fullPath);}else{console.log(`File already in selectedFiles:${fullPath}`);}}else{console.log(`Removing from selectedFiles:${fullPath}`);window.fileManagerState.selectedFiles=window.fileManagerState.selectedFiles.filter(file=>file !==fullPath);}console.log('Selected Files after update:',window.fileManagerState.selectedFiles);console.log('Selected Files count:',window.fileManagerState.selectedFiles.length);}function resBulk(){let bulkActionsDropdown=document.getElementById('bulkActions');if(bulkActionsDropdown){bulkActionsDropdown.value='';}}function freeclipbroad(){try{localStorage.removeItem('copiedFiles');console.log('Clipboard cleared');}catch(error){console.error('Failed to clear clipboard:',error);}}function handleCreate(data,type,key,isEnc,currentDir,csrf){if(!['file','folder'].includes(type)){triggerAlert("warning","Invalid type. Only file or folder are allowed");return;}sendRequest(data,key,isEnc).then(()=>{loadDirectory(currentDir,1,csrf,key,isEnc);}).catch(error=>{triggerAlert('warning',error);});}function downloadFile(filePath,csrf,key,isEnc){const data={csrf:csrf,action:'download',file:filePath};const jsonData=JSON.stringify(data);const encryptedData=isEnc==='1' ? encrypt(jsonData,key):jsonData;fetch('',{method:'POST',headers:{'Content-Type':'application/json'},body:encryptedData}).then(response=>{if(response.ok){return response.blob();}else{throw new Error('Failed to download file');}}).then(blob=>{const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filePath.split('/').pop();document.body.appendChild(a);a.click();window.URL.revokeObjectURL(url);document.body.removeChild(a);}).catch(error=>{console.error('Error downloading file:',error);triggerAlert('warning','Failed to download file. Please try again.');});}function viewEditFile(filePath,csrf,key,isEnc){progr();console.log('ViewEditFile called for:',filePath);try{const fileName=filePath.split('/').pop();if(typeof window.addNewTab==='function'){const newTabId=window.addNewTab(fileName,'editor');console.log('Created new tab with ID:',newTabId);let tabContent=document.getElementById(`${newTabId}-content`);if(!tabContent){console.log('Tab content element not found,creating it');const tabsContent=document.getElementById('tabs-content');if(!tabsContent){console.error('Tabs content container not found!');dprogr();triggerAlert('warning','Failed to create editor tab. Please try again.');return;}tabContent=document.createElement('div');tabContent.id=`${newTabId}-content`;tabContent.className='tabs-panel w-full';tabsContent.appendChild(tabContent);}tabContent.dataset.filePath=filePath;const editorContainer=document.createElement('div');editorContainer.className='editor-container';editorContainer.style.width='100%';editorContainer.style.height='90vh';editorContainer.style.border='1px solid #ddd';editorContainer.style.position='relative';tabContent.innerHTML='';tabContent.appendChild(editorContainer);if(typeof window.switchToTab==='function'){window.switchToTab(newTabId);}document.querySelectorAll('.tabs-panel').forEach(panel=>{panel.classList.add('hidden');});tabContent.classList.remove('hidden');sendRequest({csrf,action:'view_content',file:filePath},key,isEnc).then(response=>{console.log('File content fetched successfully,initializing editor');if(typeof window.CodeMirror !=='undefined'){const language=getLanguageFromFileName(filePath);const editor=CodeMirror(editorContainer,{value:response.content || '',mode:language,theme:document.documentElement.classList.contains('dark')? 'dracula':'eclipse',lineNumbers:true,lineWrapping:true,matchBrackets:true,autoCloseBrackets:true,styleActiveLine:true});window.editor=editor;editor.setSize('100%','100%');let saveBtn=tabContent.querySelector('.save-file-btn');if(!saveBtn){saveBtn=document.createElement('button');saveBtn.className='save-file-btn fixed bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded shadow-lg z-50';saveBtn.innerHTML='<i class="fas fa-save mr-2"></i>Save';saveBtn.addEventListener('click',()=>{const content=editor.getValue();saveFileContent(filePath,content,csrf,key,isEnc);});tabContent.appendChild(saveBtn);}setTimeout(()=>{if(editor){editor.refresh();editor.focus();}},100);}else{console.error('CodeMirror not found');editorContainer.innerHTML=`<pre style="white-space:pre-wrap;padding:1rem;">${response.content}</pre>`;triggerAlert('warning','CodeMirror editor not found. Displaying content in plain text mode.');}dprogr();}).catch(error=>{console.error('Error in viewEditFile:',error);dprogr();triggerAlert('warning',typeof error==='string' ? error:'Failed to load file content');});}else{console.warn('addNewTab function not found,using current tab');triggerAlert('warning','Unable to open file in a new tab. Please try again.');dprogr();}}catch(error){console.error('Exception in viewEditFile:',error);dprogr();triggerAlert('warning','An unexpected error occurred while opening the editor');}}function saveFileContent(filePath,content,csrf,key,isEnc){progr();const data={csrf:csrf,action:'save_content',file:filePath,content:content};sendRequest(data,key,isEnc).then(()=>{triggerAlert('success','File content saved successfully!');}).catch(error=>{triggerAlert('warning',error);dprogr});dprogr();}let contextMenuTarget=null;let currentContextMenuType=null;function initContextMenu(options={}){if(!document.getElementById('context-menu')){createContextMenuElement();}const contextMenu=document.getElementById('context-menu');document.getElementById('file').addEventListener('contextmenu',handleContextMenu);document.addEventListener('click',hideContextMenu);window.addEventListener('blur',hideContextMenu);window.addEventListener('resize',hideContextMenu);document.addEventListener('scroll',hideContextMenu,true);addMenuItemEventListeners();console.log('Context menu initialized');}function createContextMenuElement(){const contextMenu=document.createElement('div');contextMenu.id='context-menu';contextMenu.className='hidden absolute z-50 min-w-[200px] bg-white dark:bg-gray-800 shadow-lg rounded-md py-2 border border-gray-200 dark:border-gray-700';contextMenu.innerHTML=`<div class="context-menu-group file-operations hidden"><button class="context-menu-item" data-action="rename"><i class="fas fa-signature mr-2"></i>Rename</button><button class="context-menu-item" data-action="download"><i class="fas fa-download mr-2"></i>Download</button></div><div class="context-menu-group folder-operations hidden"><button class="context-menu-item" data-action="open-folder"><i class="fas fa-folder-open mr-2"></i>Open</button><button class="context-menu-item" data-action="open-folder-new-tab"><i class="fas fa-external-link-alt mr-2"></i>Open in New Tab</button><button class="context-menu-item" data-action="rename-folder"><i class="fas fa-signature mr-2"></i>Rename</button></div><div class="context-menu-group clipboard-operations"><button class="context-menu-item" data-action="copy"><i class="fas fa-copy mr-2"></i>Copy</button><button class="context-menu-item" data-action="cut"><i class="fas fa-cut mr-2"></i>Cut</button><button class="context-menu-item paste-option hidden" data-action="paste"><i class="fas fa-paste mr-2"></i>Paste</button></div><div class="context-menu-divider border-t border-gray-200 dark:border-gray-700 my-1"></div><div class="context-menu-group danger-operations"><button class="context-menu-item text-red-600 dark:text-red-400" data-action="delete"><i class="fas fa-trash-alt mr-2"></i>Delete</button></div><div class="context-menu-group bg-operations hidden"><div class="context-menu-divider border-t border-gray-200 dark:border-gray-700 my-1"></div><button class="context-menu-item" data-action="new-file"><i class="fas fa-file-circle-plus mr-2"></i>New File</button><button class="context-menu-item" data-action="new-folder"><i class="fas fa-folder-plus mr-2"></i>New Folder</button><button class="context-menu-item" data-action="refresh"><i class="fas fa-sync-alt mr-2"></i>Refresh</button></div>`;const style=document.createElement('style');style.textContent=` .context-menu-item{display:flex;align-items:center;width:100%;text-align:left;padding:0.5rem 1rem;font-size:0.875rem;white-space:nowrap;color:#374151;transition:background-color 0.15s ease;}.dark .context-menu-item{color:#e5e7eb;}.context-menu-item:hover{background-color:rgba(59,130,246,0.1);}.dark .context-menu-item:hover{background-color:rgba(96,165,250,0.1);}.context-menu-item:focus{outline:none;background-color:rgba(59,130,246,0.15);}.dark .context-menu-item:focus{background-color:rgba(96,165,250,0.15);}.context-menu-item i{color:#4b5563;}.dark .context-menu-item i{color:#d1d5db;}.context-menu-item.text-red-600 i{color:#dc2626;}.dark .context-menu-item.text-red-400 i{color:#f87171;}@keyframes contextMenuFadeIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}#context-menu{transform-origin:top left;animation:contextMenuFadeIn 0.1s ease-out forwards;box-shadow:0 4px 6px-1px rgba(0,0,0,0.1),0 2px 4px-1px rgba(0,0,0,0.06);}.dark #context-menu{box-shadow:0 4px 6px-1px rgba(0,0,0,0.3),0 2px 4px-1px rgba(0,0,0,0.18);}`;document.head.appendChild(style);document.body.appendChild(contextMenu);}function handleContextMenu(e){e.preventDefault();const contextMenu=document.getElementById('context-menu');if(!contextMenu)return;hideAllMenuGroups();setContextMenuTarget(e);updateMenuVisibility();updatePasteOption();positionContextMenu(e.clientX,e.clientY);contextMenu.classList.remove('hidden');}function setContextMenuTarget(e){let target=e.target;if(target.closest('tr')){const row=target.closest('tr');const checkbox=row.querySelector('.file-checkbox');if(checkbox && checkbox.dataset.file){contextMenuTarget=checkbox.dataset.file;const isDir=row.querySelector('.directory-link')!==null;currentContextMenuType=isDir ? 'folder':'file';if(document.querySelectorAll('.file-checkbox:checked').length>1 && checkbox.checked){currentContextMenuType='multiple';}return;}}contextMenuTarget=document.getElementById('fileList');currentContextMenuType='background';}function updateMenuVisibility(){const contextMenu=document.getElementById('context-menu');if(!contextMenu)return;hideAllMenuGroups();if(currentContextMenuType==='file'){contextMenu.querySelector('.file-operations').classList.remove('hidden');contextMenu.querySelector('.clipboard-operations').classList.remove('hidden');}else if(currentContextMenuType==='folder'){contextMenu.querySelector('.folder-operations').classList.remove('hidden');contextMenu.querySelector('.clipboard-operations').classList.remove('hidden');}else if(currentContextMenuType==='multiple'){contextMenu.querySelector('.clipboard-operations').classList.remove('hidden');}else if(currentContextMenuType==='background'){contextMenu.querySelector('.bg-operations').classList.remove('hidden');contextMenu.querySelector('.paste-option').classList.remove('hidden');}}function hideAllMenuGroups(){const contextMenu=document.getElementById('context-menu');if(!contextMenu)return;const groups=contextMenu.querySelectorAll('.context-menu-group');groups.forEach(group=>group.classList.add('hidden'));}function updatePasteOption(){const pasteOption=document.querySelector('.paste-option');if(!pasteOption)return;const hasClipboardItems=localStorage.getItem('copiedFiles')!==null;if(hasClipboardItems){pasteOption.classList.remove('hidden');}else{pasteOption.classList.add('hidden');}}function positionContextMenu(x,y){const contextMenu=document.getElementById('context-menu');if(!contextMenu)return;const viewportWidth=window.innerWidth;const viewportHeight=window.innerHeight;contextMenu.style.visibility='hidden';contextMenu.classList.remove('hidden');const menuWidth=contextMenu.offsetWidth;const menuHeight=contextMenu.offsetHeight;let menuX=x;let menuY=y;if(x+menuWidth>viewportWidth){menuX=viewportWidth-menuWidth-5;}if(y+menuHeight>viewportHeight){menuY=viewportHeight-menuHeight-5;}contextMenu.style.left=`${menuX}px`;contextMenu.style.top=`${menuY}px`;contextMenu.style.visibility='visible';}function hideContextMenu(){const contextMenu=document.getElementById('context-menu');if(contextMenu){contextMenu.classList.add('hidden');}contextMenuTarget=null;}function addMenuItemEventListeners(){const contextMenu=document.getElementById('context-menu');if(!contextMenu)return;const menuItems=contextMenu.querySelectorAll('.context-menu-item');menuItems.forEach(item=>{item.addEventListener('click',(e)=>{e.stopPropagation();const action=item.dataset.action;handleMenuAction(action);hideContextMenu();});});}function handleMenuAction(action){const currentDir=window.fileManagerState?.currentDir || phpVars?.currentDir;const csrf=phpVars?.csrf;const key=phpVars?.encryptionKey ? CryptoJS.enc.Utf8.parse(phpVars.encryptionKey):null;const isEnc=phpVars?.isEnc;const joinPaths=(base,path)=>{if(base.endsWith('/')){return base+path;}else{return base+'/'+path;}};switch(action){case 'open-folder':if(contextMenuTarget){const newDir=joinPaths(currentDir,contextMenuTarget);window.currentDir=newDir;window.updateCurrentPath();loadDirectory(newDir,1,csrf,key,isEnc);window.updateActiveTabPath(newDir);}break;case 'open-folder-new-tab':if(contextMenuTarget){const newDir=joinPaths(currentDir,contextMenuTarget);if(typeof window.addNewTab==='function'){const newTabId=window.addNewTab(contextMenuTarget);loadDirectory(newDir,1,csrf,key,isEnc);window.updateActiveTabPath(newDir);}else{console.warn('addNewTab function not found,using current tab');window.currentDir=newDir;window.updateCurrentPath();loadDirectory(newDir,1,csrf,key,isEnc);window.updateActiveTabPath(newDir);}}break;case 'rename':case 'rename-folder':if(contextMenuTarget){renameFile(contextMenuTarget,csrf,currentDir,key,isEnc);}break;case 'download':if(contextMenuTarget){downloadFile(joinPaths(currentDir,contextMenuTarget),csrf,key,isEnc);}break;case 'copy':if(currentContextMenuType==='multiple'){const selectedFiles=Array.from(document.querySelectorAll('.file-checkbox:checked')).map(checkbox=>{const fileName=checkbox.dataset.file;return joinPaths(currentDir,fileName);});saveToLocalStorage(selectedFiles);}else if(contextMenuTarget){saveToLocalStorage([joinPaths(currentDir,contextMenuTarget)]);}triggerAlert('success','Item(s)copied to clipboard');break;case 'cut':if(currentContextMenuType==='multiple'){const selectedFiles=Array.from(document.querySelectorAll('.file-checkbox:checked')).map(checkbox=>{const fileName=checkbox.dataset.file;return joinPaths(currentDir,fileName);});saveToLocalStorage(selectedFiles);localStorage.setItem('clipboard-action','cut');}else if(contextMenuTarget){saveToLocalStorage([joinPaths(currentDir,contextMenuTarget)]);localStorage.setItem('clipboard-action','cut');}triggerAlert('info','Item(s)ready to move');break;case 'paste':const files=getFromLocalStorage();if(files && files.length>0){console.log('Attempting to paste files:',files);console.log('Current directory:',currentDir);triggerAlert('info',`Pasting ${files.length}item(s)...`);performBulkAction('paste',files,currentDir,csrf,key,isEnc);freeclipbroad();localStorage.removeItem('clipboard-action');}else{triggerAlert('warning','No items in clipboard');}break;case 'delete':if(currentContextMenuType==='multiple'){const selectedFiles=Array.from(document.querySelectorAll('.file-checkbox:checked')).map(checkbox=>checkbox.dataset.file);showConfirmation('Delete Files',`Are you sure you want to delete ${selectedFiles.length}file(s)?`,'Delete',()=>{performBulkAction('delete',selectedFiles,currentDir,csrf,key,isEnc);});}else if(contextMenuTarget){deleteFile(contextMenuTarget,csrf,currentDir,key,isEnc);}break;case 'new-file':showDialog('Create File','Enter the name of new File:','touch','File',(fileName)=>{if(fileName){const data={csrf:csrf,action:'touch',dir:currentDir,dirName:fileName};handleCreate(data,'file',key,isEnc,currentDir,csrf);}});break;case 'new-folder':showDialog('Create Folder','Enter the name of new folder:','mkdir','NewFolder',(dirName)=>{if(dirName){const data={csrf:csrf,action:'mkdir',dir:currentDir,dirName:dirName};handleCreate(data,'folder',key,isEnc,currentDir,csrf);}});break;case 'refresh':loadDirectory(currentDir,1,csrf,key,isEnc);break;}}window.initContextMenu=initContextMenu;function getLanguageFromFileName(fileName){if(!fileName)return 'plaintext';const extension=fileName.split('.').pop().toLowerCase();const modeMap={'js':'javascript','mjs':'javascript','cjs':'javascript','jsx':'javascript','ts':'javascript','tsx':'javascript','html':'htmlmixed','htm':'htmlmixed','css':'css','scss':'css','less':'css','json':'javascript','xml':'xml','svg':'xml','php':'php','py':'python','rb':'ruby','java':'clike','c':'clike','cpp':'clike','cs':'clike','h':'clike','hpp':'clike','sh':'shell','bash':'shell','zsh':'shell','fish':'shell','conf':'shell','ini':'shell','yaml':'yaml','yml':'yaml','md':'markdown','markdown':'markdown','sql':'sql','txt':'plaintext','log':'plaintext'};return modeMap[extension] || 'plaintext';}window.renderFiles=renderFiles;function diagnoseFileSorting(){console.log("---File Sorting Diagnostics---");console.log("window.fileManagerState exists:",window.fileManagerState ? "Yes":"No");if(window.fileManagerState){console.log("fileManagerState contents:",window.fileManagerState);}console.log("sortFiles function exists:",typeof window.sortFiles==='function' ? "Yes":"No");console.log("renderFiles function exists:",typeof window.renderFiles==='function' ? "Yes":"No");console.log("createFileRow function exists:",typeof window.createFileRow==='function' ? "Yes":"No");const headers=document.querySelectorAll('th[data-sort]');console.log("Table headers with data-sort attributes:",headers.length);headers.forEach(header=>{console.log(`Header:${header.textContent.trim()},data-sort:${header.dataset.sort}`);});return{fileManagerState:window.fileManagerState ? "Available":"Missing",sortFiles:typeof window.sortFiles==='function' ? "Available":"Missing",renderFiles:typeof window.renderFiles==='function' ? "Available":"Missing",createFileRow:typeof window.createFileRow==='function' ? "Available":"Missing",headers:Array.from(headers).map(h=>({text:h.textContent.trim(),sort:h.dataset.sort}))};}function debounce(func,wait=300){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}function diagnoseSearch(){console.log("---Search Functionality Diagnostics---");const searchBar=document.getElementById('searchBar')|| document.querySelector('#searchBar');console.log("Search bar found:",searchBar ? "Yes":"No");if(searchBar){console.log("Search value:",searchBar.value);}const clearButton=document.getElementById('clearSearch');console.log("Clear button found:",clearButton ? "Yes":"No");if(clearButton){console.log("Clear button visible:",clearButton.style.display !=='none');}console.log("fileManagerState exists:",window.fileManagerState ? "Yes":"No");if(window.fileManagerState){console.log("Number of files in state:",window.fileManagerState.files ? window.fileManagerState.files.length:0);}console.log("searchFiles function exists:",typeof window.searchFiles==='function' ? "Yes":"No");if(typeof window.searchFiles==='function' && window.fileManagerState && window.fileManagerState.files){const testQuery="test";const results=window.searchFiles(window.fileManagerState.files,testQuery);console.log(`Test search for "${testQuery}" returned ${results.length}results`);}return{searchBarFound:searchBar ? true:false,searchValue:searchBar ? searchBar.value:null,clearButtonFound:clearButton ? true:false,clearButtonVisible:clearButton ? clearButton.style.display !=='none':false,fileManagerStateExists:window.fileManagerState ? true:false,fileCount:window.fileManagerState && window.fileManagerState.files ? window.fileManagerState.files.length:0,searchFunctionExists:typeof window.searchFiles==='function'};}function updateFileTableFooter(){const table=document.querySelector('.overflow-x-auto table');if(!table)return;const state=window.fileManagerState ||{};const totalItems=state.totalItems || 0;const currentPage=state.currentPage || 1;const itemsPerPage=state.itemsPerPage || 50;const filesCount=state.files ? state.files.length:0;const startItem=totalItems===0 ? 0:(itemsPerPage==='all' ? 1:(currentPage-1)*itemsPerPage+1);const endItem=itemsPerPage==='all' ? totalItems:Math.min(startItem+filesCount-1,totalItems);let tfoot=table.querySelector('tfoot');if(tfoot){tfoot.remove();}tfoot=document.createElement('tfoot');tfoot.className='bg-gray-50 dark:bg-gray-700 text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700';tfoot.innerHTML=`<tr><td colspan="7" class="py-3 px-6"><div class="flex justify-between items-center"><div><span class="font-medium">Showing:</span><span class="text-blue-600 dark:text-blue-400 font-medium">${endItem}</span>of<span class="text-blue-600 dark:text-blue-400 font-medium">${totalItems}</span>items</div></div></td></tr>`;table.appendChild(tfoot);const oldFooter=document.getElementById('fileTableFooter');if(oldFooter){oldFooter.remove();}}function exposeGlobalFunctions(){window.sortFiles=sortFiles;window.renderFiles=renderFiles;window.createFileRow=createFileRow;window.updateSelectedFiles=updateSelectedFiles;window.addCheckboxEventListeners=addCheckboxEventListeners;window.loadDirectory=loadDirectory;window.handleDirectoryResponse=handleDirectoryResponse;window.triggerAlert=triggerAlert;window.diagnoseFileSorting=diagnoseFileSorting;window.searchFiles=searchFiles;window.debounce=debounce;window.diagnoseSearch=diagnoseSearch;window.updateFileTableFooter=updateFileTableFooter;console.log('Utility functions exposed globally');}exposeGlobalFunctions();
