function initThemeToggle(){const e=document.getElementById("theme-toggle");"dark"===localStorage.getItem("color-theme")||!localStorage.getItem("color-theme")&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),e.addEventListener("click",(function(){document.documentElement.classList.toggle("dark"),document.documentElement.classList.contains("dark")?localStorage.setItem("color-theme","dark"):localStorage.setItem("color-theme","light"),window.editor&&window.editor.updateOptions({theme:document.documentElement.classList.contains("dark")?"vs-dark":"vs"})}))}function initEnhancedTabs(){const e=[];function t(t){const n=document.querySelector(`#${t}`),r=`#${t.replace("-tab","")}`,a=document.querySelector(r);n&&a&&e.push({id:t,triggerEl:n,targetEl:a})}if(t("file-tab"),t("upload-tab"),t("terminal-tab"),t("config-tab"),t("setting-tab"),0===e.length)return;const n={defaultTabId:"file-tab",activeClasses:"text-blue-600 border-blue-600 dark:text-blue-500 dark:border-blue-500",inactiveClasses:"text-gray-500 hover:text-gray-600 dark:text-gray-400 border-transparent hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-300 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600",onShow:e=>{const t=e.triggerEl.getAttribute("data-tabs-target");setTimeout((()=>{const e=document.querySelector(".mb-4.border-b.border-gray-200.dark\\:border-gray-700"),n=document.getElementById("breadcrumbs");e&&n&&("#terminal"===t||"#config"===t||"#setting"===t?(e.classList.add("hidden"),n.classList.add("hidden")):(e.classList.remove("hidden"),n.classList.remove("hidden")))}),50)}};try{if(void 0!==window.Tabs){new Tabs(e,n).show("file-tab")}else if(void 0!==window.flowbite&&window.flowbite.Tabs){new window.flowbite.Tabs(e,n).show("file-tab")}else{const e=document.querySelectorAll("#default-tab button"),t=document.querySelectorAll("#default-tab-content > div");if(e.length>0&&t.length>0){const t=e[0].getAttribute("data-tabs-target"),n=document.querySelector(t);n&&(n.classList.remove("hidden"),e[0].classList.add("text-blue-600","border-blue-600"),e[0].classList.remove("border-transparent"),e[0].setAttribute("aria-selected","true"))}e.forEach((n=>{n.addEventListener("click",(()=>{const r=n.getAttribute("data-tabs-target");if("function"==typeof handleTabSwitch)handleTabSwitch(r);else{const a=document.querySelector(r);t.forEach((e=>{e.classList.add("hidden"),e.classList.remove("animate-fadeIn")})),e.forEach((e=>{e.classList.remove("text-blue-600","border-blue-600"),e.classList.add("border-transparent"),e.setAttribute("aria-selected","false")})),n.classList.add("text-blue-600","border-blue-600"),n.classList.remove("border-transparent"),n.setAttribute("aria-selected","true"),a.classList.remove("hidden"),a.classList.add("animate-fadeIn");const o=document.querySelector(".mb-4.border-b.border-gray-200.dark\\:border-gray-700"),i=document.getElementById("breadcrumbs");o&&i&&("#terminal"===r||"#config"===r||"#setting"===r?(o.classList.add("hidden"),i.classList.add("hidden")):(o.classList.remove("hidden"),i.classList.remove("hidden")))}}))}))}}catch(e){}setTimeout((()=>{const e=document.querySelector('[role="tab"][aria-selected="true"]');if(e){const t=e.getAttribute("data-tabs-target"),n=document.querySelector(".mb-4.border-b.border-gray-200.dark\\:border-gray-700"),r=document.getElementById("breadcrumbs");n&&r&&("#terminal"===t||"#config"===t||"#setting"===t?(n.classList.add("hidden"),r.classList.add("hidden")):(n.classList.remove("hidden"),r.classList.remove("hidden")))}}),200)}function initSettings(){loadSettings(),document.getElementById("light-theme-btn")?.addEventListener("click",(()=>{document.documentElement.classList.remove("dark"),localStorage.setItem("color-theme","light"),updateEditorTheme("vs")})),document.getElementById("dark-theme-btn")?.addEventListener("click",(()=>{document.documentElement.classList.add("dark"),localStorage.setItem("color-theme","dark"),updateEditorTheme("vs-dark")})),document.getElementById("system-theme-btn")?.addEventListener("click",(()=>{localStorage.removeItem("color-theme"),window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.add("dark"),updateEditorTheme("vs-dark")):(document.documentElement.classList.remove("dark"),updateEditorTheme("vs"))}));const e=document.getElementById("font-size");e&&e.addEventListener("input",(e=>{const t=e.target.value;document.documentElement.style.fontSize=t+"px",localStorage.setItem("font-size",t)}));const t=document.getElementById("terminal-font-size");t&&t.addEventListener("input",(e=>{const t=e.target.value,n=document.querySelector("terminal content");n&&(n.style.fontSize=t+"px"),localStorage.setItem("terminal-font-size",t)}));const n=document.getElementById("editor-theme");n&&n.addEventListener("change",(e=>{const t=e.target.value;"system"===t?(updateEditorTheme(window.matchMedia("(prefers-color-scheme: dark)").matches?"vs-dark":"vs"),localStorage.setItem("editor-theme","system")):(updateEditorTheme(t),localStorage.setItem("editor-theme",t))}));const r=document.getElementById("tab-size");r&&r.addEventListener("change",(e=>{const t=e.target.value;window.editor&&window.editor.setOption("tabSize",parseInt(t)),localStorage.setItem("tab-size",t)}));const a=document.getElementById("word-wrap");a&&a.addEventListener("change",(e=>{const t=e.target.checked?"on":"off";window.editor&&window.editor.setOption("lineWrapping","on"===t),localStorage.setItem("word-wrap",t)}));const o=document.getElementById("default-items");o&&o.addEventListener("change",(e=>{const t=e.target.value;localStorage.setItem("default-items-per-page",t);const n=document.getElementById("itemLimit");if(n){n.value=t;const e=new Event("change");n.dispatchEvent(e)}})),document.getElementById("save-settings")?.addEventListener("click",(()=>{saveSettings(),triggerAlert("success","Settings saved successfully!")}))}function loadSettings(){const e=localStorage.getItem("font-size")||"14";document.documentElement.style.fontSize=e+"px";const t=document.getElementById("font-size");t&&(t.value=e);const n=localStorage.getItem("terminal-font-size")||"14",r=document.querySelector("terminal content");r&&(r.style.fontSize=n+"px");const a=document.getElementById("terminal-font-size");a&&(a.value=n);const o=localStorage.getItem("editor-theme")||"system",i=document.getElementById("editor-theme");i&&(i.value=o);const s=localStorage.getItem("tab-size")||"4",c=document.getElementById("tab-size");c&&(c.value=s);const l=localStorage.getItem("word-wrap")||"on",d=document.getElementById("word-wrap");d&&(d.checked="on"===l);const u=localStorage.getItem("default-items-per-page")||"50",g=document.getElementById("default-items");g&&(g.value=u);const m=document.getElementById("itemLimit");m&&u&&(m.value=u)}function saveSettings(){const e=document.getElementById("font-size");e&&localStorage.setItem("font-size",e.value);const t=document.getElementById("terminal-font-size");t&&localStorage.setItem("terminal-font-size",t.value);const n=document.getElementById("editor-theme");n&&localStorage.setItem("editor-theme",n.value);const r=document.getElementById("tab-size");r&&localStorage.setItem("tab-size",r.value);const a=document.getElementById("word-wrap");a&&localStorage.setItem("word-wrap",a.checked?"on":"off");const o=document.getElementById("default-items");o&&localStorage.setItem("default-items-per-page",o.value)}function updateEditorTheme(e){window.editorThemePreference=e;let t="eclipse";if(("vs-dark"===e||"system"===e&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&(t="dracula"),window.editor&&"function"==typeof window.editor.setOption)try{window.editor.setOption("theme",t);const e=document.getElementById("editorContainer");e&&("dracula"===t?(e.classList.add("dark-editor"),e.classList.remove("light-editor")):(e.classList.add("light-editor"),e.classList.remove("dark-editor")));const n=document.getElementById("editorStatus");n&&("dracula"===t?(n.classList.add("dark-status"),n.classList.remove("light-status")):(n.classList.add("light-status"),n.classList.remove("dark-status")))}catch(e){}}function initGlobalKeyboardShortcuts(){const e=[{key:"Delete",action:"Delete selected files"},{key:"Ctrl+A",action:"Select all files"},{key:"Ctrl+C",action:"Copy selected files"},{key:"Ctrl+X",action:"Cut selected files"},{key:"Ctrl+V",action:"Paste files"},{key:"Ctrl+F",action:"Search files (when implemented)"},{key:"F2",action:"Rename selected file"},{key:"F5",action:"Refresh directory"},{key:"Alt+Up",action:"Navigate to parent directory"},{key:"Escape",action:"Deselect all files / Close dialogs"},{key:"?",action:"Show this help dialog"}];function t(){let t='<div class="overflow-x-auto"><table class="w-full text-sm text-left">';t+='<thead class="text-xs uppercase bg-gray-100 dark:bg-gray-700"><tr><th class="px-6 py-3">Key</th><th class="px-6 py-3">Action</th></tr></thead><tbody>',e.forEach((e=>{t+=`<tr class="border-b dark:border-gray-700"><td class="px-6 py-4 font-medium">${e.key}</td><td class="px-6 py-4">${e.action}</td></tr>`})),t+="</tbody></table></div>",Swal.fire({title:"Keyboard Shortcuts",html:t,customClass:{popup:"dark:bg-gray-800 dark:text-white"}})}const n=document.getElementById("keyboardShortcutsBtn");n&&n.addEventListener("click",t),document.addEventListener("keydown",(function(e){if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.classList.contains("CodeMirror")||document.querySelector("#terminal:not(.hidden)"))return;if(!window.fileManagerState)return;const n=window.fileManagerState?.currentDir||phpVars?.currentDir,r=phpVars?.csrf,a=phpVars?.encryptionKey?CryptoJS.enc.Utf8.parse(phpVars.encryptionKey):null,o=phpVars?.isEnc;window.fileManagerState.selectedFiles||(window.fileManagerState.selectedFiles=[]);const i=window.fileManagerState.selectedFiles||[];switch(!0){case"Delete"===e.key:if(i.length>0){if(e.preventDefault(),"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.isContentEditable)return;const t=[...i];window.showConfirmation("Delete Files",`Are you sure you want to delete ${t.length} file(s)?`,"Delete",(()=>{"function"==typeof window.sendBulkActionRequest?window.sendBulkActionRequest({action:"delete",files:t,onSuccess:()=>{"function"==typeof window.clearFileSelection&&window.clearFileSelection(),window.triggerAlert("success","Files deleted successfully"),window.loadDirectory(n,1,r,a,o)}}):window.performBulkAction("delete",t,n,r,a,o)}))}break;case e.ctrlKey&&"a"===e.key:e.preventDefault();const s=document.querySelectorAll(".file-checkbox"),c=document.getElementById("selectAll");s.forEach((e=>{e.checked=!0,window.updateSelectedFiles(e.dataset.file,!0)})),c&&(c.checked=!0),window.triggerAlert("info",`Selected ${s.length} file(s)`);break;case e.ctrlKey&&"c"===e.key:if(i.length>0){if(e.preventDefault(),"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.isContentEditable)return;const t=i.map((e=>e.includes("/")?e:`${n}/${e}`));"function"==typeof window.saveToLocalStorage?(window.saveToLocalStorage(t),localStorage.removeItem("clipboard-action"),window.triggerAlert("success",`Copied ${i.length} file(s) to clipboard`)):window.triggerAlert("warning","Copy operation failed")}break;case e.ctrlKey&&"x"===e.key:if(i.length>0){if(e.preventDefault(),"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.isContentEditable)return;const t=i.map((e=>e.includes("/")?e:`${n}/${e}`));"function"==typeof window.saveToLocalStorage?(window.saveToLocalStorage(t),localStorage.setItem("clipboard-action","cut"),window.triggerAlert("info",`Cut ${i.length} file(s) to clipboard`)):window.triggerAlert("warning","Cut operation failed")}break;case e.ctrlKey&&"v"===e.key:if("INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||document.activeElement.isContentEditable)return;if(e.preventDefault(),"function"==typeof window.getFromLocalStorage){const e=window.getFromLocalStorage();e&&e.length>0?(window.triggerAlert("info",`Pasting ${e.length} item(s)...`),"function"==typeof window.sendBulkActionRequest?window.sendBulkActionRequest({action:"paste",files:e,onSuccess:()=>{"function"==typeof window.clearFileSelection&&window.clearFileSelection(),window.triggerAlert("success","Files pasted successfully"),window.loadDirectory(n,1,r,a,o),"cut"===localStorage.getItem("clipboard-action")&&("function"==typeof window.freeclipbroad&&window.freeclipbroad(),localStorage.removeItem("clipboard-action"))}}):(window.performBulkAction("paste",e,n,r,a,o),"cut"===localStorage.getItem("clipboard-action")&&("function"==typeof window.freeclipbroad&&window.freeclipbroad(),localStorage.removeItem("clipboard-action")))):window.triggerAlert("warning","No items in clipboard")}else window.triggerAlert("warning","Paste operation failed");break;case"F2"===e.key:1===i.length?(e.preventDefault(),window.renameFile(i[0],r,n,a,o)):i.length>1&&window.triggerAlert("warning","Please select only one file to rename");break;case"F5"===e.key:e.preventDefault(),window.loadDirectory(n,1,r,a,o),window.triggerAlert("info","Refreshing directory...");break;case e.altKey&&"ArrowUp"===e.key:e.preventDefault();const l=document.querySelector(".breadcrumb-item:nth-last-child(2) a");l&&l.click();break;case"Escape"===e.key:const d=document.querySelector(".modal:not(.hidden)"),u=document.querySelector("#context-menu:not(.hidden)");if(d||u)return;e.preventDefault(),document.querySelectorAll(".file-checkbox").forEach((e=>{e.checked=!1}));const g=document.getElementById("selectAll");g&&(g.checked=!1),window.fileManagerState.selectedFiles=[],window.triggerAlert("info","Deselected all files");break;case"?"===e.key:e.preventDefault(),t();break}}))}function exposeUtilityFunctions(){window.updateSelectedFiles="function"==typeof updateSelectedFiles?updateSelectedFiles:function(){},window.showAdvancedSearch=function(){if(!window.phpVars)return void triggerAlert("danger","Required configuration is missing. Please refresh the page and try again.");const e=addNewTab("Advanced Search","search");switchToTab(e);const t=document.getElementById(`${e}-content`);if(!t)return;t.innerHTML="";const n=document.createElement("div");n.className="search-form bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4",n.innerHTML=`\n            <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Advanced Search</h2>\n            <form id="advanced-search-form" class="space-y-4" onsubmit="event.preventDefault(); performAdvancedSearch(); return false;">\n                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">\n                    <div>\n                        <label for="search-query" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search Query</label>\n                        <input type="text" id="search-query" name="search-query" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Enter search text or pattern" required>\n                    </div>\n                    <div>\n                        <label for="search-path" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search Path</label>\n                        <input type="text" id="search-path" name="search-path" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Directory path" value="${window.fileManagerState?.currentDir||"."}">\n                    </div>\n                </div>\n                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">\n                    <div>\n                        <label for="file-extensions" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">File Extensions</label>\n                        <input type="text" id="file-extensions" name="file-extensions" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g. php,js,html,css">\n                    </div>\n                    <div>\n                        <label for="max-results" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Max Results</label>\n                        <input type="number" id="max-results" name="max-results" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="1000" min="10" max="10000">\n                    </div>\n                    <div>\n                        <label for="batch-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batch Size</label>\n                        <input type="number" id="batch-size" name="batch-size" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="200" min="50" max="1000" title="Number of files to process per batch">\n                    </div>\n                    <div class="flex flex-col space-y-2">\n                        <div class="flex items-center">\n                            <input type="checkbox" id="case-sensitive" name="case-sensitive" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">\n                            <label for="case-sensitive" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Case Sensitive</label>\n                        </div>\n                        <div class="flex items-center">\n                            <input type="checkbox" id="use-regex" name="use-regex" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">\n                            <label for="use-regex" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Use Regex</label>\n                        </div>\n                        <div class="flex items-center">\n                            <input type="checkbox" id="recursive-search" name="recursive-search" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>\n                            <label for="recursive-search" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Recursive</label>\n                        </div>\n                        <div class="flex items-center">\n                            <input type="checkbox" id="writable-only" name="writable-only" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">\n                            <label for="writable-only" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Writable Files Only</label>\n                        </div>\n                    </div>\n                </div>\n                <div class="flex justify-end">\n                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">\n                        <svg class="mr-2 -ml-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />\n                        </svg>\n                        Search\n                    </button>\n                </div>\n            </form>\n        `;const r=document.createElement("div");r.id="search-results-container",r.className="search-results bg-white dark:bg-gray-800 p-4 rounded-lg shadow",r.innerHTML='\n            <div class="flex justify-between items-center mb-4">\n                <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Search Results</h2>\n                <div id="search-stats" class="text-sm text-gray-500 dark:text-gray-400"></div>\n            </div>\n            <div id="search-results" class="space-y-4">\n                <div class="text-gray-500 dark:text-gray-400 text-center py-8">Enter a search query and click Search</div>\n            </div>\n        ',t.appendChild(n),t.appendChild(r);const a=document.getElementById("advanced-search-form");a&&a.addEventListener("submit",(function(e){return e.preventDefault(),performAdvancedSearch(),!1}))},window.performAdvancedSearch=function(e=null){const t=document.getElementById("search-query")?.value,n=document.getElementById("search-path")?.value||".",r=document.getElementById("file-extensions")?.value||"",a=document.getElementById("max-results")?.value||1e3,o=document.getElementById("case-sensitive")?.checked||!1,i=document.getElementById("use-regex")?.checked||!1,s=document.getElementById("recursive-search")?.checked||!0,c=document.getElementById("writable-only")?.checked||!1,l=parseInt(document.getElementById("batch-size")?.value||"200",10);if(!t&&!e)return void triggerAlert("warning","Please enter a search query");if(!e){const e=(d=n)&&""!==d.trim()?(d.startsWith("/"),{valid:!0}):{valid:!1,message:"Search path cannot be empty"};if(!e.valid)return void triggerAlert("warning",e.message)}var d;const u=window.phpVars?.csrf||"",g=window.phpVars?.encryptionKey||"",m=window.phpVars?.isEnc||!1;if(!u)return void triggerAlert("danger","Security token missing. Please refresh the page and try again.");const f=document.getElementById("search-results");if(f&&!e?(f.innerHTML='\n                <div class="flex justify-center items-center py-8">\n                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>\n                    <span class="ml-2 text-gray-600 dark:text-gray-300">Searching...</span>\n                </div>\n            ',window.currentSearch={query:t,path:n,extensions:r,maxResults:a,caseSensitive:o,useRegex:i,recursive:s,writableOnly:c,results:{},totalMatches:0}):e||(window.currentSearch={query:t,path:n,extensions:r,maxResults:a,caseSensitive:o,useRegex:i,recursive:s,writableOnly:c,results:{},totalMatches:0}),e){const e=document.getElementById("search-progress");e&&(e.innerHTML='\n                    <div class="flex items-center">\n                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>\n                        <span>Continuing search...</span>\n                    </div>\n                ')}sendRequest({csrf:u,action:"advanced_search",search_query:t,search_path:n,file_extensions:r,max_results:a,case_sensitive:o,use_regex:i,recursive:s,writable_only:c,search_token:e,batch_size:l},g,m).then((t=>{displaySearchResults(t,null!==e)})).catch((e=>{f&&(f.innerHTML=`\n                    <div class="text-red-500 dark:text-red-400 text-center py-4">\n                        Error: ${e.message||"Failed to perform search"}\n                    </div>\n                    <div class="mt-4 p-4 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-800 rounded-md">\n                        <h3 class="font-medium text-red-800 dark:text-red-300 mb-2">Troubleshooting tips:</h3>\n                        <ul class="list-disc pl-5 text-sm text-red-700 dark:text-red-400 space-y-1">\n                            <li>Check if the search path exists and is accessible</li>\n                            <li>Try using a relative path like "./subdirectory" instead of an absolute path</li>\n                            <li>If using regex, verify your pattern is valid</li>\n                            <li>Try reducing the batch size if searching many files</li>\n                            <li>Check browser console for more detailed error information</li>\n                        </ul>\n                    </div>\n                `),triggerAlert("danger","Search failed: "+(e.message||"Unknown error"))}))},window.displaySearchResults=function(e,t=!1){const n=document.getElementById("search-results"),r=document.getElementById("search-stats");if(!n)return;if(e.error)return void(n.innerHTML=`\n                <div class="text-red-500 dark:text-red-400 text-center py-4">\n                    Error: ${e.error}\n                </div>\n            `);if(t&&window.currentSearch?(Object.assign(window.currentSearch.results,e.results),window.currentSearch.totalMatches=e.total_matches):(window.currentSearch||(window.currentSearch={}),window.currentSearch.results=e.results,window.currentSearch.totalMatches=e.total_matches),r&&(r.textContent=`Found ${window.currentSearch.totalMatches} matches in ${Object.keys(window.currentSearch.results).length} files`,e.memory_limit_reached&&(r.innerHTML+='\n                    <div class="mt-2 text-amber-600 dark:text-amber-400">\n                        <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>\n                        </svg>\n                        Search was truncated due to memory limits. Try narrowing your search or searching in smaller directories.\n                    </div>\n                '),!e.search_complete)){const t=e.files_remaining||0,n=e.files_processed||0,a=n+t,o=a>0?Math.round(n/a*100):0;r.innerHTML+=`\n                    <div id="search-progress" class="mt-2">\n                        <div class="flex items-center justify-between mb-1">\n                            <span class="text-sm text-gray-700 dark:text-gray-300">\n                                Processed ${n} of ${a} files (${o}%)\n                            </span>\n                        </div>\n                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">\n                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${o}%"></div>\n                        </div>\n                        <div class="flex justify-between mt-2">\n                            <div class="flex items-center">\n                                <input type="checkbox" id="auto-continue-search" class="mr-2">\n                                <label for="auto-continue-search" class="text-sm text-gray-700 dark:text-gray-300">Auto-continue</label>\n                            </div>\n                            <button id="continue-search" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700">\n                                Continue Search\n                            </button>\n                        </div>\n                    </div>\n                `}if(0===window.currentSearch.totalMatches&&e.search_complete)return void(n.innerHTML=`\n                <div class="text-gray-500 dark:text-gray-400 text-center py-8">\n                    No results found for "${e.search_query}"\n                </div>\n            `);let a="";if(Object.keys(window.currentSearch.results).sort(((e,t)=>window.currentSearch.results[t].length-window.currentSearch.results[e].length)).forEach((t=>{const n=window.currentSearch.results[t],r=t.split("/").pop(),o=e.writable_files&&e.writable_files.includes(t)?'<span class="ml-2 px-2 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 rounded">Writable</span>':'<span class="ml-2 px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 rounded">No Writable</span>';a+=`\n                <div class="file-result border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden mb-4">\n                    <div class="file-header bg-gray-100 dark:bg-gray-700 px-4 py-2 flex justify-between items-center">\n                        <div class="flex items-center">\n                            <span class="font-medium text-gray-800 dark:text-white">${r}</span>\n                            <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">${n.length} matches</span>\n                            ${o}\n                        </div>\n                        <div class="flex space-x-2">\n                            <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm" \n                                    onclick="viewEditFile('${t}', '${window.phpVars?.csrf||""}', '${window.phpVars?.encryptionKey||""}', ${window.phpVars?.isEnc||!1})">\n                                Edit\n                            </button>\n                            <button class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300 text-sm toggle-matches" \n                                    data-file="${t}">\n                                Hide Matches\n                            </button>\n                        </div>\n                    </div>\n                    <div class="file-matches bg-white dark:bg-gray-800 p-2">\n                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">${t}</div>\n                        <div class="matches-list space-y-1">\n            `,n.forEach((e=>{const n=e.line_content.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");let r=n;if(!document.getElementById("use-regex")?.checked){const e=document.getElementById("search-query")?.value||"";if(e){const t=document.getElementById("case-sensitive")?.checked?"g":"gi",a=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),t);r=n.replace(a,'<mark class="bg-yellow-200 dark:bg-yellow-700">$&</mark>')}}a+=`\n                    <div class="match-line hover:bg-gray-50 dark:hover:bg-gray-700 p-1 rounded">\n                        <a href="#" class="flex" onclick="viewEditFileAtLine('${t}', ${e.line_number}, '${window.phpVars?.csrf||""}', '${window.phpVars?.encryptionKey||""}', ${window.phpVars?.isEnc||!1}); return false;">\n                            <span class="line-number w-12 inline-block text-right pr-2 text-gray-500 dark:text-gray-400 select-none">${e.line_number}</span>\n                            <span class="line-content font-mono text-gray-800 dark:text-gray-200 overflow-x-auto">${r}</span>\n                        </a>\n                    </div>\n                `})),a+="\n                        </div>\n                    </div>\n                </div>\n            "})),n.innerHTML=a,document.querySelectorAll(".toggle-matches").forEach((e=>{e.addEventListener("click",(function(){this.getAttribute("data-file");const e=this.closest(".file-result").querySelector(".matches-list");"none"===e.style.display?(e.style.display="block",this.textContent="Hide Matches"):(e.style.display="none",this.textContent="Show Matches")}))})),!e.search_complete){const t=document.getElementById("continue-search"),n=document.getElementById("auto-continue-search");if(t&&t.addEventListener("click",(function(){performAdvancedSearch(e.search_token)})),n){"true"===localStorage.getItem("search-auto-continue")&&(n.checked=!0),n.addEventListener("change",(function(){localStorage.setItem("search-auto-continue",this.checked)})),n.checked&&setTimeout((()=>{performAdvancedSearch(e.search_token)}),1e3)}}},window.viewEditFileAtLine=function(e,t,n,r,a){viewEditFile(e,n,r,a);let o=0;const i=function(){if(window.editor)try{window.editor.setCursor(t-1,0),window.editor.addLineClass(t-1,"background","bg-yellow-100"),window.editor.scrollIntoView({line:t-1,ch:0},100)}catch(e){triggerAlert("warning","Could not position to the selected line. Please try manually navigating to line "+t)}else o++,o<20?setTimeout(i,300):triggerAlert("warning","Could not position to the selected line. Please try manually navigating to line "+t)};setTimeout(i,800)},window.saveToLocalStorage=saveToLocalStorage,window.getFromLocalStorage=getFromLocalStorage,window.freeclipbroad="function"==typeof freeclipbroad?freeclipbroad:function(){},window.performBulkAction="function"==typeof performBulkAction?performBulkAction:function(){},window.sendBulkActionRequest=function({action:e,files:t,options:n=null,onSuccess:r=null,onError:a=null}){const o=window.fileManagerState?.currentDir||phpVars?.currentDir,i=phpVars?.csrf,s=phpVars?.encryptionKey?CryptoJS.enc.Utf8.parse(phpVars.encryptionKey):null,c=phpVars?.isEnc;"function"==typeof progr&&progr();const l={csrf:i,action:e,file:t,dir:o};"zip"===e&&n&&(l.zipExt=n.zipFileName,l.compressionLevel=n.compressionLevel||"5",l.archiveFormat=n.archiveFormat||"zip");const d=JSON.stringify(l),u="1"===c?encrypt(d,s):d;$.post("",u,(function(e){try{const t="1"===c?decrypt(e,s):e,n=JSON.parse(t);n.error?(triggerAlert("warning",n.error),a&&a(n.error)):n.success?r?r(n):triggerAlert("success",n.success):r?r(n):triggerAlert("success","Operation completed successfully")}catch(e){triggerAlert("error","Failed to process server response"),a&&a(e)}"function"==typeof dprogr&&dprogr()})).fail((function(e,t,n){triggerAlert("error","Request failed: "+(n||"Unknown error")),a&&a(n),"function"==typeof dprogr&&dprogr()}))},window.renameFile="function"==typeof renameFile?renameFile:function(){},window.loadDirectory="function"==typeof loadDirectory?loadDirectory:function(){},window.triggerAlert="function"==typeof triggerAlert?triggerAlert:function(){},window.showConfirmation="function"==typeof showConfirmation?showConfirmation:function(){},window.encrypt="function"==typeof encrypt?encrypt:function(){},window.decrypt="function"==typeof decrypt?decrypt:function(){},window.progr="function"==typeof progr?progr:function(){},window.dprogr="function"==typeof dprogr?dprogr:function(){}}function handleTabSwitch(e){const t=document.querySelector(`[data-tabs-target="${e}"]`),n=document.querySelector(e);if(!t||!n)return;document.querySelectorAll('[role="tab"]').forEach((e=>{e.setAttribute("aria-selected","false"),e.classList.remove("text-blue-600","border-blue-600"),e.classList.add("border-transparent")})),document.querySelectorAll('[role="tabpanel"]').forEach((e=>{e.classList.add("hidden")})),t.setAttribute("aria-selected","true"),t.classList.add("text-blue-600","border-blue-600"),t.classList.remove("border-transparent"),n.classList.remove("hidden"),n.classList.add("animate-fadeIn");const r=document.querySelector(".mb-4.border-b.border-gray-200.dark\\:border-gray-700"),a=document.getElementById("breadcrumbs");if(r&&a)if("#terminal"===e||"#config"===e||"#setting"===e||"#sql"===e||"#network"===e){r.classList.add("hidden"),a.classList.add("hidden");const e=document.getElementById("fileManagerUI");e&&(e.style.display="none"),document.querySelectorAll(".tabs-panel").forEach((e=>{e.classList.add("hidden")}))}else if(r.classList.remove("hidden"),a.classList.remove("hidden"),"#file"===e){const e=document.getElementById("fileManagerUI");e&&(e.style.display="block")}"function"==typeof window.updateKeydownListener&&setTimeout(window.updateKeydownListener,100)}function saveToLocalStorage(e){try{const t=e.map((e=>{if(e.startsWith("/")||e.includes(":/"))return e;const t=window.fileManagerState?.currentDir||phpVars?.currentDir;return t.endsWith("/")?t+e:t+"/"+e}));return localStorage.setItem("copiedFiles",JSON.stringify(t)),t}catch(e){return[]}}function getFromLocalStorage(){try{const e=localStorage.getItem("copiedFiles");if(!e)return[];return JSON.parse(e)}catch(e){return[]}}function initNetworkTools(){const e=document.getElementById("portScannerForm");e&&e.addEventListener("submit",(function(e){e.preventDefault(),performPortScan()}));const t=document.getElementById("getNetworkInfo");t&&t.addEventListener("click",(function(){getNetworkInfo()}));const n=document.getElementById("getArpTable");n&&n.addEventListener("click",(function(){getArpTable()}));const r=document.getElementById("pingForm");r&&r.addEventListener("submit",(function(e){e.preventDefault(),performPing()}));const a=document.getElementById("dnsLookupForm");a&&a.addEventListener("submit",(function(e){e.preventDefault(),performDnsLookup()}))}function performPortScan(){const e=document.getElementById("hostInput").value,t=parseInt(document.getElementById("startPortInput").value),n=parseInt(document.getElementById("endPortInput").value),r=parseInt(document.getElementById("timeoutInput").value),a=document.getElementById("commonPortsOnly").checked;if(!e)return void triggerAlert("warning","Please enter a host/IP address");const o=document.getElementById("portScanResults"),i=document.getElementById("scanStatus"),s=document.getElementById("portScanResultsBody");o.classList.remove("hidden"),i.textContent=`Scanning ${e}...`,s.innerHTML='<tr><td colspan="3" class="text-center py-2">Scanning...</td></tr>';sendNetworkRequest("port_scan",{host:e,start_port:t,end_port:n,timeout:r,common_ports_only:a}).then((e=>{if(e.error)return triggerAlert("warning",e.error),i.textContent=`Scan failed: ${e.error}`,void(s.innerHTML='<tr><td colspan="3" class="text-center py-2 text-red-500">Scan failed</td></tr>');i.textContent=`Scan completed for ${e.host}`,s.innerHTML="";const t=e.results.filter((e=>"open"===e.status)),n=e.results.filter((e=>"closed"===e.status));if(0===t.length)s.innerHTML='<tr><td colspan="3" class="text-center py-2">No open ports found</td></tr>';else if(t.forEach((e=>{const t=document.createElement("tr");t.innerHTML=`\n                            <td class="px-4 py-2">${e.port}</td>\n                            <td class="px-4 py-2"><span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">open</span></td>\n                            <td class="px-4 py-2">${e.service||"unknown"}</td>\n                        `,s.appendChild(t)})),n.length>0){const e=document.createElement("tr");e.innerHTML=`\n                            <td colspan="3" class="px-4 py-2 text-gray-500 italic">${n.length} port(s) closed or filtered</td>\n                        `,s.appendChild(e)}})).catch((e=>{triggerAlert("warning","Error performing port scan"),i.textContent="Scan failed",s.innerHTML='<tr><td colspan="3" class="text-center py-2 text-red-500">Error connecting to server</td></tr>'}))}function getNetworkInfo(){const e=document.getElementById("networkInfoResults");e.classList.remove("hidden"),e.innerHTML='<div class="text-center py-2">Loading network information...</div>',sendNetworkRequest("network_info",{}).then((t=>{if(t.error)return triggerAlert("warning",t.error),void(e.innerHTML=`<div class="text-center py-2 text-red-500">${t.error}</div>`);let n='<div class="space-y-4">';0===t.interfaces.length?n+='<div class="text-center py-2">No network interfaces found</div>':t.interfaces.forEach((e=>{n+=`\n                            <div class="border-b pb-3 dark:border-gray-600">\n                                <h4 class="font-medium text-gray-800 dark:text-gray-200">${e.name}</h4>\n                                <div class="mt-2">\n                        `,0===e.addresses.length?n+='<p class="text-sm text-gray-600 dark:text-gray-400">No addresses</p>':e.addresses.forEach((e=>{n+=`\n                                    <div class="flex flex-col text-sm">\n                                        <span class="text-gray-700 dark:text-gray-300">\n                                            <span class="font-medium">${e.family}:</span> ${e.address}\n                                        </span>\n                                        <span class="text-gray-600 dark:text-gray-400">\n                                            Netmask: ${e.netmask||"N/A"}\n                                        </span>\n                                    </div>\n                                `})),n+="</div></div>"})),n+="</div>",e.innerHTML=n})).catch((t=>{triggerAlert("warning","Error getting network information"),e.innerHTML='<div class="text-center py-2 text-red-500">Error connecting to server</div>'}))}function getArpTable(){const e=document.getElementById("arpTableResults");e.classList.remove("hidden"),e.innerHTML='<div class="text-center py-2">Loading ARP table...</div>',sendNetworkRequest("arp_table",{}).then((t=>{if(t.error)return triggerAlert("warning",t.error),void(e.innerHTML=`<div class="text-center py-2 text-red-500">${t.error}</div>`);if(0===t.arp_table.length)return void(e.innerHTML='<div class="text-center py-2">No ARP entries found</div>');let n='\n                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">\n                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 dark:bg-gray-800 dark:text-gray-400">\n                            <tr>\n                                <th scope="col" class="px-4 py-2">IP Address</th>\n                                <th scope="col" class="px-4 py-2">MAC Address</th>\n                                <th scope="col" class="px-4 py-2">Interface</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                ';t.arp_table.forEach((e=>{n+=`\n                        <tr>\n                            <td class="px-4 py-2">${e.ip}</td>\n                            <td class="px-4 py-2">${e.mac}</td>\n                            <td class="px-4 py-2">${e.interface}</td>\n                        </tr>\n                    `})),n+="</tbody></table>",e.innerHTML=n})).catch((t=>{triggerAlert("warning","Error getting ARP table"),e.innerHTML='<div class="text-center py-2 text-red-500">Error connecting to server</div>'}))}function performPing(){const e=document.getElementById("pingHost").value,t=parseInt(document.getElementById("pingCount").value),n=parseInt(document.getElementById("pingTimeout").value);if(!e)return void triggerAlert("warning","Please enter a host/IP address");const r=document.getElementById("pingResults"),a=r.querySelector("div");r.classList.remove("hidden"),a.innerHTML='<div class="text-center py-2">Pinging '+e+"...</div>";sendNetworkRequest("ping",{host:e,count:t,timeout:n}).then((e=>{if(e.error)return triggerAlert("warning",e.error),void(a.innerHTML=`<div class="text-center py-2 text-red-500">${e.error}</div>`);let t="";e.results.forEach((e=>{t+=e+"<br>"})),a.innerHTML=t})).catch((e=>{triggerAlert("warning","Error performing ping"),a.innerHTML='<div class="text-center py-2 text-red-500">Error connecting to server</div>'}))}function performDnsLookup(){const e=document.getElementById("dnsHost").value,t=document.getElementById("dnsType").value;if(!e)return void triggerAlert("warning","Please enter a domain name");const n=document.getElementById("dnsResults"),r=n.querySelector("div");n.classList.remove("hidden"),r.innerHTML='<div class="text-center py-2">Looking up '+e+"...</div>";sendNetworkRequest("dns_lookup",{host:e,type:t}).then((n=>{if(n.error)return triggerAlert("warning",n.error),void(r.innerHTML=`<div class="text-center py-2 text-red-500">${n.error}</div>`);if(0===n.results.length)return void(r.innerHTML=`<div class="text-center py-2">No ${t} records found for ${e}</div>`);let a='<div class="space-y-4">';n.results.forEach((e=>{a+=`\n                        <div class="border-b pb-3 dark:border-gray-600">\n                            <h4 class="font-medium text-gray-800 dark:text-gray-200">${e.type} Record</h4>\n                            <div class="mt-2 space-y-1">\n                    `;const t=e.data;for(const[e,n]of Object.entries(t))"type"!==e&&"class"!==e&&(a+=`\n                                <div class="text-sm">\n                                    <span class="font-medium text-gray-700 dark:text-gray-300">${e}:</span>\n                                    <span class="text-gray-600 dark:text-gray-400">${n}</span>\n                                </div>\n                            `);a+="</div></div>"})),a+="</div>",r.innerHTML=a})).catch((e=>{triggerAlert("warning","Error performing DNS lookup"),r.innerHTML='<div class="text-center py-2 text-red-500">Error connecting to server</div>'}))}function sendNetworkRequest(e,t){return new Promise(((n,r)=>{progr();const a={action:"network_tool",tool:e,params:t,csrf:phpVars.csrf},o=JSON.stringify(a),i="1"===phpVars.isEnc,s=i?encrypt(o,phpVars.encryptionKey):o;fetch("",{method:"POST",body:s}).then((e=>e.text())).then((e=>{try{dprogr();const t=i?decrypt(e,phpVars.encryptionKey):e,r=JSON.parse(t);n(r)}catch(e){dprogr(),r(e)}})).catch((e=>{dprogr(),r(e)}))}))}document.addEventListener("DOMContentLoaded",(function(){document.getElementById("sql-tab")?.addEventListener("click",(function(){"function"==typeof window.initSQLExplorer&&window.initSQLExplorer()})),"function"==typeof window.initContextMenu&&window.initContextMenu(),exposeUtilityFunctions(),initGlobalKeyboardShortcuts(),window.clearFileSelection=function(){window.fileManagerState&&(window.fileManagerState.selectedFiles=[]),document.querySelectorAll(".file-checkbox:checked").forEach((e=>{e.checked=!1}));let e=document.getElementById("selectAll");e&&(e.checked=!1,e.indeterminate=!1),document.querySelectorAll("#fileList tr.bg-blue-50, #fileList tr.dark\\:bg-blue-900\\/20").forEach((e=>{e.classList.remove("bg-blue-50","dark:bg-blue-900/20")}))};const e=phpVars.csrf;let t=phpVars.currentDir;const n=phpVars.isEnc,r=CryptoJS.enc.Utf8.parse(phpVars.encryptionKey),a=phpVars.currentDir;let o;var i=phpVars.terPWD,s="",c=[],l=0,d=!1,u=0,g=0,m="",f=[],p="";let h=phpVars.cmList;window.editorThemePreference=localStorage.getItem("editor-theme"),"system"===window.editorThemePreference&&(window.editorThemePreference=window.matchMedia("(prefers-color-scheme: dark)").matches?"vs-dark":"vs");function y(e,t,n,r="",a){Swal.fire({title:e,input:"text",inputLabel:t,inputValue:r,showCancelButton:!0,confirmButtonText:n,customClass:{popup:"dark:bg-gray-800 dark:text-white"},inputValidator:e=>{if(!e)return"You need to enter a value!"}}).then((e=>{e.isConfirmed&&a(e.value)}))}function b(e,t,n,r){Swal.fire({title:e,text:t,icon:"warning",showCancelButton:!0,confirmButtonText:n,cancelButtonText:"Cancel",customClass:{popup:"dark:bg-gray-800 dark:text-white"}}).then((e=>{e.isConfirmed&&r()}))}!function e(){void 0!==window.flowbite?(window.flowbite.initTabs&&window.flowbite.initTabs(),setTimeout((()=>{initEnhancedTabs()}),100)):setTimeout(e,50)}();const w=localStorage.getItem("default-items-per-page");if(w){const e=document.getElementById("itemLimit");e&&(e.value=w)}if(loadTabsFromLocalStorage()){const e=fileManagerState.tabs.find((e=>e.active));e&&(t=e.path)}initializeFileManager(e,t,n,r),E(),$(document).on("click","#location-tabs button",(function(a){if(a.target.classList.contains("fa-times"))return;const o=$(this).data("tab-id");if(!fileManagerState.tabs.find((e=>e.id===o)))return;document.querySelectorAll('[role="tabpanel"]').forEach((e=>{e.classList.add("hidden")})),document.querySelectorAll("[data-tabs-target]").forEach((e=>{const t=e.getAttribute("data-tabs-target");t&&document.querySelector(t)&&document.querySelector(t).classList.add("hidden")})),function(a){const o=fileManagerState.tabs.find((e=>e.id===a));if(!o)return;fileManagerState.tabs.forEach((e=>e.active=!1)),o.active=!0,fileManagerState.activeTabId=a,E(),saveTabsToLocalStorage(),document.querySelectorAll('[role="tabpanel"]').forEach((e=>{e.classList.add("hidden")}));let i=document.getElementById(`${a}-content`);if(!i){const e=document.getElementById("tabs-content");if(!e)return;i=document.createElement("div"),i.id=`${a}-content`,i.className="tabs-panel w-full",e.appendChild(i)}if(document.querySelectorAll(".tabs-panel").forEach((e=>{e.classList.add("hidden")})),i.classList.remove("hidden"),"editor"===o.type||"search"===o.type){const e=document.getElementById("fileManagerUI");e&&(e.style.display="none");const t=i.querySelector(".editor-container");t&&(t.style.height="90vh",t.style.width="100%",window.editor&&setTimeout((()=>window.editor.refresh()),10))}else{const a=document.getElementById("fileManagerUI"),i=document.getElementById("file");a&&(a.style.display="block",i&&i.classList.remove("hidden"),t=o.path,updateCurrentPath(),loadDirectory(t,1,e,r,n))}}(o);const i=document.createElement("span");i.className="absolute inset-0 bg-blue-500 opacity-30 rounded-t-lg animate-ripple",this.appendChild(i),setTimeout((()=>i.remove()),600)})),$(document).on("click","[data-close-tab]",(function(a){a.stopPropagation();const o=$(this).data("close-tab");$(this).closest("li").addClass("animate-tab-closing"),setTimeout((()=>{!function(a){if(fileManagerState.tabs.length<=1)return;const o=fileManagerState.tabs.findIndex((e=>e.id===a));if(-1===o)return;const i=fileManagerState.tabs[o].active;if(fileManagerState.tabs.splice(o,1),i){const a=Math.max(0,o-1);fileManagerState.tabs[a].active=!0,fileManagerState.activeTabId=fileManagerState.tabs[a].id,t=fileManagerState.tabs[a].path,updateCurrentPath(),loadDirectory(t,1,e,r,n)}E(),saveTabsToLocalStorage()}(o)}),150)})),$("#add-tab-btn").click((function(){I(),$(this).addClass("animate-pulse"),setTimeout((()=>{$(this).removeClass("animate-pulse")}),500)})),window.addEventListener("resize",function(e,t){let n;return function(...r){const a=()=>{clearTimeout(n),e(...r)};clearTimeout(n),n=setTimeout(a,t)}}(L,100)),initThemeToggle(),initSettings();const v=document.getElementById("selectAll");function x(e){const t=e.target.checked,n=document.querySelectorAll(".file-checkbox");window.fileManagerState||(window.fileManagerState={selectedFiles:[]}),window.fileManagerState.selectedFiles=[],n.forEach((e=>{if(e.checked=t,t){const t=e.dataset.fullPath||e.dataset.file;updateSelectedFiles(t,!0,!0);e.closest("tr").classList.add("bg-blue-50","dark:bg-blue-900/20")}else{e.closest("tr").classList.remove("bg-blue-50","dark:bg-blue-900/20")}}))}v&&(v.removeEventListener("change",x),v.addEventListener("change",x));const k=document.getElementById("fileList");function S(e){const t=$("#breadcrumbs ol"),n=e.split("/").filter((e=>""!==e));let r="";r+='\n            <li class="inline-flex items-center">\n                <a href="#" class="breadcrumb-link" data-path="/">\n                    /\n                </a>\n            </li>\n        ',n.forEach(((e,t)=>{const a="/"+n.slice(0,t+1).join("/");r+=`\n                <li class="inline-flex items-center">\n                    <i class="fas fa-chevron-right mx-2 text-gray-500"></i>\n                    <a href="#" class="breadcrumb-link" data-path="${a}">${e}</a>\n                </li>\n            `})),t.html(r)}function E(){const e=document.getElementById("location-tabs");if(!e)return;e.innerHTML="",fileManagerState.tabs.forEach((t=>{const n=document.createElement("li");n.className="mr-1 flex-shrink-0",n.setAttribute("role","presentation");const r=t.name||T(t.path);let a="fa-folder";"Root"!==r&&"Home"!==r||(a="fa-home");n.innerHTML=`\n                <button class="${t.active?"inline-flex items-center p-3 border-b-2 rounded-t-lg text-blue-600 border-blue-600 active dark:text-blue-500 dark:border-blue-500 bg-white dark:bg-gray-800 shadow-sm":"inline-flex items-center p-3 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 dark:hover:border-gray-300 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600"} transition-all duration-200 group" \n                        data-tab-id="${t.id}" \n                        type="button" \n                        role="tab">\n                    <i class="fas ${a} mr-2 ${t.active?"text-blue-500":"group-hover:text-blue-400"} transition-colors"></i>\n                    <span class="truncate max-w-[100px] md:max-w-[150px]">${r}</span>\n                    ${"tab-1"!==t.id?`\n                        <i class="fas fa-times ml-2 p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full text-xs opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all" data-close-tab="${t.id}"></i>\n                    `:""}\n                </button>\n            `,e.appendChild(n)}));const t=e.querySelector('button[data-tab-id="'+fileManagerState.activeTabId+'"]');t&&(t.classList.add("animate-pulse"),setTimeout((()=>{t.classList.remove("animate-pulse")}),500),requestAnimationFrame((()=>{const n=t.getBoundingClientRect(),r=e.getBoundingClientRect();n.left<r.left?e.scrollLeft+=n.left-r.left-16:n.right>r.right&&(e.scrollLeft+=n.right-r.right+16)}))),L()}function L(){const e=document.getElementById("location-tabs");if(!e)return;if(e.scrollWidth>e.clientWidth){if(e.classList.add("tabs-overflow"),!document.getElementById("tab-scroll-left")){const t=document.createElement("button");t.id="tab-scroll-left",t.className="absolute left-0 top-0 bottom-0 px-1 bg-gradient-to-r from-white to-transparent dark:from-gray-800 dark:to-transparent z-10 opacity-80 hover:opacity-100 transition-opacity",t.innerHTML='<i class="fas fa-chevron-left"></i>',t.addEventListener("click",(()=>{e.scrollBy({left:-150,behavior:"smooth"})}));const n=document.createElement("button");n.id="tab-scroll-right",n.className="absolute right-0 top-0 bottom-0 px-1 bg-gradient-to-l from-white to-transparent dark:from-gray-800 dark:to-transparent z-10 opacity-80 hover:opacity-100 transition-opacity",n.innerHTML='<i class="fas fa-chevron-right"></i>',n.addEventListener("click",(()=>{e.scrollBy({left:150,behavior:"smooth"})})),e.parentElement.appendChild(t),e.parentElement.appendChild(n)}}else e.classList.remove("tabs-overflow"),document.getElementById("tab-scroll-left")?.remove(),document.getElementById("tab-scroll-right")?.remove()}function I(e,t="filemanager"){return window.addNewTab(e,t)}function T(e){const t=e.endsWith("/")?e.slice(0,-1):e;if(""===t||"/"===t)return"Root";const n=t.split("/");return n[n.length-1]||"Root"}function A({action:a,files:o,options:i=null,onSuccess:s=null,onError:c=null}){progr();const l={csrf:e,action:a,file:o,dir:t};"zip"===a&&i&&(l.zipExt=i.zipFileName,l.compressionLevel=i.compressionLevel||"5",l.archiveFormat=i.archiveFormat||"zip");const d=JSON.stringify(l),u="1"===n?encrypt(d,r):d;$.post("",u,(function(e){try{const t="1"===n?decrypt(e,r):e,a=JSON.parse(t);a.error?(triggerAlert("warning",a.error),c&&c(a.error)):a.success?s?s(a):triggerAlert("success",a.success):s?s(a):triggerAlert("success","Operation completed successfully")}catch(e){triggerAlert("error","Failed to process server response"),c&&c(e)}dprogr()})).fail((function(e,t,n){triggerAlert("error","Request failed: "+(n||"Unknown error")),c&&c(n),dprogr()}))}k&&k.addEventListener("change",(function(e){if(e.target.classList.contains("file-checkbox")){const t=e.target.checked;updateSelectedFiles(e.target.dataset.file,t);const n=document.querySelectorAll(".file-checkbox"),r=Array.from(n).every((e=>e.checked)),a=Array.from(n).some((e=>e.checked));v&&(v.checked=r,v.indeterminate=!r&&a)}})),document.addEventListener("click",(function(a){if(a.target.classList.contains("fa-trash-alt")){const o=a.target.dataset.file;deleteFile(o,e,t,r,n)}})),$(".fa-folder-plus").click((function(){y("Create Folder","Enter the name of new folder: ","mkdir","NewFolder",(a=>{a&&(data={csrf:e,action:"mkdir",dir:t,dirName:a},handleCreate(data,"folder",r,n,t,e))}))})),$(".fa-file-circle-plus").click((function(){y("Create File","Enter the name of new File: ","touch","File",(a=>{a&&(data={csrf:e,action:"touch",dir:t,dirName:a},handleCreate(data,"file",r,n,t,e))}))})),$(".codeme").click((function(){y("Execute PHP Code","Enter the PHP code to execute:","Execute","",(a=>{a&&""!==a.trim()&&sendRequest({csrf:e,action:"execute",code:a.trim(),dir:t},r,n).then((e=>{e.output&&(triggerAlert("success","Code executed successfully"),Swal.fire({title:"Execution Result",html:`<pre class="text-left">${e.output}</pre>`,width:"80%",customClass:{popup:"dark:bg-gray-800 dark:text-white",htmlContainer:"overflow-auto max-h-[70vh]"}}))})).catch((e=>{triggerAlert("warning","Error executing code: "+e)}))}))})),$("#searchBar").on("keyup",(function(){$(this).val().toLowerCase().length>0?$("#clearSearch").show():$("#clearSearch").hide(),window.fileManagerState&&"function"==typeof window.renderFiles&&window.renderFiles(window.fileManagerState.files,t,e,r,n)})),$("#clearSearch").on("click",(function(){$("#searchBar").val("").focus(),$(this).hide(),"function"==typeof window.renderFiles&&window.fileManagerState&&window.renderFiles(window.fileManagerState.files,t,e,r,n)})),document.addEventListener("click",(function(t){if(t.target.classList.contains("fa-download")){const a=t.target.dataset.file;downloadFile(a,e,r,n)}})),$(window).on("scroll",(function(){if($(window).scrollTop()+$(window).height()>=$(document).height()-100){let a=document.getElementById("itemLimit").value;fileManagerState.currentPage<fileManagerState.totalPages&&!fileManagerState.isLoading&&(fileManagerState.currentPage++,loadDirectory(t,fileManagerState.currentPage,e,r,n,a))}})),$("th[data-sort]").click((function(){const a=$(this).data("sort");if(!window.fileManagerState)return;window.fileManagerState.currentSort.column===a?window.fileManagerState.currentSort.direction="asc"===window.fileManagerState.currentSort.direction?"desc":"asc":(window.fileManagerState.currentSort.column=a,window.fileManagerState.currentSort.direction="asc"),"function"==typeof window.sortFiles&&window.sortFiles(),"function"==typeof window.renderFiles&&window.renderFiles(window.fileManagerState.files,t,e,r,n),$("th[data-sort]").find("i.fas").removeClass("fa-sort-up fa-sort-down").addClass("fa-sort");const o=$(this).find("i.fas");o.removeClass("fa-sort"),"asc"===window.fileManagerState.currentSort.direction?o.addClass("fa-sort-up"):o.addClass("fa-sort-down")})),$(document).on("click",".directory-link",(function(a){a.preventDefault();let i=document.getElementById("itemLimit").value;const s=$(this).data("path");s&&s!==t&&(t=s,o=t,updateCurrentPath(),loadDirectory(t,1,e,r,n,i),updateActiveTabPath(t))})),window.updateCurrentPath=function(){S(t)},$("#breadcrumbs").on("dblclick",(function(a){a.preventDefault();const o=$("#breadcrumbs ol"),i=t,s=$("<input>",{type:"text",value:i,class:"w-96 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"});o.html(`<li class="inline-flex items-center">${s.prop("outerHTML")}</li>`),o.find("input").focus(),o.find("input").on("blur",(function(){$(this).val().trim();S(i)})),o.find("input").on("keydown",(function(a){if(13===a.keyCode){a.preventDefault();const o=$(this).val().trim();o&&(t=o,updateCurrentPath(),loadDirectory(t,1,e,r,n),updateActiveTabPath(t))}}))})),$(document).on("click",".breadcrumb-link",(function(a){a.preventDefault();const i=$(this).data("path");i&&(t=i,updateCurrentPath(),o=t,loadDirectory(t,1,e,r,n),updateActiveTabPath(t))})),$(document).on("click","#goHome",(function(i){i.preventDefault(),t=a,updateCurrentPath(),o=t,loadDirectory(t,1,e,r,n),updateActiveTabPath(t),$(this).addClass("animate-pulse"),setTimeout((()=>{$(this).removeClass("animate-pulse")}),300)})),window.switchToTab=function(a){const o=fileManagerState.tabs.find((e=>e.id===a));if(!o)return;fileManagerState.tabs.forEach((e=>e.active=!1)),o.active=!0,fileManagerState.activeTabId=a,E(),document.querySelectorAll('[role="tabpanel"]').forEach((e=>{e.classList.add("hidden")}));let i=document.getElementById(`${a}-content`);if(!i){const e=document.getElementById("tabs-content");if(!e)return;i=document.createElement("div"),i.id=`${a}-content`,i.className="tabs-panel w-full",e.appendChild(i)}if(document.querySelectorAll(".tabs-panel").forEach((e=>{e.classList.add("hidden")})),i.classList.remove("hidden"),"editor"===o.type||"search"===o.type){const e=document.getElementById("fileManagerUI");e&&(e.style.display="none");const t=i.querySelector(".editor-container");t&&(t.style.height="90vh",t.style.width="100%",window.editor&&setTimeout((()=>window.editor.refresh()),10))}else{const a=document.getElementById("fileManagerUI"),i=document.getElementById("file");a&&(a.style.display="block",i&&i.classList.remove("hidden"),t=o.path,updateCurrentPath(),loadDirectory(t,1,e,r,n))}},window.addNewTab=function(e=null,n="filemanager"){const r=`tab-${Date.now()}`;return fileManagerState.tabs.forEach((e=>e.active=!1)),fileManagerState.tabs.push({id:r,path:t,active:!0,name:e||T(t),type:n}),fileManagerState.activeTabId=r,E(),saveTabsToLocalStorage(),r},window.updateActiveTabPath=function(e){const t=fileManagerState.tabs.find((e=>e.id===fileManagerState.activeTabId));t&&(t.path=e,t.name=T(e),E(),saveTabsToLocalStorage())},$("#bulkActions").change((function(){const a=$(this).val();setTimeout((()=>{$(this).val("")}),100);const o=()=>{const e=document.querySelectorAll(".file-checkbox:checked"),t=[];return e.forEach((e=>{const n=e.dataset.fullPath||e.dataset.file;n&&t.push(n)})),t},i=o();if(0!==i.length||"paste"===a)switch(a){case"delete":b("Delete Files",`Are you sure you want to delete ${i.length} file(s)?`,"Delete",(()=>{const a=o();a.length>0?A({action:"delete",files:a,onSuccess:()=>{clearFileSelection(),triggerAlert("success","Files deleted successfully"),loadDirectory(t,1,e,r,n)}}):triggerAlert("warning","No files selected for deletion.")}));break;case"zip":!function(e,t,n,r="",a){const o=document.documentElement.classList.contains("dark"),i=o?"bg-gray-800 text-white border-gray-700":"bg-white text-gray-900 border-gray-300";Swal.fire({title:e,html:`\n                <div class="flex flex-col space-y-4">\n                    <div class="w-full">\n                        <label for="zipFileName" class="text-sm font-medium block mb-1">\n                            ${t}\n                        </label>\n                        <input id="zipFileName" type="text" value="${r}" \n                               class="w-full p-2 border rounded ${i}">\n                    </div>\n                    <div class="w-full">\n                        <label for="compressionLevel" class="text-sm font-medium block mb-1">\n                            Compression Level:\n                        </label>\n                        <select id="compressionLevel" class="w-full p-2 border rounded ${i}">\n                            <option value="0">Store only (no compression)</option>\n                            <option value="1">Fastest (lowest compression)</option>\n                            <option value="5" selected>Normal (balanced)</option>\n                            <option value="9">Maximum (slowest)</option>\n                        </select>\n                    </div>\n                    <div class="w-full">\n                        <label for="archiveFormat" class="text-sm font-medium block mb-1">\n                            Archive Format:\n                        </label>\n                        <select id="archiveFormat" class="w-full p-2 border rounded ${i}">\n                            <option value="zip" selected>ZIP (.zip)</option>\n                            <option value="tar">TAR (.tar)</option>\n                            <option value="tar.gz">TAR GZ (.tar.gz)</option>\n                            <option value="tar.bz2">TAR BZ2 (.tar.bz2)</option>\n                            <option value="tar.xz">TAR XZ (.tar.xz)</option>\n                            <option value="gz">GZIP (.gz)</option>\n                        </select>\n                    </div>\n                </div>\n            `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:n,cancelButtonText:"Cancel",customClass:{popup:o?"bg-gray-800 text-white":"bg-white text-gray-900",confirmButton:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",cancelButton:"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2"},preConfirm:()=>{const e=document.getElementById("zipFileName").value,t=document.getElementById("compressionLevel").value,n=document.getElementById("archiveFormat").value;return e?{zipFileName:e,compressionLevel:t,archiveFormat:n}:(Swal.showValidationMessage("Please enter a filename"),!1)}}).then((e=>{e.isConfirmed&&e.value&&a(e.value)}))}("Create Zip Archive","Enter the name for the zip file:","Create","archive.zip",(a=>{if(a){const i=o();if(0===i.length)return void triggerAlert("warning","No files selected for archiving.");const s=a.archiveFormat;let c=a.zipFileName;c.toLowerCase().endsWith("."+s)||(c.includes(".")&&(c=c.substring(0,c.lastIndexOf("."))),c+="."+s),a.zipFileName=c,A({action:"zip",files:i,options:a,onSuccess:()=>{clearFileSelection(),triggerAlert("success","Archive created successfully"),loadDirectory(t,1,e,r,n)}})}}));break;case"unzip":if(i.length>1){const a=i.map((e=>{const t=e.split(".").pop().toLowerCase();if(["gz","bz2","xz"].includes(t)){if(e.substring(0,e.lastIndexOf(".")).toLowerCase().endsWith(".tar"))return`tar.${t}`}return t}));if(!a.every((e=>e===a[0])))return void b("Warning: Different Archive Types","You've selected different types of archives. This may cause extraction issues. Continue anyway?","Continue",(()=>{const a=o();a.length>0&&A({action:"unzip",files:a,onSuccess:()=>{clearFileSelection(),triggerAlert("success","Archives extracted successfully"),loadDirectory(t,1,e,r,n)}})}))}b("Extract Archive",i.length>1?`Extract ${i.length} archives to the current directory?`:`Extract "${i[0]}" to the current directory?`,"Extract",(()=>{const a=o();a.length>0&&A({action:"unzip",files:a,onSuccess:()=>{clearFileSelection(),triggerAlert("success","Archives extracted successfully"),loadDirectory(t,1,e,r,n)}})}));break;case"copy":if(i.length>0){const e=i.map((e=>e.includes("/")?e:`${t}/${e}`));localStorage.setItem("copiedFiles",JSON.stringify(e)),triggerAlert("success",`${i.length} file(s) copied to clipboard`)}break;case"paste":try{const a=JSON.parse(localStorage.getItem("copiedFiles")||"[]");a.length>0?A({action:"paste",files:a,onSuccess:()=>{clearFileSelection(),triggerAlert("success","Files pasted successfully"),loadDirectory(t,1,e,r,n),localStorage.removeItem("copiedFiles")}}):triggerAlert("warning","No files in clipboard to paste")}catch(e){triggerAlert("error","Failed to read clipboard data")}break;default:break}else triggerAlert("info","No files selected! Please select files to perform bulk actions.")}));const M=document.getElementById("dropZone"),B=document.getElementById("fileInput"),C=document.getElementById("uploadForm"),F=document.getElementById("uploadProgress"),P=document.getElementById("progressBar"),q=document.getElementById("progressText");if(M&&B&&C&&F&&P&&q){function N(e){e.preventDefault(),e.stopPropagation()}function z(a){F.classList.remove("hidden"),P.style.width="0%",q.textContent="Uploading...";const o=new FormData(C);o.append("updir",t),o.append("csrf",e),fetch("",{method:"POST",body:o}).then((e=>e.json())).then((a=>{a.success?(q.textContent="Upload complete!",setTimeout((()=>F.classList.add("hidden")),3e3),loadDirectory(t,1,e,r,n)):q.textContent=a.error||"Upload failed. Please try again."})).catch((e=>{q.textContent="Upload failed. Please try again."}))}["dragenter","dragover","dragleave","drop"].forEach((e=>{M.addEventListener(e,N,!1)})),["dragenter","dragover"].forEach((e=>{M.addEventListener(e,(()=>M.classList.add("bg-blue-50","dark:bg-gray-600")),!1)})),["dragleave","drop"].forEach((e=>{M.addEventListener(e,(()=>M.classList.remove("bg-blue-50","dark:bg-gray-600")),!1)})),M.addEventListener("drop",(function(e){const n=e.dataTransfer.files;n.length>0&&(B.files=n,o=t,z(o))}),!1),B.addEventListener("change",z),M.addEventListener("click",(()=>B.click()))}function D(e,t,n,r,a){if(progr(),!t)return triggerAlert("warning","File content is empty."),void dprogr();if(!e)return triggerAlert("warning","No file path specified."),void dprogr();const o=document.querySelector(`[data-file-path="${e}"]`);let i="";if(o){const e=o.id.replace("-content",""),t=document.getElementById(`file-type-select-${e}`);t&&(i=t.value)}sendRequest({csrf:n,action:"save_content",file:e,content:t,file_type:i},r,a).then((e=>{triggerAlert("success","File saved successfully"),dprogr()})).catch((e=>{triggerAlert("danger","Failed to save file: "+e),dprogr()}))}function H(e){switch(e.split(".").pop().toLowerCase()){case"js":return"javascript";case"php":return"php";case"html":case"htm":return"htmlmixed";case"css":return"css";case"json":return"application/json";case"xml":return"xml";case"md":return"markdown";case"py":return"python";case"rb":return"ruby";case"java":return"text/x-java";case"c":return"text/x-csrc";case"cpp":case"cc":case"h":case"hpp":return"text/x-c++src";case"cs":return"text/x-csharp";case"go":return"text/x-go";case"rs":return"text/x-rustsrc";case"ts":return"text/typescript";case"sql":return"sql";case"sh":case"bash":return"shell";case"yml":case"yaml":return"yaml";case"txt":return"text";default:return"plaintext"}}document.addEventListener("click",(function(t){if(t.target.classList.contains("file-link")){t.preventDefault();!function(e,t,n,r){progr();try{const o=I(e.split("/").pop(),"editor");function a(a){a.dataset.filePath=e;const i=document.getElementById("fileManagerUI");i&&i.classList.add("hidden"),a.classList.remove("hidden");const s=document.createElement("div");s.className="editor-container",s.style.width="100%",s.style.height="90vh",s.style.border="1px solid #ddd",s.style.position="relative",a.appendChild(s);const c=document.createElement("div");c.className="file-type-selector fixed top-4 right-4 z-50",c.innerHTML=`\n                    <select id="file-type-select-${o}" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-sm">\n                        <option value="">Auto-detect</option>\n                        <option value="javascript">JavaScript</option>\n                        <option value="php">PHP</option>\n                        <option value="htmlmixed">HTML</option>\n                        <option value="css">CSS</option>\n                        <option value="application/json">JSON</option>\n                        <option value="xml">XML</option>\n                        <option value="markdown">Markdown</option>\n                        <option value="python">Python</option>\n                        <option value="text/x-java">Java</option>\n                        <option value="text/x-csrc">C</option>\n                        <option value="text/x-c++src">C++</option>\n                        <option value="sql">SQL</option>\n                        <option value="shell">Shell/Bash</option>\n                        <option value="yaml">YAML</option>\n                        <option value="text">Plain Text</option>\n                    </select>\n                `,a.appendChild(c),sendRequest({csrf:t,action:"view_content",file:e},n,r).then((i=>{if("undefined"==typeof CodeMirror)return s.innerHTML=`<pre style="white-space: pre-wrap; padding: 1rem;">${i.content}</pre>`,triggerAlert("warning","CodeMirror not found. Displaying content in plain text mode."),void dprogr();const c=i.file_type||H(e),l=CodeMirror(s,{value:i.content||"",mode:c,theme:document.documentElement.classList.contains("dark")?"dracula":"eclipse",lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0});window.editor=l,l.setSize("100%","100%");const d=document.getElementById(`file-type-select-${o}`);if(d){Array.from(d.options).find((e=>e.value===c))&&(d.value=c),d.addEventListener("change",(()=>{const a=d.value||H(e);l.setOption("mode",a),sendRequest({csrf:t,action:"view_content",file:e,file_type:a},n,r),setTimeout((()=>l.refresh()),50)}))}let u=a.querySelector(".save-file-btn");u||(u=document.createElement("button"),u.className="save-file-btn fixed bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded shadow-lg z-50",u.innerHTML='<i class="fas fa-save mr-2"></i> Save',u.addEventListener("click",(()=>{const a=l.getValue();D(e,a,t,n,r)})),a.appendChild(u)),setTimeout((()=>{l&&(l.refresh(),l.focus())}),100),dprogr()})).catch((e=>{s.innerHTML='<div class="p-4 text-red-500">Failed to load file content: '+e+"</div>",dprogr()}))}setTimeout((()=>{const e=document.querySelector(`#${o}-content`);if(e)a(e);else{const e=document.getElementById("tabs-content");if(e){const t=document.createElement("div");t.id=`${o}-content`,t.className="tabs-panel w-full",e.appendChild(t),a(t)}else dprogr(),triggerAlert("warning","Failed to create editor tab. Try refreshing the page.")}}),100)}catch(e){dprogr()}}(t.target.dataset.file,e,r,n)}})),function(){const t=document.getElementById("cancelEdit"),a=document.getElementById("cancelEditBtn"),o=document.getElementById("editorLanguage"),i=document.getElementById("saveFile");t&&t.addEventListener("click",(function(){const e=document.getElementById("editorModal");e&&e.classList.add("hidden")})),a&&a.addEventListener("click",(function(){const e=document.getElementById("editorModal");e&&e.classList.add("hidden")})),o&&o.addEventListener("change",(function(){if(window.editor){const e=this.value,t={javascript:"javascript",php:"php",html:"htmlmixed",css:"css",json:"javascript",plaintext:"null"}[e]||"null";window.editor.setOption("mode",t);const n=document.getElementById("editorStatus");n&&(n.textContent=`Language changed to ${e}`)}})),i&&i.addEventListener("click",(function(){const t=window.editor?window.editor.getValue():"",a=document.getElementById("editorModal"),o=a&&a.dataset.filePath?a.dataset.filePath:"",i=document.getElementById("editorStatus");i&&(i.textContent="Saving..."),D(o,t,e,r,n)}))}();function R(){const e=document.querySelector('[role="tab"][aria-selected="true"]')?.getAttribute("data-tabs-target"),t=document.querySelector(".mb-4.border-b.border-gray-200.dark\\:border-gray-700"),n=document.getElementById("breadcrumbs");e&&t&&n&&("#terminal"===e||"#config"===e||"#setting"===e?(t.classList.add("hidden"),n.classList.add("hidden")):(t.classList.remove("hidden"),n.classList.remove("hidden")))}function O(){s="",l=0,u=0,g=0,p="",d=!1}function _(){$("line.current bl").remove(),$("line.current").removeClass("current")}function V(){$("terminal content").append('<line class="current"><path>'+i+"</path> <sp></sp> <t><bl></bl></t></line>")}function j(){let e=$("line.current t").html(),t=1==e.split(" ").length?"<cm>"+e+"</cm>":"<cm>"+e.split(" ")[0]+"</cm> <code>"+e.split(" ").slice(1).join(" ").replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</code>";$("line.current t").html(t.replace("&lt;bl&gt;&lt;/bl&gt;","<bl></bl>"))}function U(e=""){""===e?e=s:u=0;let t=e.substr(0,e.length+u),n=e.substr(e.length+u);$("line.current t").html(t+"<bl></bl>"+n)}window.initializeEditor=function(e,t="plaintext",n="editorContainer"){progr();const r=document.getElementById(n);if(!r)return void dprogr();const a=document.documentElement.classList.contains("dark")?"dracula":"eclipse";try{const n={"Ctrl-S":function(e){const t=r.closest('[id$="-content"]');if(t){const e=t.querySelector(".save-file-btn");e&&e.click()}else{const e=document.getElementById("saveFile");e&&e.click()}return!1},"Ctrl-F":"findPersistent","Ctrl-H":"replace","Ctrl-/":"toggleComment",Tab:function(e){return e.somethingSelected()?e.indentSelection("add"):e.replaceSelection("    ","end"),!0},"Shift-Tab":function(e){return e.indentSelection("subtract"),!0},"Ctrl-Q":function(e){return e.foldCode(e.getCursor()),!1},Esc:function(e){return e.getOption("fullScreen")&&e.setOption("fullScreen",!1),!1}};r.innerHTML="";const o=CodeMirror(r,{value:e||"",mode:t,theme:a,lineNumbers:!0,indentUnit:4,smartIndent:!0,indentWithTabs:!1,lineWrapping:!0,matchBrackets:!0,autoCloseBrackets:!0,autoCloseTags:!0,styleActiveLine:!0,selectionPointer:!0,tabSize:parseInt(localStorage.getItem("tab-size")||"4"),extraKeys:n,scrollbarStyle:"native",undoDepth:200,historyEventDelay:200});window.editor=o,o.setSize("100%","100%"),setTimeout((()=>{o&&o.focus()}),100),setTimeout((()=>{o&&o.refresh()}),50)}catch(e){triggerAlert("warning","Failed to initialize the editor. Please try again.")}finally{dprogr()}},window.createEditor=function(e,t){if("function"==typeof window.initializeEditor)if(document.getElementById("editorContainer"))try{window.initializeEditor(e,t)}catch(e){triggerAlert("warning","Failed to initialize editor. Please try again.")}else triggerAlert("warning","Editor container not found in DOM. Please refresh the page.");else triggerAlert("warning","Editor initialization failed. Please refresh the page.")},$(document).ready((function(){function a(e){var t="number"==typeof e.which?e.which:e.keyCode;8===t||9===t||46===t?(e.preventDefault(),""!==s&&(8===t?function(){0!==g&&(g=0,s=p);let e=s.substr(0,s.length+u),t=s.substr(s.length+u);s=e.substr(0,e.length-1)+t,U(),j()}():46===t?function(){let e=s.substr(0,s.length+u),t=s.substr(s.length+u);s=e+t.substr(1),0!==u&&u++;U(),j()}():9===t&&function(){if(m!==s)if(m=s,f=[],1===s.split(" ").length){let e=h.concat(Object.keys(K));f=e.filter((function(e){return e.length>s.length&&e.substr(0,s.length).toLowerCase()==s.toLowerCase()})).reverse().sort((function(e,t){return t.length-e.length}))}else if(2===s.split(" ").length){let t=s.split(" ")[0],n=s.split(" ")[1];var e="";if("cd"===t||"cp"===t||"mv"===t||"cat"===t){switch(t){case"cd":e="ls -d "+n+"*/";break;case"cp":case"mv":e="ls -d "+n+"*/";break;case"cat":e="ls -p | grep -v /";break;default:e=""}$.ajax({type:"POST",async:!1,data:{command:e,path:i},cache:!1,success:function(e){e=$.parseJSON(e),f=e.result.split("<br>").filter((function(e){return 0!==e.length}))}})}}f.length&&f.length>Math.abs(g)?(g--,U(p=(2===s.split(" ").length?s.split(" ")[0]+" ":"")+f[f.length+g]),j()):(g=0,p="",U(),j())}())):e.ctrlKey&&67===t?(g=0,_(),V(),O()):13===t?(0!==g&&(g=0,s=p),s.toLowerCase().split(" ")[0]in K?K[s.toLowerCase().split(" ")[0]](s.split(" ").slice(1)):0!==s.length&&$.ajax({type:"POST",async:!1,data:{command:s,path:i},cache:!1,success:function(e){e=$.parseJSON(e),i=e.path,$("terminal content").append("<line><br>"+e.result+"</line>")}}),_(),function(e){e.length>=2&&(0===c.length||c[c.length-1]!==e)&&(c[c.length]=e)}(s),V(),O(),$("terminal content").scrollTop($("terminal content").prop("scrollHeight"))):35!==t&&36!==t&&37!==t&&39!==t||""===s?38!==t&&40!==t||""!==s&&!d?(32===t||222===t||220===t||t>=45&&t<=195&&!(t>=112&&t<=123)&&46!=t&&91!=t&&93!=t&&144!=t&&145!=t&&45!=t)&&(!function(e){l=0,d=!1,0!==g&&(g=0,s=p);if("/"===s[s.length-1]&&"/"===e)return;let t=s.substr(0,s.length+u),n=s.substr(s.length+u);s=t+e+n,U(),j()}(e.key),$("terminal content").scrollTop($("terminal content").prop("scrollHeight"))):(e.preventDefault(),38===t&&c.length&&c.length>=-1*l+1?(l--,s=c[c.length+l],U(),j(),d=!0):40===t&&c.length&&c.length>=-1*l&&0!==l&&(l++,s=0===l?"":c[c.length+l],U(),j(),d=0!==l)):(e.preventDefault(),$("line.current bl").remove(),0!==g&&(g=0,s=p),35===t&&(u=0),36===t&&(u=-1*s.length),37===t&&s.length!==Math.abs(u)&&u--,39===t&&0!==u&&u++,U(),j())}function o(){$("#terminal").is(":visible")?$(document).on("keydown",a):$(document).off("keydown",a)}window.fileManagerState||(window.fileManagerState={files:[],totalPages:1,currentPage:1,currentSort:{column:"name",direction:"asc"},selectedFiles:[],tabs:[{id:"tab-1",path:t,active:!0,name:"Home"}],activeTabId:"tab-1"}),loadDirectory(t,1,e,r,n),setTimeout((function(){const{column:e,direction:t}=window.fileManagerState.currentSort;$("th[data-sort]").find("i.fas").removeClass("fa-sort-up fa-sort-down").addClass("fa-sort");const n=$(`th[data-sort="${e}"]`);if(n.length){const e=n.find("i.fas");e.removeClass("fa-sort"),e.addClass("asc"===t?"fa-sort-up":"fa-sort-down")}}),500),o(),window.updateKeydownListener=o,$("[data-tabs-target]").on("click",(function(){setTimeout((()=>{window.updateKeydownListener&&window.updateKeydownListener()}),100)}))})),document.addEventListener("DOMContentLoaded",(function(){R(),document.querySelectorAll("[data-tabs-target]").forEach((e=>{e.addEventListener("click",(function(){setTimeout(R,50)}))}));const e=new MutationObserver((e=>{e.forEach((e=>{"aria-selected"===e.attributeName&&R()}))}));document.querySelectorAll('[role="tab"]').forEach((t=>{e.observe(t,{attributes:!0,attributeFilter:["aria-selected"]})}))})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",R):R();var K={clear:function(){$("terminal content").html("")},history:function(e){var t=[];let n=e.length&&Number.isInteger(Number(e[0]))?Number(e[0]):0;if(0!=n&&n<=c.length)for(var r=c.length-n;r<c.length;r++)t[t.length]=r+1+" &nbsp;"+c[r];else c.forEach((function(e,n){t[t.length]=n+1+" &nbsp;"+e}));$("terminal content").append("<line>"+t.join("<br>")+"</line>")}};function J(e,t,n,r,a){y("Execute PHP Code","Enter the PHP code to execute:","Execute","",(e=>{e&&""!==e.trim()&&sendRequest({csrf:t,action:"execute",code:e.trim(),dir:n},r,a).then((e=>{var t;t=e.output,document.getElementById("editorModal").classList.remove("hidden"),window.initializeEditor(t,"bash")})).catch((e=>{triggerAlert("warning",e)}))}))}updateCurrentPath(),document.getElementById("itemLimit").addEventListener("change",(a=>{const o=a.target.value;localStorage.setItem("default-items-per-page",o),window.fileManagerState.currentPage=1,loadDirectory(t,1,e,r,n,o)})),document.addEventListener("click",(function(a){a.target.classList.contains("codeme")&&J(0,e,t,r,n)}))})),window.initEditorLanguageSelector=function(){const e=document.getElementById("editorLanguage");e&&!e.dataset.initialized&&(e.addEventListener("change",(function(){const e=this.value;if(window.editor&&e)try{window.editor.setOption("mode",e);const t=document.getElementById("editorStatus");if(t){const n=(t.textContent||"").replace(/\|.*\|/,`| ${e} |`);t.textContent=n}}catch(e){}})),e.dataset.initialized="true")},document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll("[data-tabs-target]").forEach((e=>{e.addEventListener("click",(function(){handleTabSwitch(this.getAttribute("data-tabs-target"))}))}));const e=document.querySelector('[role="tab"][aria-selected="true"]');handleTabSwitch(e?e.getAttribute("data-tabs-target"):"#file")})),window.showConfirmation="function"==typeof showConfirmation?showConfirmation:function(){},window.diagnoseFunctions=function(){window.fileManagerState,window.phpVars},setTimeout((()=>{window.diagnoseFunctions&&window.diagnoseFunctions()}),1e3),document.addEventListener("DOMContentLoaded",(function(){initThemeToggle(),initEnhancedTabs(),initSettings(),initGlobalKeyboardShortcuts(),exposeUtilityFunctions(),"undefined"==typeof phpVars||window.phpVars?window.phpVars:window.phpVars=phpVars,document.querySelector(".advanced-search")?.addEventListener("click",(function(){"function"==typeof window.showAdvancedSearch?window.showAdvancedSearch():triggerAlert("warning","Advanced search feature is not available")}))})),window.saveTabsToLocalStorage=function(){try{const e=fileManagerState.tabs.map((e=>({id:e.id,path:e.path,active:e.active,name:e.name,type:e.type||"filemanager"})));localStorage.setItem("fileManager_activeTabId",fileManagerState.activeTabId),localStorage.setItem("fileManager_tabs",JSON.stringify(e))}catch(e){}},window.loadTabsFromLocalStorage=function(){try{const e=localStorage.getItem("fileManager_tabs");if(!e)return!1;const t=JSON.parse(e);if(!Array.isArray(t)||0===t.length)return!1;const n=localStorage.getItem("fileManager_activeTabId");return fileManagerState.tabs=t,n&&fileManagerState.tabs.find((e=>e.id===n))?(fileManagerState.activeTabId=n,fileManagerState.tabs.forEach((e=>{e.active=e.id===n}))):(fileManagerState.tabs[0].active=!0,fileManagerState.activeTabId=fileManagerState.tabs[0].id),!0}catch(e){return!1}},document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("network-tab");e&&e.addEventListener("click",(function(){initNetworkTools()}))}));
