function sqlDebugLog(e,t=null){}function initSQLExplorer(){sqlDebugLog("Initializing SQL Explorer");const e=document.getElementById("sqlConnectionForm"),t=document.getElementById("sqlDatabaseSelect"),n=(document.getElementById("sqlTableFilter"),document.getElementById("sqlTableStructure"),document.getElementById("sqlTableData"),document.getElementById("sqlQueryInput")),a=document.getElementById("sqlExecuteQuery"),r=(document.getElementById("sqlQueryResult"),document.getElementById("sqlExportSql")),o=document.getElementById("sqlExportCsv"),l=document.getElementById("sqlExportZip"),s=document.getElementById("sqlGlobalSearch"),d=document.getElementById("sqlGlobalSearchBtn");e&&e.addEventListener("submit",(function(e){e.preventDefault(),connectToDatabase()})),t&&t.addEventListener("change",(function(e){const t=e.target.value;t&&loadTables(t)})),a&&a.addEventListener("click",(function(){executeQuery()})),n&&n.addEventListener("keydown",(function(e){e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),executeQuery())})),r&&r.addEventListener("click",(function(){exportTableAsSql()})),o&&o.addEventListener("click",(function(){exportTableAsCsv()})),l&&l.addEventListener("click",(function(){exportDatabaseAsZip()}));const i=document.getElementById("sqlExportAllZip");i&&i.addEventListener("click",(function(){exportAllDatabasesAsZip()}));const c=document.getElementById("sqlBackupToTelegram");c&&c.addEventListener("click",(function(){backupAllDatabasesToTelegram()})),d&&d.addEventListener("click",(function(){globalDatabaseSearch(s?s.value.trim():"")})),s&&s.addEventListener("keypress",(function(e){if("Enter"===e.key){e.preventDefault();globalDatabaseSearch(this.value.trim())}}))}function getCsrfToken(){const e=document.cookie.split(";");for(let t=0;t<e.length;t++){const n=e[t].trim();if(n.startsWith("csrf_token="))return sqlDebugLog("Found CSRF token in cookies"),n.substring("csrf_token=".length,n.length)}return sqlDebugLog("CSRF token not found in cookies!"),""}if("function"!=typeof encrypt)function encrypt(e,t){return CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(e),t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString()}if("function"!=typeof decrypt)function decrypt(e,t){return CryptoJS.AES.decrypt(e,t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}function sqlSendRequest(e){sqlDebugLog("Sending SQL request",e);const t=window.phpVars&&"1"===window.phpVars.isEnc,n=window.phpVars?window.phpVars.encryptionKey:null;let a=JSON.stringify(e);const r=t?encrypt(a,CryptoJS.enc.Utf8.parse(n)):a;return new Promise(((e,a)=>{const o=new XMLHttpRequest;o.open("POST",window.location.href,!0),o.setRequestHeader("Content-Type","application/json"),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status)try{sqlDebugLog("SQL response received",o.responseText);const a=t?decrypt(o.responseText,CryptoJS.enc.Utf8.parse(n)):o.responseText,r=JSON.parse(a);sqlDebugLog("SQL response parsed",r),e(r)}catch(e){const t="Failed to parse response: "+e.message;sqlDebugLog("SQL parse error",t),a(t)}else{const e="Request failed with status: "+o.status;sqlDebugLog("SQL request failed",e),a(e)}},o.onerror=function(){const e="Network error occurred";sqlDebugLog("SQL network error",e),a(e)},o.send(r)}))}function connectToDatabase(){sqlDebugLog("Connecting to database..."),clearDatabaseSelect(),clearTableSelect(),clearTableData(),clearQueryResult();const e=document.getElementById("sqlHost").value||"localhost",t=document.getElementById("sqlUser").value,n=document.getElementById("sqlPassword").value,a=document.getElementById("sqlDatabase").value,r=document.getElementById("sqlPort").value||"3306";sqlDebugLog("Connection parameters",{host:e,user:t,database:a,port:r}),showLoadingState("Connecting to database...");const o=getCsrfToken();sqlDebugLog("Using CSRF token",o);sqlSendRequest({csrf:o,action:"sql_explorer",sql_action:"connect",params:{host:e,user:t,password:n,database:a,port:r}}).then((e=>{if(hideLoadingState(),sqlDebugLog("Connection result",e),e.success){triggerAlert("success","Connected to database successfully!"),hideConnectionForm();const e=document.getElementById("sqlLogoutBtn");e&&(e.classList.remove("hidden"),e.addEventListener("click",disconnectDatabase)),loadDatabases(),enableDatabaseSection(),a&&selectDatabase(a)}else triggerAlert("warning","Connection failed: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Connection error",e),triggerAlert("warning","Error: "+e)}))}function disconnectDatabase(){sqlDebugLog("Disconnecting from database..."),showLoadingState("Disconnecting...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"disconnect",params:{}}).then((e=>{hideLoadingState(),sqlDebugLog("Disconnection result",e),resetUIAfterDisconnect(),triggerAlert("success","Disconnected from database successfully!")})).catch((e=>{hideLoadingState(),sqlDebugLog("Disconnection error",e),triggerAlert("warning","Error disconnecting: "+e),resetUIAfterDisconnect()}))}function resetUIAfterDisconnect(){showConnectionForm();const e=document.getElementById("sqlConnectionContainer");e&&e.classList.remove("hidden");const t=document.getElementById("sqlLogoutBtn");t&&t.classList.add("hidden"),clearDatabaseSelect(),clearTableSelect(),clearTableData(),clearQueryResult();const n=document.getElementById("sqlDatabaseSection");n&&n.classList.add("hidden");const a=document.getElementById("sqlTableSection");a&&a.classList.add("hidden");const r=document.getElementById("sqlGlobalSearchSection");r&&r.classList.add("hidden");const o=document.getElementById("sqlExportSection");o&&o.classList.add("hidden");const l=document.getElementById("sqlConnectionContainer");if(l){l.querySelectorAll(".p-4").forEach((e=>{e.querySelector("#sqlConnectionForm")||e.remove()}));const e=document.querySelector("#sqlConnectionContainer .p-4");e&&e.querySelector("#sqlConnectionForm")&&e.classList.remove("hidden")}}function hideConnectionForm(){const e=document.getElementById("sqlConnectionContainer");e&&e.classList.add("hidden");const t=document.getElementById("sqlConnectionInfo");t&&t.classList.add("hidden");const n=document.getElementById("sqlExportSection");n&&n.classList.remove("hidden")}function showConnectionForm(){const e=document.getElementById("sqlConnectionContainer");if(e){const t='\n            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-t-lg px-4 py-3 flex justify-between items-center">\n                <h3 class="text-lg font-semibold flex items-center">\n                    <i class="fas fa-plug mr-2"></i> Connection\n                </h3>\n                <button id="sqlLogoutBtn" class="hidden text-xs bg-blue-800 hover:bg-blue-900 text-white px-2 py-1 rounded transition-colors">\n                    <i class="fas fa-sign-out-alt mr-1"></i> Disconnect\n                </button>\n            </div>\n            <div class="p-4">\n                <form id="sqlConnectionForm" class="space-y-3">\n                    <div class="flex flex-col">\n                        <label for="sqlHost" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Host</label>\n                        <input type="text" id="sqlHost" name="host" value="localhost" \n                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">\n                    </div>\n                    <div class="flex flex-col">\n                        <label for="sqlPort" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Port</label>\n                        <input type="text" id="sqlPort" name="port" value="3306"\n                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">\n                    </div>\n                    <div class="flex flex-col">\n                        <label for="sqlUser" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>\n                        <input type="text" id="sqlUser" name="user" value="root"\n                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">\n                    </div>\n                    <div class="flex flex-col">\n                        <label for="sqlPassword" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>\n                        <input type="password" id="sqlPassword" name="password"\n                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">\n                    </div>\n                    <div class="flex flex-col">\n                        <label for="sqlDatabase" class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Database (optional)</label>\n                        <input type="text" id="sqlDatabase" name="database"\n                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">\n                    </div>\n                    <div class="pt-2">\n                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium rounded text-sm px-4 py-2.5 text-center focus:outline-none transition duration-150">\n                            <i class="fas fa-plug mr-2"></i> Connect\n                        </button>\n                    </div>\n                </form>\n            </div>\n        ';e.innerHTML=t;const n=document.getElementById("sqlConnectionForm");n&&n.addEventListener("submit",(function(e){e.preventDefault(),connectToDatabase()}));const a=document.getElementById("sqlLogoutBtn");a&&a.addEventListener("click",disconnectDatabase)}}function showConnectionInfo(e){const t=document.getElementById("sqlConnectionInfo"),n=document.getElementById("sqlConnectionDetails");t&&n&&(t.classList.remove("hidden"),n.innerHTML=`\n            <div class="flex justify-between">\n                <span class="text-gray-600 dark:text-gray-400">Host:</span>\n                <span class="font-medium text-gray-800 dark:text-gray-200">${e.host}:${e.port}</span>\n            </div>\n            <div class="flex justify-between">\n                <span class="text-gray-600 dark:text-gray-400">User:</span>\n                <span class="font-medium text-gray-800 dark:text-gray-200">${e.user}</span>\n            </div>\n            <div class="flex justify-between">\n                <span class="text-gray-600 dark:text-gray-400">Database:</span>\n                <span class="font-medium text-gray-800 dark:text-gray-200">${e.database}</span>\n            </div>\n        `)}function loadDatabases(){sqlDebugLog("Loading databases..."),showLoadingState("Loading databases...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"databases",params:{}}).then((e=>{hideLoadingState(),sqlDebugLog("Databases result",e),e.success&&e.databases?populateDatabaseSelect(e.databases):triggerAlert("warning","Failed to load databases: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Databases error",e),triggerAlert("warning","Error: "+e)}))}function loadTables(e){sqlDebugLog(`Loading tables for database: ${e}`),clearTableSelect(),clearTableStructure(),clearTableData();const t=document.getElementById("sqlExportSection");t&&t.classList.remove("hidden"),showLoadingState("Loading tables...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"tables",params:{database:e}}).then((e=>{hideLoadingState(),sqlDebugLog("Tables result",e),e.success&&e.tables?(populateTableSelect(e.tables),enableTableSection()):(sqlDebugLog("Failed to load tables",e.error||"Unknown error"),triggerAlert("warning","Failed to load tables: "+(e.error||"Unknown error")))})).catch((e=>{hideLoadingState(),sqlDebugLog("Tables error",e),triggerAlert("warning","Error: "+e)}))}function loadTableStructure(e){}function loadTableData(e,t=1,n=50,a=null,r="ASC",o=null){sqlDebugLog(`Loading data for table: ${e}, page: ${t}, limit: ${n}, search: ${o}`),clearTableData(),showLoadingState("Loading table data...");const l={csrf:getCsrfToken(),action:"sql_explorer",sql_action:"data",params:{table:e,page:t,limit:n,orderBy:a,orderDir:r}};o&&(l.params.search=o),sqlSendRequest(l).then((a=>{hideLoadingState(),sqlDebugLog("Table data result",a),a.success?renderTableData(a.data,a.total,t,n,a.primaryKeys,e,o):triggerAlert("warning","Failed to load table data: "+(a.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Table data error",e),triggerAlert("warning","Error: "+e)}))}function executeQuery(){const e=document.getElementById("sqlQueryInput").value;if(!e.trim())return void triggerAlert("warning","Please enter a SQL query");clearQueryResult(),showLoadingState("Executing query...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"query",params:{sql:e}}).then((e=>{hideLoadingState(),e.success?e.data?renderQueryResult(e.data):void 0!==e.affectedRows?renderAffectedRows(e.affectedRows):renderEmptyResult():triggerAlert("warning","Query failed: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),triggerAlert("warning","Error: "+e)}))}function triggerAlert(e,t){if("function"==typeof window.triggerAlert&&window.triggerAlert!==triggerAlert)return void window.triggerAlert(e,t);const n=new CustomEvent("show-alert",{detail:{type:e,message:t}});document.dispatchEvent(n)}function selectDatabase(e){const t=document.getElementById("sqlDatabaseSelect");if(t){t.value=e;const n=new Event("change");t.dispatchEvent(n)}}function populateDatabaseSelect(e){sqlDebugLog(`Populating database select with ${e.length} databases`,e);const t=document.getElementById("sqlDatabaseSelect");t?(t.innerHTML='<option value="">Select a database</option>',e.forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}))):sqlDebugLog("Error: Database select element not found")}function populateTableSelect(e){sqlDebugLog(`Populating table list with ${e.length} tables`,e);const t=document.getElementById("sqlTableList"),n=document.getElementById("sqlTableFilter");t?(t.innerHTML="",0!==e.length?(e.forEach((e=>{const n=document.createElement("li");n.className="table-item hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer",n.dataset.tableName=e,n.innerHTML=`\n            <div class="p-2 text-sm flex items-center">\n                <i class="fas fa-table mr-2 text-indigo-500"></i>\n                <span class="text-gray-800 dark:text-gray-200">${e}</span>\n            </div>\n        `,n.addEventListener("click",(function(){t.querySelectorAll(".table-item").forEach((e=>{e.classList.remove("bg-indigo-50","dark:bg-indigo-900")})),n.classList.add("bg-indigo-50","dark:bg-indigo-900"),loadTableData(e);const a=document.getElementById("sqlExportSection");a&&a.classList.remove("hidden")})),t.appendChild(n)})),n&&n.addEventListener("input",(function(e){const n=e.target.value.toLowerCase(),a=t.querySelectorAll(".table-item");a.forEach((e=>{e.dataset.tableName.toLowerCase().includes(n)?e.style.display="":e.style.display="none"}));if(0===Array.from(a).filter((e=>"none"!==e.style.display)).length&&n){const e=document.createElement("li");e.className="no-results p-2 text-sm text-gray-500 dark:text-gray-400 text-center",e.textContent=`No tables matching "${n}"`;const a=t.querySelector(".no-results");a&&a.remove(),t.appendChild(e)}else{const e=t.querySelector(".no-results");e&&e.remove()}}))):t.innerHTML='<li class="p-2 text-sm text-gray-500 dark:text-gray-400 text-center">No tables found</li>'):sqlDebugLog("Error: Table list element not found")}function renderTableStructure(e){const t=document.getElementById("sqlTableStructure");if(!t)return;const n=document.createElement("table");n.className="sql-adminer-table w-full text-sm text-left";const a=document.createElement("thead"),r=document.createElement("tr");["Field","Type","Null","Key","Default","Extra"].forEach((e=>{const t=document.createElement("th");t.textContent=e,r.appendChild(t)})),a.appendChild(r),n.appendChild(a);const o=document.createElement("tbody");e.forEach((e=>{const t=document.createElement("tr");["Field","Type","Null","Key","Default","Extra"].forEach((n=>{const a=document.createElement("td");"Key"===n&&"PRI"===e[n]?a.innerHTML='<span class="px-2 py-1 rounded bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs font-semibold">PRI</span>':"Key"===n&&"MUL"===e[n]?a.innerHTML='<span class="px-2 py-1 rounded bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-semibold">MUL</span>':"Key"===n&&"UNI"===e[n]?a.innerHTML='<span class="px-2 py-1 rounded bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-semibold">UNI</span>':"Field"===n?a.innerHTML=`<span class="font-medium">${null!==e[n]?e[n]:""}</span>`:"Type"===n?a.innerHTML=`<span class="text-blue-600 dark:text-blue-400">${null!==e[n]?e[n]:""}</span>`:"Null"===n?"YES"===e[n]?a.innerHTML='<span class="text-green-600 dark:text-green-400">YES</span>':a.innerHTML='<span class="text-red-600 dark:text-red-400">NO</span>':"Default"===n&&null===e[n]?a.innerHTML='<span class="text-gray-400 italic">NULL</span>':a.textContent=null!==e[n]?e[n]:"",t.appendChild(a)})),o.appendChild(t)})),n.appendChild(o),t.innerHTML="",t.appendChild(n);const l=document.createElement("button");l.className="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded text-sm px-4 py-2 text-center focus:outline-none transition duration-150",l.innerHTML='<i class="fas fa-plus mr-2"></i> Add Column',t.appendChild(l)}let tableColumnVisibility={};function renderTableData(e,t,n,a,r=[],o,l=null){sqlDebugLog("Rendering table data",{dataLength:e?.length,primaryKeys:r});const s=document.getElementById("sqlTableData");if(!s)return;if(!e||!e.length){s.innerHTML='\n            <div class="p-4 text-gray-500 flex flex-col items-center justify-center">\n                <p class="mb-4">No data found in table</p>\n                <button id="addNewRowBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded text-sm px-4 py-2 text-center focus:outline-none transition duration-150">\n                    <i class="fas fa-plus mr-2"></i> Add New Row\n                </button>\n            </div>\n        ';const e=document.getElementById("addNewRowBtn");return void(e&&e.addEventListener("click",(()=>{showAddRowForm(o)})))}const d=document.createElement("div");d.className="mb-4";const i=Object.keys(e[0]);tableColumnVisibility[o]||(tableColumnVisibility[o]={},i.forEach((e=>{tableColumnVisibility[o][e]=!0})));const c=document.createElement("div");c.className="flex flex-wrap justify-between items-center mb-3 gap-2";const u=document.createElement("div");u.className="w-full flex items-center mb-3";const g=document.createElement("input");g.type="text",g.id="sqlTableSearch",g.className="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-md focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",g.placeholder="Search in all columns",g.value=l||"";const m=document.createElement("button");m.className="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-r-md text-sm px-4 py-2 text-center focus:outline-none transition duration-150",m.innerHTML='<i class="fas fa-search"></i>',m.addEventListener("click",(()=>{const e=g.value.trim();loadTableData(o,1,a,null,"ASC",e)})),g.addEventListener("keypress",(e=>{if("Enter"===e.key){const e=g.value.trim();loadTableData(o,1,a,null,"ASC",e)}}));let p=null;l&&(p=document.createElement("button"),p.className="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded text-sm px-4 py-2 text-center focus:outline-none transition duration-150 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200",p.innerHTML='<i class="fas fa-times"></i> Clear',p.addEventListener("click",(()=>{g.value="",loadTableData(o,1,a)}))),u.appendChild(g),u.appendChild(m),p&&u.appendChild(p);const b=document.createElement("div");b.className="flex items-center",b.innerHTML=`\n        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center">\n            <span class="bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-2 py-1 rounded text-xs font-bold">${t}</span>\n            <span class="ml-1 mr-1">records in table</span>\n            <span class="font-bold text-gray-700 dark:text-gray-300">${o}</span>\n        </h4>\n    `;const y=document.createElement("div");y.className="flex items-center flex-wrap gap-2";const f=document.createElement("button");f.className="bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-medium rounded text-sm px-3 py-1.5 text-center focus:outline-none transition duration-150",f.innerHTML='<i class="fas fa-columns mr-1"></i> Columns',f.addEventListener("click",(()=>{showColumnManager(o,i)}));const x=document.createElement("button");x.className="bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-medium rounded text-sm px-3 py-1.5 text-center focus:outline-none transition duration-150",x.innerHTML='<i class="fas fa-plus mr-1"></i> New Record',x.addEventListener("click",(()=>{showAddRowForm(o)}));const h=document.createElement("button");h.className="bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-medium rounded text-sm px-3 py-1.5 text-center focus:outline-none transition duration-150",h.innerHTML='<i class="fas fa-file-export mr-1"></i> Export',y.appendChild(f),y.appendChild(x),y.appendChild(h),d.appendChild(u),c.appendChild(b),c.appendChild(y),d.appendChild(c);const w=document.createElement("table");w.className="sql-adminer-table w-full text-sm text-left";const E=document.createElement("thead"),k=document.createElement("tr");i.forEach((e=>{if(tableColumnVisibility[o][e]){const t=document.createElement("th");let l="";r&&r.includes(e)&&(l="text-yellow-700 dark:text-yellow-300");const s=`\n                <div class="flex items-center justify-between cursor-pointer group" data-column="${e}">\n                    <span class="${l}">${e}</span>\n                    <div class="flex flex-col opacity-0 group-hover:opacity-100 transition-opacity">\n                        <i class="fas fa-chevron-up text-xs mb-1"></i>\n                        <i class="fas fa-chevron-down text-xs"></i>\n                    </div>\n                </div>\n            `;t.innerHTML=s,t.addEventListener("click",(e=>{const r=t.querySelector("div").dataset.column,l="ASC"===(t.classList.contains("asc")?"ASC":t.classList.contains("desc")?"DESC":null)?"DESC":"ASC";k.querySelectorAll("th").forEach((e=>{e.classList.remove("asc","desc")})),t.classList.add(l.toLowerCase()),loadTableData(o,n,a,r,l)})),k.appendChild(t)}}));const v=document.createElement("th");v.textContent="Actions",v.className="text-center w-24",k.appendChild(v),E.appendChild(k),w.appendChild(E);const L=document.createElement("tbody");e.forEach((e=>{const t=document.createElement("tr");let n=null,a=null;r&&r.length>0&&(a=r[0],n=e[a],t.dataset.primaryKey=n,t.dataset.primaryKeyCol=a),i.forEach((n=>{if(tableColumnVisibility[o][n]){const a=document.createElement("td"),o=e[n];null===o?a.innerHTML='<span class="text-gray-400 italic">NULL</span>':r&&r.includes(n)?a.innerHTML=`<span class="font-medium text-yellow-700 dark:text-yellow-300">${o}</span>`:"number"==typeof o?(a.className="text-right",a.textContent=o):"string"==typeof o&&o.match(/^\d{4}-\d{2}-\d{2}.*$/)?(a.className="text-indigo-600 dark:text-indigo-400",a.textContent=o):"string"==typeof o&&o.length>100?a.innerHTML=`<span class="cursor-pointer text-gray-600 dark:text-gray-400" title="${o.replace(/"/g,"&quot;")}">${o.substring(0,100)}...</span>`:a.textContent=o,t.appendChild(a)}}));const l=document.createElement("td");if(l.className="whitespace-nowrap text-center",null!==n&&null!==a){const e=document.createElement("div");e.className="flex justify-center space-x-2";const t=document.createElement("button");t.className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium text-sm p-1.5 hover:bg-blue-100 dark:hover:bg-blue-900 rounded",t.innerHTML='<i class="fas fa-edit"></i>',t.title="Edit",t.onclick=function(e){e.preventDefault(),e.stopPropagation(),editRow(o,a,n)};const r=document.createElement("button");r.className="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium text-sm p-1.5 hover:bg-red-100 dark:hover:bg-red-900 rounded",r.innerHTML='<i class="fas fa-trash"></i>',r.title="Delete",r.onclick=function(e){e.preventDefault(),e.stopPropagation(),confirm(`Are you sure you want to delete this record where ${a} = ${n}?`)&&deleteRow(o,a,n)};const s=document.createElement("button");s.className="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 font-medium text-sm p-1.5 hover:bg-green-100 dark:hover:bg-green-900 rounded",s.innerHTML='<i class="fas fa-clone"></i>',s.title="Clone",s.onclick=function(e){e.preventDefault(),e.stopPropagation(),cloneRow(o,a,n)},e.appendChild(t),e.appendChild(r),e.appendChild(s),l.appendChild(e)}t.appendChild(l),L.appendChild(t)})),w.appendChild(L);const C=document.createElement("div");C.className="pagination-container mt-4 flex justify-center py-3 bg-gray-50 dark:bg-gray-800 rounded-lg",C.innerHTML=createPaginationControls(n,a,t,o),s.innerHTML="",s.appendChild(d),s.appendChild(w),Math.ceil(t/a)>1&&(s.appendChild(C),setupPaginationEvents(C,n,a,o));const q=document.createElement("div");q.className="text-xs text-gray-500 mt-2 text-right",q.textContent=`Showing records ${(n-1)*a+1} to ${Math.min(n*a,t)} of ${t}`,s.appendChild(q)}function renderQueryResult(e){const t=document.getElementById("sqlQueryResult");if(!t)return;if(!e||!e.length)return void(t.innerHTML='<div class="p-4 text-gray-500">Query executed successfully but returned no data</div>');const n=document.createElement("div");n.className="flex items-center justify-between mb-3";const a=document.createElement("h4");a.className="text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center",a.innerHTML=`\n        <span class="bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-2 py-1 rounded text-xs font-bold mr-2">\n            ${e.length}\n        </span>\n        <span>rows returned</span>\n    `;const r=document.createElement("div");r.className="flex items-center gap-2";const o=document.createElement("button");o.className="bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-medium rounded text-sm px-3 py-1.5 text-center focus:outline-none transition duration-150",o.innerHTML='<i class="fas fa-file-export mr-1"></i> Export',r.appendChild(o),n.appendChild(a),n.appendChild(r);const l=document.createElement("table");l.className="sql-adminer-table w-full text-sm text-left";const s=document.createElement("thead"),d=document.createElement("tr");Object.keys(e[0]).forEach((e=>{const t=document.createElement("th");t.textContent=e,d.appendChild(t)})),s.appendChild(d),l.appendChild(s);const i=document.createElement("tbody");e.forEach((e=>{const t=document.createElement("tr");Object.entries(e).forEach((([e,n])=>{const a=document.createElement("td");null===n?a.innerHTML='<span class="text-gray-400 italic">NULL</span>':"number"==typeof n?(a.className="text-right",a.textContent=n):"string"==typeof n&&n.match(/^\d{4}-\d{2}-\d{2}.*$/)?(a.className="text-gray-600 dark:text-gray-400",a.textContent=n):"string"==typeof n&&n.length>100?a.innerHTML=`<span class="cursor-pointer text-gray-600 dark:text-gray-400" title="${n.replace(/"/g,"&quot;")}">${n.substring(0,100)}...</span>`:a.textContent=n,t.appendChild(a)})),i.appendChild(t)})),l.appendChild(i),t.innerHTML="",t.appendChild(n),t.appendChild(l);const c=document.createElement("div");c.className="mt-2 text-xs text-gray-500 text-right",c.textContent=`Execution time: ${(new Date).toLocaleTimeString()}`,t.appendChild(c)}function renderAffectedRows(e){const t=document.getElementById("sqlQueryResult");t&&(t.innerHTML=`\n        <div class="rounded-lg bg-gray-50 dark:bg-gray-700 p-4 flex items-start border border-gray-200 dark:border-gray-600">\n            <div class="flex-shrink-0 mr-3">\n                <i class="fas fa-check-circle text-gray-600 dark:text-gray-300 text-xl"></i>\n            </div>\n            <div>\n                <h3 class="font-medium text-gray-800 dark:text-gray-200">Query executed successfully</h3>\n                <div class="mt-1 text-sm text-gray-700 dark:text-gray-300">\n                    <div class="flex items-center">\n                        <span class="font-semibold bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded mr-2">${e}</span>\n                        <span>row(s) affected</span>\n                    </div>\n                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">\n                        Execution time: ${(new Date).toLocaleTimeString()}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `)}function renderEmptyResult(){const e=document.getElementById("sqlQueryResult");e&&(e.innerHTML=`\n        <div class="rounded-lg bg-gray-50 dark:bg-gray-700 p-4 flex items-start border border-gray-200 dark:border-gray-600">\n            <div class="flex-shrink-0 mr-3">\n                <i class="fas fa-info-circle text-gray-600 dark:text-gray-300 text-xl"></i>\n            </div>\n            <div>\n                <h3 class="font-medium text-gray-800 dark:text-gray-200">Query executed successfully</h3>\n                <div class="mt-1 text-sm text-gray-700 dark:text-gray-300">\n                    The query was executed but returned no results.\n                    <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">\n                        Execution time: ${(new Date).toLocaleTimeString()}\n                    </div>\n                </div>\n            </div>\n        </div>\n    `)}function createPaginationControls(e,t,n,a){const r=Math.ceil(n/t);if(r<=1)return"";let o="";o+=`\n        <button class="pagination-button bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-l-md px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" \n            data-page="1" \n            ${1===e?'disabled style="opacity:0.5;cursor:not-allowed;"':""}>\n            <i class="fas fa-angle-double-left"></i>\n        </button>\n    `,o+=`\n        <button class="pagination-button bg-white dark:bg-gray-700 border-t border-b border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" \n            data-page="${e>1?e-1:1}" \n            ${1===e?'disabled style="opacity:0.5;cursor:not-allowed;"':""}>\n            <i class="fas fa-angle-left"></i>\n        </button>\n    `;const l=Math.floor(2.5);let s=Math.max(1,e-l),d=Math.min(r,s+5-1);d-s+1<5&&(s=Math.max(1,d-5+1)),s>1&&(o+='\n            <span class="flex items-center justify-center bg-gray-100 dark:bg-gray-800 border-t border-b border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2">\n                ...\n            </span>\n        ');for(let t=s;t<=d;t++)o+=t===e?`\n                <button class="pagination-button active bg-blue-600 border-t border-b border-blue-600 text-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" \n                    data-page="${t}">${t}</button>\n            `:`\n                <button class="pagination-button bg-white dark:bg-gray-700 border-t border-b border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" \n                    data-page="${t}">${t}</button>\n            `;return d<r&&(o+='\n            <span class="flex items-center justify-center bg-gray-100 dark:bg-gray-800 border-t border-b border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2">\n                ...\n            </span>\n        '),o+=`\n        <button class="pagination-button bg-white dark:bg-gray-700 border-t border-b border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" \n            data-page="${e<r?e+1:r}"\n            ${e===r?'disabled style="opacity:0.5;cursor:not-allowed;"':""}>\n            <i class="fas fa-angle-right"></i>\n        </button>\n    `,o+=`\n        <button class="pagination-button bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-r-md px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" \n            data-page="${r}" \n            ${e===r?'disabled style="opacity:0.5;cursor:not-allowed;"':""}>\n            <i class="fas fa-angle-double-right"></i>\n        </button>\n    `,o}function setupPaginationEvents(e,t,n,a){e.querySelectorAll(".pagination-button").forEach((e=>{e.addEventListener("click",(function(){const e=parseInt(this.dataset.page,10);e!==t&&loadTableData(a,e,n)}))}))}function enableDatabaseSection(){const e=document.getElementById("sqlDatabaseSection");e&&e.classList.remove("hidden");const t=document.getElementById("sqlGlobalSearchSection");t&&t.classList.remove("hidden");const n=document.getElementById("sqlDatabaseDisconnectBtn");n&&n.addEventListener("click",disconnectDatabase)}function enableTableSection(){const e=document.getElementById("sqlTableSection");e&&e.classList.remove("hidden")}function clearDatabaseSelect(){sqlDebugLog("Clearing database select");const e=document.getElementById("sqlDatabaseSelect");e&&(e.innerHTML='<option value="">Select a database</option>')}function clearTableSelect(){sqlDebugLog("Clearing table select");const e=document.getElementById("sqlTableList");e&&(e.innerHTML='<li class="p-2 text-sm text-gray-500 dark:text-gray-400 text-center">No tables found</li>');const t=document.getElementById("sqlTableFilter");t&&(t.value="")}function clearTableStructure(){}function clearTableData(){const e=document.getElementById("sqlTableData");e&&(e.innerHTML="")}function clearQueryResult(){const e=document.getElementById("sqlQueryResult");e&&(e.innerHTML="")}function showLoadingState(e="Loading..."){sqlDebugLog(`Showing loading state: ${e}`);const t=document.getElementById("sqlLoadingIndicator"),n=document.getElementById("sqlLoadingMessage");t?(sqlDebugLog("Found loading indicator element"),t.classList.remove("hidden")):sqlDebugLog("ERROR: Loading indicator element not found!"),n?n.textContent=e:sqlDebugLog("ERROR: Loading message element not found!")}function hideLoadingState(){sqlDebugLog("Hiding loading state");const e=document.getElementById("sqlLoadingIndicator");e?e.classList.add("hidden"):sqlDebugLog("ERROR: Loading indicator element not found!")}function editRow(e,t,n){sqlDebugLog(`Editing row: ${e}, ${t}=${n}`),showLoadingState("Loading row data...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"get_row",params:{table:e,primaryKeyCol:t,primaryKeyVal:n}}).then((a=>{hideLoadingState(),sqlDebugLog("Get row result",a),a.success&&a.row?showEditForm(e,t,n,a.row,a.columnTypes):triggerAlert("warning","Failed to load row data: "+(a.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Get row error",e),triggerAlert("warning","Error: "+e)}))}function deleteRow(e,t,n){sqlDebugLog(`Deleting row: ${e}, ${t}=${n}`),showLoadingState("Deleting row...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"delete_row",params:{table:e,primaryKeyCol:t,primaryKeyVal:n}}).then((t=>{hideLoadingState(),sqlDebugLog("Delete row result",t),t.success?(triggerAlert("success","Row deleted successfully!"),loadTableData(e)):triggerAlert("warning","Failed to delete row: "+(t.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Delete row error",e),triggerAlert("warning","Error: "+e)}))}function showEditForm(e,t,n,a,r){sqlDebugLog("Showing edit form",{table:e,primaryKeyCol:t,primaryKeyVal:n,rowData:a});const o=createModal(`Edit Record in ${e}`,"lg"),l=document.createElement("form");l.className="space-y-4",l.id="editRowForm";const s=document.createElement("div");s.className="mb-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-md text-sm text-blue-700 dark:text-blue-300",s.innerHTML=`\n        <div class="flex items-start">\n            <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mt-1 mr-2"></i>\n            <div>\n                <p>Editing record where <span class="font-semibold">${t} = ${n}</span></p>\n            </div>\n        </div>\n    `,l.appendChild(s);const d=document.createElement("div");d.className="grid grid-cols-1 gap-4",Object.keys(a).forEach((e=>{const n=a[e],o=r&&r[e]?r[e]:null,l=document.createElement("div");l.className="form-group";const s=document.createElement("label");s.className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",s.textContent=e;const i=e===t;let c;const u=o&&o.DATA_TYPE?o.DATA_TYPE:null;if(u&&("varchar"===u||"text"===u||"char"===u||"enum"===u||"set"===u||u.includes("text")||u.includes("char")))"text"===u||u.includes("text")||n&&"string"==typeof n&&n.length>100?(c=document.createElement("textarea"),c.rows=3):(c=document.createElement("input"),c.type="text");else if(u&&("int"===u||"tinyint"===u||"smallint"===u||"mediumint"===u||"bigint"===u||"decimal"===u||"float"===u||"double"===u||u.includes("int")||u.includes("decimal")||u.includes("float")||u.includes("double")))c=document.createElement("input"),c.type="number",("decimal"===u||"float"===u||"double"===u||u.includes("decimal")||u.includes("float")||u.includes("double"))&&(c.step="0.01");else if(u&&("date"===u||u.includes("date"))){if(c=document.createElement("input"),c.type="date",n){const e=n.match(/^(\d{4}-\d{2}-\d{2})/);e&&(c.value=e[1])}}else if(u&&("datetime"===u||u.includes("datetime")||"timestamp"===u)){if(c=document.createElement("input"),c.type="datetime-local",n){const e=n.match(/^(\d{4}-\d{2}-\d{2})[T\s](\d{2}:\d{2}:?\d{0,2})/);if(e){const t=e[1],a=e[2].substring(0,5);c.value=`${t}T${a}`;const r=document.createElement("span");r.className="text-xs text-gray-500 block mt-1",r.textContent=`Original value: ${n}`,setTimeout((()=>{c.parentNode&&c.parentNode.insertBefore(r,c.nextSibling)}),0)}else c.value=n}}else u&&("time"===u||u.includes("time"))?(c=document.createElement("input"),c.type="time"):(c=document.createElement("input"),c.type="text");c.name=e,c.id=`edit_${e}`,c.className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",null!==n&&"date"!==c.type&&"datetime-local"!==c.type&&(c.value=n),i&&(c.disabled=!0,c.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed");const g=document.createElement("div");g.className="mt-1 flex items-center space-x-2";const m=document.createElement("input");m.type="checkbox",m.id=`null_${e}`,m.className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",null===n&&(m.checked=!0,c.disabled=!0,c.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed");const p=document.createElement("label");p.className="text-xs text-gray-600 dark:text-gray-400",p.textContent="NULL",p.htmlFor=`null_${e}`,m.addEventListener("change",(function(){this.checked?(c.disabled=!0,c.className=c.className+" bg-gray-100 dark:bg-gray-800 cursor-not-allowed"):i||(c.disabled=!1,c.className=c.className.replace(" bg-gray-100 dark:bg-gray-800 cursor-not-allowed",""))})),g.appendChild(m),g.appendChild(p),l.appendChild(s),l.appendChild(c),i||l.appendChild(g),d.appendChild(l)})),l.appendChild(d),o.body.appendChild(l);const i=document.createElement("button");i.className="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150",i.textContent="Save Changes",i.addEventListener("click",(function(){updateRow(e,t,n,l),hideModal(o)}));const c=document.createElement("button");c.className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white",c.textContent="Cancel",c.addEventListener("click",(function(){o.close()})),o.footer.appendChild(c),o.footer.appendChild(i)}function updateRow(e,t,n,a){sqlDebugLog("Updating row",{table:e,primaryKeyCol:t,primaryKeyVal:n}),showLoadingState("Updating row...");const r={csrf:getCsrfToken(),action:"sql_explorer",sql_action:"update_row",params:{table:e,primaryKeyCol:t,primaryKeyVal:n,updates:{}}},o=new FormData(a);for(const[e,n]of o.entries()){if(e.startsWith("null_"))continue;const o=e.startsWith("edit_")?e.substring(5):e;if(o===t)continue;const l=a.querySelector(`#null_${o}`);if(l&&l.checked){r.params.updates[o]=null;continue}const s=a.elements[e];if(s&&"datetime-local"===s.type&&n){const e=new Date(n);if(!isNaN(e.getTime())){const t=e.toISOString().slice(0,19).replace("T"," ");r.params.updates[o]=t;continue}}""===n?s&&s.placeholder&&s.placeholder.toLowerCase().includes("null")?r.params.updates[o]=null:r.params.updates[o]="":r.params.updates[o]=n}sqlDebugLog("Update data",r.params.updates),sqlSendRequest(r).then((t=>{hideLoadingState(),sqlDebugLog("Update row result",t),t.success?(triggerAlert("success","Row updated successfully!"),loadTableData(e)):triggerAlert("warning","Failed to update row: "+(t.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Update row error",e),triggerAlert("warning","Error: "+e)}))}function showAddRowForm(e){sqlDebugLog("Showing add row form",{table:e}),showLoadingState("Loading table structure...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"structure",params:{table:e}}).then((t=>{if(hideLoadingState(),sqlDebugLog("Get table structure for new row",t),!t.success||!t.columns)return void triggerAlert("warning","Failed to get table structure: "+(t.error||"Unknown error"));sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"column_types",params:{table:e}}).then((n=>{const a=n.success?n.columnTypes:{};createAddRowForm(e,t.columns,a)})).catch((n=>{sqlDebugLog("Get column types error",n),createAddRowForm(e,t.columns,{})}))})).catch((e=>{hideLoadingState(),sqlDebugLog("Get table structure error",e),triggerAlert("warning","Error: "+e)}))}function createAddRowForm(e,t,n){const a=createModal("Add New Row","lg");document.body.appendChild(a),a.classList.add("show"),a.style.display="block",a.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open");const r=a.querySelector(".modal-body"),o=document.createElement("form");o.id="addRowForm",o.className="space-y-4",t.forEach((e=>{const t=e.Field,a=n[t]||null,r="PRI"===e.Key,l=e.Extra.includes("auto_increment"),s="YES"===e.Null,d=document.createElement("div");d.className="flex flex-col mb-4";const i=document.createElement("label");i.htmlFor=`new_${t}`,i.className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1";let c,u=t;if(r&&(u+=" (Primary Key)"),s||l||(u+=" *"),l&&(u+=" (Auto Increment)"),i.textContent=u,l){i.className+=" text-gray-400",d.appendChild(i);const e=document.createElement("span");return e.className="text-sm italic text-gray-500 dark:text-gray-400",e.textContent="Value will be generated automatically",d.appendChild(e),void o.appendChild(d)}if(a&&a.DATA_TYPE){const t=a.DATA_TYPE.toLowerCase();if(["text","longtext","mediumtext"].includes(t))c=document.createElement("textarea"),c.rows=4;else if("date"===t)c=document.createElement("input"),c.type="date";else if("time"===t)c=document.createElement("input"),c.type="time";else if("datetime"===t||"timestamp"===t)c=document.createElement("input"),c.type="datetime-local";else if("tinyint"===t&&"tinyint(1)"===e.Type){c=document.createElement("select");const e=document.createElement("option");e.value="",e.textContent="NULL",c.appendChild(e);const t=document.createElement("option");t.value="1",t.textContent="TRUE (1)",c.appendChild(t);const n=document.createElement("option");n.value="0",n.textContent="FALSE (0)",c.appendChild(n)}else c=document.createElement("input"),c.type="text",["int","tinyint","smallint","mediumint","bigint","decimal","float","double"].includes(t)&&(c.pattern="[0-9.\\-]*")}else c=document.createElement("input"),c.type="text";c.id=`new_${t}`,c.name=`new_${t}`,c.className="border rounded-lg p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white",s&&(c.placeholder="NULL (leave empty)"),null!==e.Default&&(c.value=e.Default),d.appendChild(i),d.appendChild(c),o.appendChild(d)}));const l=document.createElement("div");l.className="mt-4 flex justify-end space-x-2";const s=document.createElement("button");s.type="submit",s.className="bg-blue-500 hover:bg-blue-600 text-white font-medium rounded text-sm px-4 py-2 text-center focus:outline-none transition duration-150",s.textContent="Add Row";const d=document.createElement("button");d.type="button",d.className="bg-gray-500 hover:bg-gray-600 text-white font-medium rounded text-sm px-4 py-2 text-center focus:outline-none transition duration-150",d.textContent="Cancel",l.appendChild(s),l.appendChild(d),o.appendChild(l),r.appendChild(o),o.addEventListener("submit",(function(t){t.preventDefault(),addRow(e,o),hideModal(a)})),d.addEventListener("click",(function(){hideModal(a)}))}function createModal(e,t="md"){const n=document.createElement("div");n.className="modal-wrapper fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";let a="max-w-md";"sm"===t&&(a="max-w-sm"),"lg"===t&&(a="max-w-lg"),"xl"===t&&(a="max-w-xl"),"2xl"===t&&(a="max-w-2xl"),"3xl"===t&&(a="max-w-3xl"),"4xl"===t&&(a="max-w-4xl"),"5xl"===t&&(a="max-w-5xl");const r=document.createElement("div");r.className=`relative w-full ${a} mx-auto`;const o=document.createElement("div");o.className="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700";const l=document.createElement("div");l.className="bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-3 text-white flex justify-between items-center";const s=document.createElement("h3");s.className="text-lg font-semibold",s.textContent=e;const d=document.createElement("button");d.className="text-white hover:text-gray-200 focus:outline-none transition duration-150",d.innerHTML='<i class="fas fa-times"></i>',d.addEventListener("click",(function(){hideModal(n)})),l.appendChild(s),l.appendChild(d);const i=document.createElement("div");i.className="p-4";const c=document.createElement("div");c.className="bg-gray-50 dark:bg-gray-700 px-4 py-3 flex justify-end space-x-2 border-t border-gray-200 dark:border-gray-600",o.appendChild(l),o.appendChild(i),o.appendChild(c),r.appendChild(o),n.appendChild(r),document.body.appendChild(n),setTimeout((()=>{n.classList.add("visible")}),10);const u=function(e){"Escape"===e.key&&(hideModal(n),document.removeEventListener("keydown",u))};return document.addEventListener("keydown",u),{wrapper:n,container:r,content:o,header:l,title:s,body:i,footer:c,close:()=>hideModal(n)}}function hideModal(e){"object"==typeof e&&e.wrapper&&(e=e.wrapper),e&&(e.classList.remove("visible"),setTimeout((()=>{try{document.body.removeChild(e)}catch(e){}}),200))}function addRow(e,t){sqlDebugLog("Adding new row",{table:e}),showLoadingState("Adding new row...");const n={csrf:getCsrfToken(),action:"sql_explorer",sql_action:"add_row",params:{table:e,new_row:{}}},a=new FormData(t);for(const[e,t]of a.entries())e.startsWith("new_")&&(n.params.new_row[e.substring(4)]=t);sqlSendRequest(n).then((t=>{hideLoadingState(),sqlDebugLog("Add row result",t),t.success?(triggerAlert("success","Row added successfully!"),loadTableData(e)):triggerAlert("warning","Failed to add row: "+(t.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Add row error",e),triggerAlert("warning","Error: "+e)}))}function showColumnManager(e,t){sqlDebugLog("Showing column manager",{table:e,columns:t});const n=createModal(`Manage Columns for ${e}`,"lg"),a=document.createElement("p");a.className="text-sm text-gray-600 dark:text-gray-400 mb-4",a.textContent="Select which columns to display in the table data view.",n.body.appendChild(a);const r=document.createElement("form");r.className="space-y-2";const o=document.createElement("div");o.className="flex justify-between items-center mb-3 pb-2 border-b border-gray-200 dark:border-gray-700";const l=document.createElement("span");l.className="text-sm font-medium text-gray-700 dark:text-gray-300",l.textContent="Toggle all columns";const s=document.createElement("div");s.className="flex space-x-2";const d=document.createElement("button");d.type="button",d.className="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded",d.textContent="Select All",d.addEventListener("click",(function(e){e.preventDefault(),r.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!0}))}));const i=document.createElement("button");i.type="button",i.className="text-xs bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded",i.textContent="Deselect All",i.addEventListener("click",(function(e){e.preventDefault(),r.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!1}))})),s.appendChild(d),s.appendChild(i),o.appendChild(l),o.appendChild(s),r.appendChild(o);const c=document.createElement("div");c.className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-80 overflow-y-auto p-2",t.forEach((t=>{const n=document.createElement("div");n.className="flex items-center p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700";const a=document.createElement("input");a.type="checkbox",a.id=`col_${t}`,a.name=`col_${t}`,a.value=t,a.className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",tableColumnVisibility[e]&&!tableColumnVisibility[e][t]||(a.checked=!0);const r=document.createElement("label");r.htmlFor=`col_${t}`,r.className="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium",r.textContent=t,n.appendChild(a),n.appendChild(r),c.appendChild(n)})),r.appendChild(c),n.body.appendChild(r);const u=document.createElement("button");u.className="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150",u.textContent="Apply",u.addEventListener("click",(function(){tableColumnVisibility[e]||(tableColumnVisibility[e]={}),t.forEach((t=>{const n=document.getElementById(`col_${t}`);tableColumnVisibility[e][t]=n.checked}));const a=document.getElementById("sqlTableSelect");a&&a.value&&(n.close(),loadTableData(a.value))}));const g=document.createElement("button");g.className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white",g.textContent="Cancel",g.addEventListener("click",(function(){n.close()})),n.footer.appendChild(g),n.footer.appendChild(u)}function exportTableAsSql(){sqlDebugLog("Exporting table as SQL");const e=document.getElementById("sqlTableList"),t=e?e.querySelector(".bg-indigo-50, .dark\\:bg-indigo-900"):null;if(!t)return void triggerAlert("warning","Please select a table to export");const n=t.dataset.tableName,a=document.getElementById("exportIncludeStructure").checked,r=document.getElementById("exportIncludeData").checked,o=document.getElementById("exportAddDropTable").checked;if(!a&&!r)return void triggerAlert("warning","Please select at least one export option (structure or data)");showLoadingState(`Exporting table ${n} as SQL...`);sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"export_sql",params:{table:n,includeStructure:a,includeData:r,addDropTable:o}}).then((e=>{hideLoadingState(),sqlDebugLog("SQL export result",e),e.success&&e.sql?(downloadFile(e.sql,e.filename,"text/plain"),triggerAlert("success",`Table ${n} exported as SQL successfully!`)):triggerAlert("warning","Failed to export table: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("SQL export error",e),triggerAlert("warning","Error: "+e)}))}function exportTableAsCsv(){sqlDebugLog("Exporting table as CSV");const e=document.getElementById("sqlTableList"),t=e?e.querySelector(".bg-indigo-50, .dark\\:bg-indigo-900"):null;if(!t)return void triggerAlert("warning","Please select a table to export");const n=t.dataset.tableName;showLoadingState(`Exporting table ${n} as CSV...`);sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"export_csv",params:{table:n}}).then((e=>{hideLoadingState(),sqlDebugLog("CSV export result",e),e.success&&e.csv?(downloadFile(e.csv,e.filename,"text/csv"),triggerAlert("success",`Table ${n} exported as CSV successfully!`)):triggerAlert("warning","Failed to export table: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("CSV export error",e),triggerAlert("warning","Error: "+e)}))}function exportDatabaseAsZip(){sqlDebugLog("Exporting database as ZIP");const e=document.getElementById("exportIncludeStructure").checked,t=document.getElementById("exportIncludeData").checked,n=document.getElementById("exportAddDropTable").checked,a=document.getElementById("exportCompressed").checked;if(!e&&!t)return void triggerAlert("warning","Please select at least one export option (structure or data)");const r=document.getElementById("sqlDatabaseSelect");if(!r||!r.value)return void triggerAlert("warning","Please select a database first");showLoadingState(`Exporting database ${r.value} as ZIP...`);sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"export_zip",params:{includeStructure:e,includeData:t,addDropTable:n,compressed:a}}).then((e=>{if(hideLoadingState(),sqlDebugLog("ZIP export result",{success:e.success,filename:e.filename}),e.success&&e.zip){downloadBinaryFile(base64ToArrayBuffer(e.zip),e.filename,"application/zip"),triggerAlert("success","Database exported as ZIP successfully!")}else triggerAlert("warning","Failed to export database: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("ZIP export error",e),triggerAlert("warning","Error: "+e)}))}function downloadBinaryFile(e,t,n){const a=new Blob([e],{type:n}),r=URL.createObjectURL(a),o=document.createElement("a");o.href=r,o.download=t,o.style.display="none",document.body.appendChild(o),o.click(),setTimeout((()=>{document.body.removeChild(o),URL.revokeObjectURL(r)}),100)}function base64ToArrayBuffer(e){const t=window.atob(e),n=t.length,a=new Uint8Array(n);for(let e=0;e<n;e++)a[e]=t.charCodeAt(e);return a.buffer}function cloneRow(e,t,n){sqlDebugLog(`Cloning row: ${e}, ${t}=${n}`),showLoadingState("Loading row data for cloning...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"get_row",params:{table:e,primaryKeyCol:t,primaryKeyVal:n}}).then((n=>{hideLoadingState(),sqlDebugLog("Get row for cloning result",n),n.success&&n.row?showCloneForm(e,n.row,n.columnTypes,t):triggerAlert("warning","Failed to load row data for cloning: "+(n.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Get row for cloning error",e),triggerAlert("warning","Error: "+e)}))}function showCloneForm(e,t,n,a){sqlDebugLog("Showing clone form",{table:e,rowData:t});const r=createModal(`Clone Record in ${e}`,"lg"),o=document.createElement("form");o.className="space-y-4",o.id="cloneRowForm",o.dataset.primaryKeyCol=a;const l=document.createElement("div");l.className="mb-4 p-3 bg-green-50 dark:bg-green-900 rounded-md text-sm text-green-700 dark:text-green-300",l.innerHTML='\n        <div class="flex items-start">\n            <i class="fas fa-info-circle text-green-600 dark:text-green-400 mt-1 mr-2"></i>\n            <div>\n                <p>Creating a new record based on an existing one. Modify values as needed.</p>\n                <p class="mt-1 font-medium">Note: Primary key fields will be auto-generated.</p>\n            </div>\n        </div>\n    ',o.appendChild(l);const s=document.createElement("div");s.className="grid grid-cols-1 gap-4",Object.keys(t).forEach((e=>{const r=t[e],o=n&&n[e]?n[e]:null,l=document.createElement("div");l.className="form-group";const d=e===a,i=o&&o.EXTRA&&o.EXTRA.includes("auto_increment");d&&(l.className+=" primary-key-field",l.dataset.primaryKey="true");const c=document.createElement("label");let u;c.className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 flex items-center justify-between",d?c.innerHTML=`\n                ${e}\n                <span class="text-xs bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 px-2 py-0.5 rounded">\n                    Primary Key\n                </span>\n            `:c.textContent=e;const g=o&&o.DATA_TYPE?o.DATA_TYPE:null;if(g&&("varchar"===g||"text"===g||"char"===g||"enum"===g||"set"===g||g.includes("text")||g.includes("char")))"text"===g||g.includes("text")||r&&"string"==typeof r&&r.length>100?(u=document.createElement("textarea"),u.rows=3):(u=document.createElement("input"),u.type="text");else if(g&&("int"===g||"tinyint"===g||"smallint"===g||"mediumint"===g||"bigint"===g||"decimal"===g||"float"===g||"double"===g||g.includes("int")||g.includes("decimal")||g.includes("float")||g.includes("double")))u=document.createElement("input"),u.type="number",("decimal"===g||"float"===g||"double"===g||g.includes("decimal")||g.includes("float")||g.includes("double"))&&(u.step="0.01");else if(g&&("date"===g||g.includes("date"))){if(u=document.createElement("input"),u.type="date",r){const e=r.match(/^(\d{4}-\d{2}-\d{2})/);e&&(u.value=e[1])}}else if(g&&("datetime"===g||g.includes("datetime")||"timestamp"===g)){if(u=document.createElement("input"),u.type="datetime-local",r){const e=r.match(/^(\d{4}-\d{2}-\d{2})[T\s](\d{2}:\d{2}:?\d{0,2})/);if(e){const t=e[1],n=e[2].substring(0,5);u.value=`${t}T${n}`}}}else u=document.createElement("input"),u.type="text";if(u.name=`new_${e}`,u.id=`clone_${e}`,u.className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",null!==r&&"date"!==u.type&&"datetime-local"!==u.type)if(d){u.value="",u.disabled=!0,u.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed",u.placeholder="Auto-generated";const t=document.createElement("input");t.type="hidden",t.name=`is_primary_key_${e}`,t.value="true",l.appendChild(t)}else u.value=r;const m=document.createElement("div");m.className="mt-1 flex items-center space-x-2";const p=document.createElement("input");p.type="checkbox",p.id=`null_${e}`,p.className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",null===r&&(p.checked=!0,u.disabled=!0,u.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed");const b=document.createElement("label");if(b.className="text-xs text-gray-600 dark:text-gray-400",b.textContent="NULL",b.htmlFor=`null_${e}`,p.addEventListener("change",(function(){this.checked?(u.disabled=!0,u.className=u.className+" bg-gray-100 dark:bg-gray-800 cursor-not-allowed"):d||(u.disabled=!1,u.className=u.className.replace(" bg-gray-100 dark:bg-gray-800 cursor-not-allowed",""))})),m.appendChild(p),m.appendChild(b),l.appendChild(c),l.appendChild(u),o&&"YES"===o.IS_NULLABLE&&!d&&l.appendChild(m),i){const e=document.createElement("div");e.className="text-xs text-gray-500 mt-1",e.textContent="Auto-increment field (value will be generated automatically)",l.appendChild(e)}s.appendChild(l)})),o.appendChild(s),r.body.appendChild(o);const d=document.createElement("button");d.className="bg-green-600 hover:bg-green-700 text-white font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150",d.textContent="Create Clone",d.addEventListener("click",(function(){addClonedRow(e,o),hideModal(r)}));const i=document.createElement("button");i.className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white",i.textContent="Cancel",i.addEventListener("click",(function(){r.close()})),r.footer.appendChild(i),r.footer.appendChild(d)}function addClonedRow(e,t){sqlDebugLog("Adding cloned row",{table:e}),showLoadingState("Creating cloned record...");const n={csrf:getCsrfToken(),action:"sql_explorer",sql_action:"add_row",params:{table:e,new_row:{}}},a=t.dataset.primaryKeyCol||"",r=new FormData(t);for(const[e,o]of r.entries()){if(e.startsWith("null_")||e.startsWith("is_primary_key_"))continue;let r=e;if(r.startsWith("clone_")?r=r.substring(6):r.startsWith("new_")&&(r=r.substring(4)),r===a)continue;if(t.querySelector(`input[name="is_primary_key_${r}"]`))continue;const l=t.querySelector(`#null_${r}`);if(l&&l.checked){n.params.new_row[r]=null;continue}const s=t.elements[e];if(s&&"datetime-local"===s.type&&o){const e=new Date(o);if(!isNaN(e.getTime())){const t=e.toISOString().slice(0,19).replace("T"," ");n.params.new_row[r]=t;continue}}(""!==o||!e.includes("_id")&&r!==a)&&(s&&s.disabled||(n.params.new_row[r]=o))}sqlDebugLog("Cloned row data",n.params.new_row),sqlSendRequest(n).then((t=>{hideLoadingState(),sqlDebugLog("Add cloned row result",t),t.success?(triggerAlert("success","Record cloned successfully!"),loadTableData(e)):triggerAlert("warning","Failed to clone record: "+(t.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Add cloned row error",e),triggerAlert("warning","Error: "+e)}))}function showEditForm(e,t,n,a,r){sqlDebugLog("Showing edit form",{table:e,primaryKeyCol:t,primaryKeyVal:n,rowData:a});const o=createModal(`Edit Record in ${e}`,"lg"),l=document.createElement("form");l.className="space-y-4",l.id="editRowForm";const s=document.createElement("div");s.className="mb-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-md text-sm text-blue-700 dark:text-blue-300",s.innerHTML=`\n        <div class="flex items-start">\n            <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 mt-1 mr-2"></i>\n            <div>\n                <p>Editing record where <span class="font-semibold">${t} = ${n}</span></p>\n            </div>\n        </div>\n    `,l.appendChild(s);const d=document.createElement("div");d.className="grid grid-cols-1 gap-4",Object.keys(a).forEach((e=>{const n=a[e],o=r&&r[e]?r[e]:null,l=document.createElement("div");l.className="form-group";const s=document.createElement("label");s.className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",s.textContent=e;const i=e===t;let c;const u=o&&o.DATA_TYPE?o.DATA_TYPE:null;if(u&&("varchar"===u||"text"===u||"char"===u||"enum"===u||"set"===u||u.includes("text")||u.includes("char")))"text"===u||u.includes("text")||n&&"string"==typeof n&&n.length>100?(c=document.createElement("textarea"),c.rows=3):(c=document.createElement("input"),c.type="text");else if(u&&("int"===u||"tinyint"===u||"smallint"===u||"mediumint"===u||"bigint"===u||"decimal"===u||"float"===u||"double"===u||u.includes("int")||u.includes("decimal")||u.includes("float")||u.includes("double")))c=document.createElement("input"),c.type="number",("decimal"===u||"float"===u||"double"===u||u.includes("decimal")||u.includes("float")||u.includes("double"))&&(c.step="0.01");else if(u&&("date"===u||u.includes("date"))){if(c=document.createElement("input"),c.type="date",n){const e=n.match(/^(\d{4}-\d{2}-\d{2})/);e&&(c.value=e[1])}}else if(u&&("datetime"===u||u.includes("datetime")||"timestamp"===u)){if(c=document.createElement("input"),c.type="datetime-local",n){const e=n.match(/^(\d{4}-\d{2}-\d{2})[T\s](\d{2}:\d{2}:?\d{0,2})/);if(e){const t=e[1],a=e[2].substring(0,5);c.value=`${t}T${a}`;const r=document.createElement("span");r.className="text-xs text-gray-500 block mt-1",r.textContent=`Original value: ${n}`,setTimeout((()=>{c.parentNode&&c.parentNode.insertBefore(r,c.nextSibling)}),0)}else c.value=n}}else u&&("time"===u||u.includes("time"))?(c=document.createElement("input"),c.type="time"):(c=document.createElement("input"),c.type="text");c.name=e,c.id=`edit_${e}`,c.className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white",null!==n&&"date"!==c.type&&"datetime-local"!==c.type&&(c.value=n),i&&(c.disabled=!0,c.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed");const g=document.createElement("div");g.className="mt-1 flex items-center space-x-2";const m=document.createElement("input");m.type="checkbox",m.id=`null_${e}`,m.className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded",null===n&&(m.checked=!0,c.disabled=!0,c.className+=" bg-gray-100 dark:bg-gray-800 cursor-not-allowed");const p=document.createElement("label");p.className="text-xs text-gray-600 dark:text-gray-400",p.textContent="NULL",p.htmlFor=`null_${e}`,m.addEventListener("change",(function(){this.checked?(c.disabled=!0,c.className=c.className+" bg-gray-100 dark:bg-gray-800 cursor-not-allowed"):i||(c.disabled=!1,c.className=c.className.replace(" bg-gray-100 dark:bg-gray-800 cursor-not-allowed",""))})),g.appendChild(m),g.appendChild(p),l.appendChild(s),l.appendChild(c),i||l.appendChild(g),d.appendChild(l)})),l.appendChild(d),o.body.appendChild(l);const i=document.createElement("button");i.className="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150",i.textContent="Save Changes",i.addEventListener("click",(function(){updateRow(e,t,n,l),hideModal(o)}));const c=document.createElement("button");c.className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded text-sm px-5 py-2.5 text-center focus:outline-none transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white",c.textContent="Cancel",c.addEventListener("click",(function(){o.close()})),o.footer.appendChild(c),o.footer.appendChild(i)}function searchTableAllColumns(e,t){sqlDebugLog(`Searching in all columns of table ${e} for: ${t}`),loadTableData(e,1,50,null,"ASC",t)}function globalDatabaseSearch(e,t=10){if(sqlDebugLog(`Performing global database search for: ${e}`),!e.trim())return void triggerAlert("warning","Please enter a search term");showLoadingState("Searching all databases...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"global_search",params:{searchQuery:e,limit:t}}).then((t=>{hideLoadingState(),t.success?renderGlobalSearchResults(e,t.results):triggerAlert("warning","Search failed: "+(t.error||"Unknown error"))})).catch((e=>{hideLoadingState(),triggerAlert("warning","Error: "+e)}))}function renderGlobalSearchResults(e,t){const n=document.getElementById("sqlQueryResult");if(!n)return void triggerAlert("warning","Results container not found");clearQueryResult();let a=0,r=0,o=0;if(Object.keys(t).forEach((e=>{a++,Object.keys(t[e]).forEach((n=>{r++,o+=t[e][n].total_matches}))})),0===o)return void(n.innerHTML=`\n            <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">\n                <div class="flex items-center mb-4">\n                    <div class="h-10 w-10 flex items-center justify-center bg-yellow-100 dark:bg-yellow-900 rounded-full text-yellow-500 dark:text-yellow-300">\n                        <i class="fas fa-search fa-lg"></i>\n                    </div>\n                    <div class="ml-4">\n                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">No results found</h3>\n                        <p class="text-sm text-gray-600 dark:text-gray-300">Your search for "${e}" did not match any content</p>\n                    </div>\n                </div>\n            </div>\n        `);const l=document.createElement("div");l.className="global-search-results space-y-6";const s=document.createElement("div");s.className="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg",s.innerHTML=`\n        <div class="flex items-center">\n            <div class="h-10 w-10 flex items-center justify-center bg-indigo-100 dark:bg-indigo-800 rounded-full text-indigo-500 dark:text-indigo-300">\n                <i class="fas fa-search fa-lg"></i>\n            </div>\n            <div class="ml-4">\n                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Search Results</h3>\n                <p class="text-sm text-gray-600 dark:text-gray-300">\n                    Found <span class="font-semibold">${o}</span> matches for "<span class="font-semibold">${e}</span>"\n                    in <span class="font-semibold">${r}</span> tables across <span class="font-semibold">${a}</span> databases\n                </p>\n            </div>\n        </div>\n    `,l.appendChild(s),Object.keys(t).forEach((n=>{const a=t[n],r=document.createElement("div");r.className="database-card border dark:border-gray-700 rounded-lg overflow-hidden";const o=Object.keys(a).length;let s=0;Object.keys(a).forEach((e=>{s+=a[e].total_matches}));const d=document.createElement("div");d.className="database-header bg-gray-100 dark:bg-gray-800 px-4 py-3 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",d.innerHTML=`\n            <div class="flex justify-between items-center">\n                <div class="flex items-center">\n                    <i class="fas fa-database mr-2 text-indigo-500"></i>\n                    <h4 class="font-semibold text-gray-900 dark:text-white">${n}</h4>\n                </div>\n                <div class="flex items-center">\n                    <span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 text-xs font-semibold px-2.5 py-0.5 rounded mr-2">\n                        ${o} tables\n                    </span>\n                    <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-semibold px-2.5 py-0.5 rounded">\n                        ${s} matches\n                    </span>\n                    <i class="fas fa-chevron-down ml-3 transform transition-transform duration-200"></i>\n                </div>\n            </div>\n        `,d.addEventListener("click",(()=>{const e=d.nextElementSibling,t=d.querySelector(".fa-chevron-down");e.style.maxHeight?(e.style.maxHeight=null,t.classList.remove("rotate-180")):(e.style.maxHeight=e.scrollHeight+"px",t.classList.add("rotate-180"))}));const i=document.createElement("div");i.className="database-content overflow-hidden transition-all duration-300",i.style.maxHeight="0",Object.keys(a).forEach((t=>{const r=a[t],o=r.matches,l=r.total_matches,s=r.has_more,d=document.createElement("div");d.className="table-section border-t dark:border-gray-700";const c=document.createElement("div");c.className="table-header bg-gray-50 dark:bg-gray-900 px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800",c.innerHTML=`\n                <div class="flex justify-between items-center">\n                    <div class="flex items-center">\n                        <i class="fas fa-table mr-2 text-blue-500"></i>\n                        <h5 class="font-medium text-gray-800 dark:text-gray-200">${t}</h5>\n                    </div>\n                    <div class="flex items-center">\n                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-semibold px-2.5 py-0.5 rounded">\n                            ${l} matches\n                        </span>\n                        <i class="fas fa-chevron-down ml-3 transform transition-transform duration-200"></i>\n                    </div>\n                </div>\n            `,c.addEventListener("click",(()=>{const e=c.nextElementSibling,t=c.querySelector(".fa-chevron-down");e.style.maxHeight?(e.style.maxHeight=null,t.classList.remove("rotate-180")):(e.style.maxHeight=e.scrollHeight+"px",t.classList.add("rotate-180"))}));const u=document.createElement("div");u.className="table-content overflow-hidden transition-all duration-300",u.style.maxHeight="0";const g=document.createElement("div");g.className="matches-container overflow-x-auto";const m=document.createElement("table");m.className="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm";const p=document.createElement("thead"),b=document.createElement("tr"),y=r.columns;y.forEach((e=>{const t=document.createElement("th");t.className="px-4 py-2 bg-gray-50 dark:bg-gray-800 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",t.textContent=e,b.appendChild(t)})),p.appendChild(b),m.appendChild(p);const f=document.createElement("tbody");if(f.className="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-800",o.forEach(((t,n)=>{const a=document.createElement("tr");a.className=n%2==0?"bg-white dark:bg-gray-900":"bg-gray-50 dark:bg-gray-800",y.forEach((n=>{const r=document.createElement("td");r.className="px-4 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400";const o=t.row[n];if(t.matching_columns.includes(n)&&null!==o&&"string"==typeof o){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp("("+t+")","gi");r.innerHTML=o.replace(n,'<span class="bg-yellow-200 dark:bg-yellow-700">$1</span>')}else r.textContent=null===o?"NULL":o;a.appendChild(r)})),f.appendChild(a)})),m.appendChild(f),g.appendChild(m),s){const e=document.createElement("div");e.className="p-2 text-center text-sm text-gray-500 dark:text-gray-400 italic",e.textContent=`Showing ${o.length} of ${l} matches`,g.appendChild(e)}const x=document.createElement("div");x.className="p-3 text-center border-t dark:border-gray-700",x.innerHTML='\n                <button class="view-table-btn text-sm font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">\n                    <i class="fas fa-external-link-alt mr-1"></i> View full table\n                </button>\n            ',x.querySelector(".view-table-btn").addEventListener("click",(()=>{selectDatabase(n),setTimeout((()=>{const e=document.querySelectorAll(".table-item");for(let n=0;n<e.length;n++)if(e[n].dataset.tableName===t){e[n].click();break}}),500)})),u.appendChild(g),u.appendChild(x),d.appendChild(c),d.appendChild(u),i.appendChild(d)})),r.appendChild(d),r.appendChild(i),l.appendChild(r)})),n.appendChild(l)}function exportAllDatabasesAsZip(){sqlDebugLog("Exporting all databases as ZIP"),showLoadingState("Exporting all databases...");const e=document.getElementById("exportIncludeStructure")?.checked??!0,t=document.getElementById("exportIncludeData")?.checked??!0,n=document.getElementById("exportAddDropTable")?.checked??!0,a=document.getElementById("exportCompressed")?.checked??!0;sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"export_all_databases_zip",params:{includeStructure:e,includeData:t,addDropTable:n,compressed:a}}).then((e=>{if(hideLoadingState(),sqlDebugLog("Export all databases result",e),e.success&&e.zip){triggerAlert("success",`All databases exported successfully (${formatFileSize(e.filesize)})`);downloadBinaryFile(base64ToArrayBuffer(e.zip),e.filename,"application/zip")}else triggerAlert("warning","Failed to export databases: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Export all databases error",e),triggerAlert("warning","Error: "+e)}))}function backupAllDatabasesToTelegram(){sqlDebugLog("Backing up all databases to Telegram"),Swal.fire({title:"Backup All Databases to Telegram",text:"This will export all databases, encrypt them with a random password, and send them to your configured Telegram bot. The password will be included in the message. Continue?",icon:"question",showCancelButton:!0,confirmButtonText:"Backup",confirmButtonColor:"#3085d6",cancelButtonText:"Cancel",cancelButtonColor:"#d33",customClass:{popup:"dark:bg-gray-800 dark:text-white"}}).then((e=>{if(e.isConfirmed){showLoadingState("Preparing database backup for Telegram...");sqlSendRequest({csrf:getCsrfToken(),action:"sql_explorer",sql_action:"backup_all_databases_telegram",params:{includeStructure:!0,includeData:!0,addDropTable:!0,compressed:!0}}).then((e=>{hideLoadingState(),sqlDebugLog("Backup to Telegram result",e),e.success?Swal.fire({title:"Backup Successful",html:`\n                                <div class="text-left">\n                                    <p>All databases have been backed up to Telegram successfully.</p>\n                                    <p class="mt-3 mb-1"><strong>Backup details:</strong></p>\n                                    <ul class="list-disc pl-5">\n                                        <li>Size: ${formatFileSize(e.filesize||0)}</li>\n                                        <li>Encrypted with password: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">${e.password||"N/A"}</code></li>\n                                    </ul>\n                                    <p class="mt-3 text-yellow-600 dark:text-yellow-400">\n                                        <i class="fas fa-exclamation-triangle mr-1"></i> \n                                        Save this password in a secure location! It's required to decrypt the backup.\n                                    </p>\n                                </div>\n                            `,icon:"success",customClass:{popup:"dark:bg-gray-800 dark:text-white"}}):triggerAlert("warning","Failed to backup databases to Telegram: "+(e.error||"Unknown error"))})).catch((e=>{hideLoadingState(),sqlDebugLog("Backup to Telegram error",e),triggerAlert("warning","Error during backup: "+e)}))}}))}function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}
