function initializeFileManager(e,t,n,a){const r="1"===n?a:"null";document.addEventListener("click",(function(a){if(a.target.classList.contains("fa-edit")){renameFile(a.target.dataset.file,e,t,r,n)}})),document.addEventListener("click",(function(a){if(a.target.classList.contains("fa-trash-alt")){const o=a.target.dataset.file;o&&deleteFile(o,e,t,r,n)}})),document.addEventListener("click",(function(a){if(a.target.classList.contains("directory-link")){a.preventDefault();const o=a.target.dataset.path;if(o&&o!==t){t=o;let a=document.getElementById("itemLimit"),i=a?a.value:"50";loadDirectory(t,1,e,r,n,i)}}})),document.addEventListener("click",(function(e){const t=e.target.closest("td");if(!t)return;if("INPUT"===e.target.tagName||"A"===e.target.tagName||"BUTTON"===e.target.tagName||"I"===e.target.tagName||"TH"===e.target.tagName)return;if(t.closest("thead")||!t.closest("#fileList"))return;const n=t.closest("tr");if(!n)return;const a=n.querySelector(".file-checkbox");a&&(a.checked=!a.checked,a.dataset.file&&(updateSelectedFiles(a.dataset.file,a.checked),a.checked?n.classList.add("bg-blue-50","dark:bg-blue-900/20"):n.classList.remove("bg-blue-50","dark:bg-blue-900/20")))})),loadDirectory(t,1,e,r,n)}function sendRequest(e,t,n){if(!e.csrf)throw new Error("CSRF token is missing.");const a=JSON.stringify(e);let r=t;"1"===n&&"string"==typeof t&&(r=CryptoJS.enc.Utf8.parse(t));const o="1"===n?encrypt(a,r):a;return new Promise(((e,t)=>{$.post("",o).done((a=>{try{let o,i=a;if("1"===n)try{i=decrypt(a,r)}catch(e){}if(""===i)return void e("");try{o=JSON.parse(i)}catch(t){return void e(i)}o&&o.error?t(new Error(o.error)):e(o)}catch(e){t(new Error("Failed to process server response.")),triggerAlert("warning","Failed to process server response")}})).fail(((e,n,a)=>{t(new Error(`Network error: ${n} - ${a||e.status}`)),triggerAlert("warning",`Request failed: ${n} ${a||""}`)}))}))}function showDialog(e,t,n,a,r){const o=document.documentElement.classList.contains("dark");Swal.fire({title:e,input:"text",inputLabel:t,inputValue:a,showCancelButton:!0,confirmButtonText:n,cancelButtonText:"Cancel",customClass:{popup:o?"bg-gray-900 text-white":"bg-white text-gray-900",confirmButton:o?"bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded":"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded",cancelButton:o?"bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded":"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded",input:o?"bg-gray-800 text-white border-gray-700":"bg-white text-gray-900 border-gray-300"}}).then((e=>{if(e.isConfirmed){const t=e.value.trim();r(t)}}))}function showConfirmation(e,t,n,a){const r=document.documentElement.classList.contains("dark");Swal.fire({title:e,text:t,icon:"warning",showCancelButton:!0,confirmButtonText:n,cancelButtonText:"Cancel",customClass:{popup:r?"bg-gray-900 text-white":"bg-white text-gray-900",confirmButton:r?"bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded":"bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded",cancelButton:r?"bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded":"bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded"}}).then((e=>{e.isConfirmed&&a()}))}function renameFile(e,t,n,a,r){showDialog("Rename File","Enter the new name for the file:","Rename",e,(o=>{o&&o.trim()!==e&&sendRequest({csrf:t,action:"rename",oldName:e,newName:o.trim(),dir:n},a,r).then((()=>{triggerAlert("success","File renamed successfully!"),loadDirectory(n,1,t,a,r)})).catch((e=>{triggerAlert("warning",e)}))}))}function deleteFile(e,t,n,a,r){showConfirmation("Delete File",`Are you sure you want to delete "${e}"?`,"Delete",(()=>{sendRequest({csrf:t,action:"delete",file:e,dir:n},a,r).then((()=>{triggerAlert("success",`"${e}" has been deleted successfully!`),loadDirectory(n,1,t,a,r)})).catch((e=>{triggerAlert("warning",e)}))}))}function progr(){isLoading||(isLoading=!0,NProgress.start())}function dprogr(){NProgress.done(),isLoading=!1}function loadDirectory(e,t,n,a,r,o){if(progr(),!o){const e=document.getElementById("itemLimit");if(e&&e.value)o=e.value;else{o=localStorage.getItem("default-items-per-page")||"50"}}if("all"!==o&&"infinity"!==o){const e=parseInt(o,10);(isNaN(e)||e<=0)&&(o="50")}const i={csrf:n,action:"list",dir:e,page:t,itemsPerPage:o},l=JSON.stringify(i),s="1"===r?encrypt(l,a):l;$.post("",s,(function(o){handleDirectoryResponse(o,r,a,e,t,n),dprogr()})).fail((function(){triggerAlert("warning","An error occurred while loading the directory."),dprogr()}))}function handleDirectoryResponse(e,t,n,a,r,o){try{let i="1"===t?decrypt(e,n):e;const l=JSON.parse(i);if(window.fileManagerState||(window.fileManagerState={files:[],totalPages:1,currentPage:1,totalItems:0,itemsPerPage:50,currentSort:{column:"name",direction:"asc"},selectedFiles:[]}),l.error)triggerAlert("warning",l.error);else{window.fileManagerState.files=l.files,window.fileManagerState.totalPages=l.totalPages,window.fileManagerState.currentPage=r,window.fileManagerState.currentDir=a,window.fileManagerState.totalItems=l.totalItems||0;const e=document.getElementById("itemLimit");if(e){const t=e.value;window.fileManagerState.itemsPerPage=t}"function"==typeof window.updateCurrentPath&&window.updateCurrentPath(a),renderFiles(l.files,a,o,n,t),"function"==typeof window.updateBreadcrumbs&&window.updateBreadcrumbs(a),"function"==typeof window.updateActiveTabPath&&(window.updateActiveTabPath(a),"function"==typeof window.saveTabsToLocalStorage&&window.saveTabsToLocalStorage()),updateFileTableFooter()}}catch(e){triggerAlert("warning","Failed to parse server response.")}}function createFileRow(e,t,n,a,r){let o,i,l,s="text-blue-600 dark:text-blue-400";e.wr?(o="text-green-600 dark:text-green-400",i="Writable",l="bg-green-50 dark:bg-green-900/10"):e.perms&&e.perms.includes("r")?(o="text-yellow-600 dark:text-yellow-400",i="Read Only",l="bg-yellow-50 dark:bg-yellow-900/10"):(o="text-blue-600 dark:text-blue-400",i="No Read/Write Access",l="bg-blue-50 dark:bg-blue-900/10");e.is_dir?s="text-yellow-600 dark:text-yellow-400":e.name.endsWith(".php")||e.name.endsWith(".py")||e.name.endsWith(".js")?s="text-green-600 dark:text-green-400":(e.name.endsWith(".zip")||e.name.endsWith(".tar")||e.name.endsWith(".gz"))&&(s="text-amber-600 dark:text-amber-400");const c=`${t}/${e.name}`,d=`file-checkbox-${e.name.replace(/[^a-zA-Z0-9]/g,"_")}`,u=window.fileManagerState&&window.fileManagerState.selectedFiles&&(window.fileManagerState.selectedFiles.includes(c)||window.fileManagerState.selectedFiles.includes(e.name)),m=u?"checked":"";let g="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150";return g+=u?" bg-blue-50 dark:bg-blue-900/20":" "+l,`\n        <tr class="${g}" data-file="${e.name}" data-full-path="${c}">\n            <td class="py-1 px-3 text-left">\n                <input type="checkbox" id="${d}" \n                    class="file-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" \n                    data-file="${e.name}" \n                    data-full-path="${c}" \n                    ${m} \n                />\n            </td>\n            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">\n                <div class="flex items-center">\n                    <i class="fas ${e.icon} mr-2 ${s}"></i>\n                ${e.is_dir?`<a href="#" class="font-medium directory-link hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-150" data-path="${c}">${e.name}</a>`:`<a href="#" class="font-medium file-link hover:text-blue-600 dark:hover:text-blue-400 transition-colors duration-150" data-file="${c}">${e.name}</a>`}\n                </div>\n            </td>\n            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.size}</td>\n            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.mtime}</td>\n            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">${e.owner}</td>\n            <td class="py-3 px-6 text-left" title="${i}">\n                ${formatPermissions(e.perms,e.wr)}\n            </td>\n            <td class="py-3 px-6 text-left text-gray-900 dark:text-gray-300">\n                <div class="flex space-x-2">\n                ${e.is_dir?`<button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150">\n                              <i class="fas fa-edit text-yellow-600 dark:text-yellow-400" title="Rename" data-file="${e.name}"></i>\n                           </button>\n                           <button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150">\n                              <i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${c}"></i>\n                           </button>`:`<button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150">\n                              <i class="fas fa-edit text-yellow-600 dark:text-yellow-400" title="Rename" data-file="${e.name}"></i>\n                           </button>\n                           <button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150">\n                              <i class="fas fa-trash-alt text-red-600 dark:text-red-400" title="Delete" data-file="${c}"></i>\n                           </button>\n                           <button class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-150">\n                       <i class="fas fa-download text-green-600 dark:text-green-400" title="Download" data-file="${t+"/"+e.name}"></i>\n\n                           </button>`}\n                </div>\n            </td>\n        </tr>\n    `}function triggerAlert(e,t){document.dispatchEvent(new CustomEvent("show-alert",{detail:{type:e,message:t}}))}function encrypt(e,t){return CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(e),t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString()}function decrypt(e,t){return CryptoJS.AES.decrypt(e,t,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}function searchFiles(e,t){if(!e||!Array.isArray(e))return[];if(!t||""===t.trim())return e;const n=t.toLowerCase().trim();return e.filter((e=>!!e&&(e.name&&e.name.toLowerCase().includes(n)||e.owner&&e.owner.toLowerCase().includes(n)||e.perms&&e.perms.toLowerCase().includes(n)||e.size&&e.size.toString().toLowerCase().includes(n)||e.mtime&&e.mtime.toLowerCase().includes(n))))}function renderFiles(e,t,n,a,r){const o=document.getElementById("searchBar")||document.querySelector("#searchBar"),i=o?o.value.toLowerCase().trim():"",l=document.getElementById("fileList");if(!l)return;if(!e||0===e.length)return l.innerHTML='<tr><td colspan="7" class="py-4 text-center text-gray-500">No files found</td></tr>',void updateFileTableFooter();const s=searchFiles(e,i);0===s.length?l.innerHTML='<tr><td colspan="7" class="py-4 text-center text-gray-500">No matching files found</td></tr>':l.innerHTML=s.map((e=>createFileRow(e,t,n,a,r))).join(""),addCheckboxEventListeners(),updateFileTableFooter()}function appendFiles(e,t,n,a,r){const o=document.getElementById("searchBar")||document.querySelector("#searchBar"),i=o?o.value.toLowerCase().trim():"",l=document.getElementById("fileList");if(!l)return;if(!e||0===e.length)return;const s=searchFiles(e,i);if(s.length>0){const e=s.map((e=>createFileRow(e,t,n,a,r))).join("");l.innerHTML+=e,addCheckboxEventListeners()}}function addCheckboxEventListeners(){const e=document.querySelectorAll(".file-checkbox");window.fileManagerState||(window.fileManagerState={selectedFiles:[]}),window.fileManagerState.selectedFiles||(window.fileManagerState.selectedFiles=[]),e.forEach((e=>{e.removeEventListener("change",checkboxChangeHandler),e.addEventListener("change",checkboxChangeHandler);const t=e.dataset.fullPath||e.dataset.file;if(window.fileManagerState.selectedFiles.includes(t)){e.checked=!0;const t=e.closest("tr");t&&t.classList.add("bg-blue-50","dark:bg-blue-900/20")}else{e.checked=!1;const t=e.closest("tr");t&&t.classList.remove("bg-blue-50","dark:bg-blue-900/20")}})),updateSelectAllCheckbox()}function updateSelectAllCheckbox(){const e=document.getElementById("selectAll");if(!e)return;const t=document.querySelectorAll(".file-checkbox");if(0===t.length)return;const n=Array.from(t).every((e=>e.checked)),a=Array.from(t).some((e=>e.checked));e.checked=n,e.indeterminate=!n&&a}function checkboxChangeHandler(){const e=this.closest("tr"),t=this.dataset.file,n=this.dataset.fullPath||t;this.checked?(e.classList.add("bg-blue-50","dark:bg-blue-900/20"),updateSelectedFiles(n,!0,!0)):(e.classList.remove("bg-blue-50","dark:bg-blue-900/20"),updateSelectedFiles(n,!1,!0));document.querySelectorAll(".file-checkbox:checked");updateSelectAllCheckbox()}function sortFiles(){if(!window.fileManagerState)return void(window.fileManagerState={files:[],totalPages:1,currentPage:1,currentSort:{column:"name",direction:"asc"},selectedFiles:[]});const{column:e,direction:t}=window.fileManagerState.currentSort;window.fileManagerState.files.sort(((n,a)=>{let r,o;switch(e){case"name":r=n.name.toLowerCase(),o=a.name.toLowerCase();break;case"size":r="dir"===n.size?-1:parseFloat(n.size),o="dir"===a.size?-1:parseFloat(a.size);break;case"mtime":case"modified":r=new Date(n.mtime).getTime(),o=new Date(a.mtime).getTime();break;case"owner":r=n.owner.toLowerCase(),o=a.owner.toLowerCase();break;case"perms":r=n.perms,o=a.perms;break;default:r=n.name.toLowerCase(),o=a.name.toLowerCase()}return"asc"===t?r>o?1:-1:r<o?1:-1}))}function updateSelectedFiles(e,t,n=!1){window.fileManagerState||(window.fileManagerState={selectedFiles:[]}),window.fileManagerState.selectedFiles||(window.fileManagerState.selectedFiles=[]);let a=e;if(!n){const t=document.querySelector(`.file-checkbox[data-file="${e}"]`);if(t&&t.dataset.fullPath)a=t.dataset.fullPath;else if(!e.includes("/")){const t=window.fileManagerState.currentDir||"";t&&(a=`${t}/${e}`)}}t?window.fileManagerState.selectedFiles.includes(a)||window.fileManagerState.selectedFiles.push(a):window.fileManagerState.selectedFiles=window.fileManagerState.selectedFiles.filter((e=>e!==a))}function resBulk(){let e=document.getElementById("bulkActions");e&&(e.value="")}function freeclipbroad(){try{localStorage.removeItem("copiedFiles")}catch(e){}}function handleCreate(e,t,n,a,r,o){["file","folder"].includes(t)?sendRequest(e,n,a).then((()=>{loadDirectory(r,1,o,n,a)})).catch((e=>{triggerAlert("warning",e)})):triggerAlert("warning","Invalid type. Only file or folder are allowed")}function viewEditFile(e,t,n,a){progr();try{const r=e.split("/").pop(),o=(r.split(".").pop()||"").toLowerCase();if([...["jpg","jpeg","png","gif","bmp","webp","svg","ico"],...["mp4","webm","ogg","avi","mov","wmv","flv","mkv"],...["mp3","wav","ogg","aac","flac","m4a"],...["pdf"],...["doc","docx","xls","xlsx","ppt","pptx"]].includes(o))return showFilePreviewModal(e,r,o,t,n,a),void dprogr();if("function"!=typeof window.addNewTab)return triggerAlert("warning","Editor tab functionality is not available."),void dprogr();const i=window.addNewTab(r,"editor");let l=document.getElementById(`${i}-content`);if(!l){const e=document.getElementById("tabs-content");if(!e)return dprogr(),void triggerAlert("warning","Tabs container not found.");l=document.createElement("div"),l.id=`${i}-content`,l.className="tabs-panel w-full",e.appendChild(l)}l.dataset.filePath=e,l.innerHTML="";const s=document.createElement("div");s.className="editor-container",s.style.width="100%",s.style.height="90vh",s.style.border="1px solid #ddd",s.style.position="relative",l.appendChild(s),"function"==typeof window.switchToTab&&window.switchToTab(i),document.querySelectorAll(".tabs-panel").forEach((e=>e.classList.add("hidden"))),l.classList.remove("hidden"),sendRequest({csrf:t,action:"view_content",file:e},n,a).then((r=>{let o="";if("string"==typeof r?o=r:!r||void 0===r.content&&void 0===r.data||(o=r.content??r.data),void 0===window.CodeMirror)return s.innerHTML=`<pre style="white-space: pre-wrap; padding: 1rem;">${o}</pre>`,triggerAlert("warning","CodeMirror editor not found. Displaying content in plain text mode."),void dprogr();const i=getLanguageFromFileName(e),c=CodeMirror(s,{value:o,mode:i,theme:document.documentElement.classList.contains("dark")?"dracula":"eclipse",lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,autoCloseBrackets:!0,styleActiveLine:!0});window.editor=c,c.setSize("100%","100%");let d=l.querySelector(".save-file-btn");d||(d=document.createElement("button"),d.className="save-file-btn fixed bottom-4 right-4 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded shadow-lg z-50",d.innerHTML='<i class="fas fa-save mr-2"></i> Save',d.addEventListener("click",(()=>{const r=c.getValue();saveFileContent(e,r,t,n,a)})),l.appendChild(d)),setTimeout((()=>{c.refresh(),c.focus()}),100),dprogr()})).catch((e=>{triggerAlert("warning","Failed to load file content."),s.innerHTML=`<pre style="white-space: pre-wrap; padding: 1rem;">${String(e)}</pre>`,dprogr()}))}catch(e){triggerAlert("warning","An unexpected error occurred while opening the file."),dprogr()}}function showFilePreviewModal(e,t,n,a,r,o){const i=document.getElementById("file-preview-modal");i&&i.remove();const l=document.createElement("div");l.id="file-preview-modal",l.className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50",l.style.zIndex="9999";const s=document.createElement("div");s.className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl max-h-[90vh] w-full m-4 flex flex-col";const c=document.createElement("div");c.className="flex items-center justify-between p-4 border-b dark:border-gray-700",c.innerHTML=`\n        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate">${t}</h3>\n        <div class="flex items-center space-x-2">\n            <a href="#" onclick="dwn('${e}', '${a}', '${r}', '${o}'); return false;" class="text-blue-500 hover:text-blue-600 dark:text-blue-400" title="Download">\n                <i class="fas fa-download"></i>\n            </a>\n            \n            <button id="close-preview-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">\n                <i class="fas fa-times text-xl"></i>\n            </button>\n        </div>\n    `;const d=document.createElement("div");d.className="flex-1 p-4 overflow-auto flex items-center justify-center",d.innerHTML='<div class="flex items-center justify-center"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><span class="ml-2 text-gray-500">Loading...</span></div>',s.appendChild(c),s.appendChild(d),l.appendChild(s),document.body.appendChild(l),document.getElementById("close-preview-modal").addEventListener("click",(()=>{l.remove()})),l.addEventListener("click",(e=>{e.target===l&&l.remove()}));const u=e=>{"Escape"===e.key&&(l.remove(),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u),sendRequest({csrf:a,action:"view_content",file:e},r,o).then((i=>{let l,s;i.is_binary?(l=atob(i.content),s=i.mime_type):(l=i.content,s=i.mime_type);if(i.is_binary){const e=l.length,t=new Uint8Array(e);for(let n=0;n<e;n++)t[n]=l.charCodeAt(n);l=t}if(["jpg","jpeg","png","gif","bmp","webp","svg","ico"].includes(n)){const e=new Blob([l],{type:s}),n=URL.createObjectURL(e),a=document.createElement("img");a.className="max-w-full max-h-full object-contain",a.style.maxHeight="70vh",a.src=n,a.alt=t,d.innerHTML="",d.appendChild(a),a.onload=()=>URL.revokeObjectURL(n),a.onerror=()=>{URL.revokeObjectURL(n),d.innerHTML=`\n                        <div class="text-center text-red-500">\n                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                            <p>Failed to load image</p>\n                            <p class="text-sm text-gray-500 mt-2">${t}</p>\n                        </div>\n                    `}}else if(["mp4","webm","ogg","avi","mov","wmv","flv","mkv"].includes(n)){const e=new Blob([l],{type:s}),n=URL.createObjectURL(e),a=document.createElement("video");a.className="max-w-full max-h-full",a.style.maxHeight="70vh",a.controls=!0,a.preload="metadata",a.src=n,d.innerHTML="",d.appendChild(a),a.onloadedmetadata=()=>URL.revokeObjectURL(n),a.onerror=()=>{URL.revokeObjectURL(n),d.innerHTML=`\n                        <div class="text-center text-red-500">\n                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                            <p>Failed to load video</p>\n                            <p class="text-sm text-gray-500 mt-2">${t}</p>\n                        </div>\n                    `}}else if(["mp3","wav","ogg","aac","flac","m4a"].includes(n)){const e=new Blob([l],{type:s}),n=URL.createObjectURL(e),a=document.createElement("div");a.className="flex flex-col items-center space-y-4 p-8";const r=document.createElement("audio");r.className="w-full max-w-md",r.controls=!0,r.preload="metadata",r.src=n,a.innerHTML=`\n                    <i class="fas fa-music text-6xl text-gray-400 mb-4"></i>\n                    <p class="text-gray-600 dark:text-gray-400 text-center">${t}</p>\n                `,a.appendChild(r),d.innerHTML="",d.appendChild(a),r.onloadedmetadata=()=>URL.revokeObjectURL(n),r.onerror=()=>{URL.revokeObjectURL(n),d.innerHTML=`\n                        <div class="text-center text-red-500">\n                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                            <p>Failed to load audio</p>\n                            <p class="text-sm text-gray-500 mt-2">${t}</p>\n                        </div>\n                    `}}else if("pdf"===n){const t=new Blob([l],{type:"application/pdf"}),n=URL.createObjectURL(t),i=document.createElement("iframe");i.src=n,i.className="w-full border-0 rounded",i.style.height="70vh",d.innerHTML="",d.appendChild(i),i.onload=()=>URL.revokeObjectURL(n),i.onerror=()=>{URL.revokeObjectURL(n),d.innerHTML=`\n                        <div class="text-center text-red-500">\n                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                            <p>Failed to load PDF</p>\n                            <p class="text-sm text-gray-500 mt-2">\n                                <a href="#" onclick="dwn('${e}', '${a}', '${r}', '${o}'); return false;" class="text-blue-500 underline hover:text-blue-600">\n                                    Download to view\n                                </a>\n                            </p>\n                        </div>\n                    `}}else if(["doc","docx","xls","xlsx","ppt","pptx"].includes(n)){const t=new Blob([l],{type:s}),n=URL.createObjectURL(t),i=`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(window.location.origin+n)}`,c=document.createElement("iframe");c.src=i,c.className="w-full border-0 rounded",c.style.height="70vh",d.innerHTML="",d.appendChild(c),c.onload=()=>URL.revokeObjectURL(n),c.onerror=()=>{URL.revokeObjectURL(n),d.innerHTML=`\n                        <div class="text-center text-red-500">\n                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                            <p>Failed to preview document</p>\n                            <p class="text-sm text-gray-500 mt-2">\n                                <a href="#" onclick="dwn('${e}', '${a}', '${r}', '${o}'); return false;" class="text-blue-500 underline hover:text-blue-600">\n                                    Download to view\n                                </a>\n                            </p>\n                        </div>\n                    `}}})).catch((e=>{d.innerHTML=`\n                <div class="text-center text-red-500">\n                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>\n                    <p>Failed to load file</p>\n                    <p class="text-sm text-gray-500 mt-2">${e.message||"Unknown error"}</p>\n                </div>\n            `}))}function getFileUrl(e){return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`/${e}`}function loadPDFWithPDFJS(e,t){const n=document.createElement("iframe");n.src=`${e}?t=${Date.now()}`,n.className="w-full h-full border-0",n.style.minHeight="60vh",t.innerHTML="",t.appendChild(n)}function saveFileContent(e,t,n,a,r){progr();sendRequest({csrf:n,action:"save_content",file:e,content:t},a,r).then((()=>{triggerAlert("success","File content saved successfully!")})).catch((e=>{triggerAlert("warning",e)})),dprogr()}window.sortFiles=sortFiles;let contextMenuTarget=null,currentContextMenuType=null;function initContextMenu(e={}){document.getElementById("context-menu")||createContextMenuElement();document.getElementById("context-menu");document.getElementById("file").addEventListener("contextmenu",handleContextMenu),document.addEventListener("click",hideContextMenu),window.addEventListener("blur",hideContextMenu),window.addEventListener("resize",hideContextMenu),document.addEventListener("scroll",hideContextMenu,!0),addMenuItemEventListeners()}function createContextMenuElement(){const e=document.createElement("div");e.id="context-menu",e.className="hidden absolute z-50 min-w-[200px] bg-white dark:bg-gray-800 shadow-lg rounded-md py-2 border border-gray-200 dark:border-gray-700",e.innerHTML='\n        <div class="context-menu-group file-operations hidden">\n            <button class="context-menu-item" data-action="rename">\n                <i class="fas fa-signature mr-2"></i>Rename\n            </button>\n            <button class="context-menu-item" data-action="download">\n                <i class="fas fa-download mr-2"></i>Download\n            </button>\n        </div>\n        <div class="context-menu-group folder-operations hidden">\n            <button class="context-menu-item" data-action="open-folder">\n                <i class="fas fa-folder-open mr-2"></i>Open\n            </button>\n            <button class="context-menu-item" data-action="open-folder-new-tab">\n                <i class="fas fa-external-link-alt mr-2"></i>Open in New Tab\n            </button>\n            <button class="context-menu-item" data-action="rename-folder">\n                <i class="fas fa-signature mr-2"></i>Rename\n            </button>\n        </div>\n        <div class="context-menu-group clipboard-operations">\n            <button class="context-menu-item" data-action="copy">\n                <i class="fas fa-copy mr-2"></i>Copy\n            </button>\n            <button class="context-menu-item" data-action="cut">\n                <i class="fas fa-cut mr-2"></i>Cut\n            </button>\n            <button class="context-menu-item paste-option hidden" data-action="paste">\n                <i class="fas fa-paste mr-2"></i>Paste\n            </button>\n        </div>\n        <div class="context-menu-divider border-t border-gray-200 dark:border-gray-700 my-1"></div>\n        <div class="context-menu-group danger-operations">\n            <button class="context-menu-item text-red-600 dark:text-red-400" data-action="delete">\n                <i class="fas fa-trash-alt mr-2"></i>Delete\n            </button>\n        </div>\n        <div class="context-menu-group bg-operations hidden">\n            <div class="context-menu-divider border-t border-gray-200 dark:border-gray-700 my-1"></div>\n            <button class="context-menu-item" data-action="new-file">\n                <i class="fas fa-file-circle-plus mr-2"></i>New File\n            </button>\n            <button class="context-menu-item" data-action="new-folder">\n                <i class="fas fa-folder-plus mr-2"></i>New Folder\n            </button>\n            <button class="context-menu-item" data-action="refresh">\n                <i class="fas fa-sync-alt mr-2"></i>Refresh\n            </button>\n        </div>\n    ';const t=document.createElement("style");t.textContent="\n        .context-menu-item {\n            display: flex;\n            align-items: center;\n            width: 100%;\n            text-align: left;\n            padding: 0.5rem 1rem;\n            font-size: 0.875rem;\n            white-space: nowrap;\n            color: #374151; /* gray-700 */\n            transition: background-color 0.15s ease;\n        }\n        .dark .context-menu-item {\n            color: #e5e7eb; /* gray-200 */\n        }\n        .context-menu-item:hover {\n            background-color: rgba(59, 130, 246, 0.1);\n        }\n        .dark .context-menu-item:hover {\n            background-color: rgba(96, 165, 250, 0.1);\n        }\n        .context-menu-item:focus {\n            outline: none;\n            background-color: rgba(59, 130, 246, 0.15);\n        }\n        .dark .context-menu-item:focus {\n            background-color: rgba(96, 165, 250, 0.15);\n        }\n        .context-menu-item i {\n            color: #4b5563; /* gray-600 */\n        }\n        .dark .context-menu-item i {\n            color: #d1d5db; /* gray-300 */\n        }\n        .context-menu-item.text-red-600 i {\n            color: #dc2626; /* red-600 */\n        }\n        .dark .context-menu-item.text-red-400 i {\n            color: #f87171; /* red-400 */\n        }\n        @keyframes contextMenuFadeIn {\n            from { opacity: 0; transform: scale(0.95); }\n            to { opacity: 1; transform: scale(1); }\n        }\n        #context-menu {\n            transform-origin: top left;\n            animation: contextMenuFadeIn 0.1s ease-out forwards;\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);\n        }\n        .dark #context-menu {\n            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.18);\n        }\n    ",document.head.appendChild(t),document.body.appendChild(e)}function handleContextMenu(e){e.preventDefault();const t=document.getElementById("context-menu");t&&(hideAllMenuGroups(),setContextMenuTarget(e),updateMenuVisibility(),updatePasteOption(),positionContextMenu(e.clientX,e.clientY),t.classList.remove("hidden"))}function setContextMenuTarget(e){let t=e.target;if(t.closest("tr")){const e=t.closest("tr"),n=e.querySelector(".file-checkbox");if(n&&n.dataset.file){contextMenuTarget=n.dataset.file;const t=null!==e.querySelector(".directory-link");return currentContextMenuType=t?"folder":"file",void(document.querySelectorAll(".file-checkbox:checked").length>1&&n.checked&&(currentContextMenuType="multiple"))}}contextMenuTarget=document.getElementById("fileList"),currentContextMenuType="background"}function updateMenuVisibility(){const e=document.getElementById("context-menu");e&&(hideAllMenuGroups(),"file"===currentContextMenuType?(e.querySelector(".file-operations").classList.remove("hidden"),e.querySelector(".clipboard-operations").classList.remove("hidden")):"folder"===currentContextMenuType?(e.querySelector(".folder-operations").classList.remove("hidden"),e.querySelector(".clipboard-operations").classList.remove("hidden")):"multiple"===currentContextMenuType?e.querySelector(".clipboard-operations").classList.remove("hidden"):"background"===currentContextMenuType&&(e.querySelector(".bg-operations").classList.remove("hidden"),e.querySelector(".paste-option").classList.remove("hidden")))}function hideAllMenuGroups(){const e=document.getElementById("context-menu");if(!e)return;e.querySelectorAll(".context-menu-group").forEach((e=>e.classList.add("hidden")))}function updatePasteOption(){const e=document.querySelector(".paste-option");if(!e)return;null!==localStorage.getItem("copiedFiles")?e.classList.remove("hidden"):e.classList.add("hidden")}function positionContextMenu(e,t){const n=document.getElementById("context-menu");if(!n)return;const a=window.innerWidth,r=window.innerHeight;n.style.visibility="hidden",n.classList.remove("hidden");const o=n.offsetWidth,i=n.offsetHeight;let l=e,s=t;e+o>a&&(l=a-o-5),t+i>r&&(s=r-i-5),n.style.left=`${l}px`,n.style.top=`${s}px`,n.style.visibility="visible"}function hideContextMenu(){const e=document.getElementById("context-menu");e&&e.classList.add("hidden"),contextMenuTarget=null}function addMenuItemEventListeners(){const e=document.getElementById("context-menu");if(!e)return;e.querySelectorAll(".context-menu-item").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();handleMenuAction(e.dataset.action),hideContextMenu()}))}))}function handleMenuAction(e){const t=window.fileManagerState?.currentDir||phpVars?.currentDir,n=phpVars?.csrf,a=phpVars?.encryptionKey?CryptoJS.enc.Utf8.parse(phpVars.encryptionKey):null,r=phpVars?.isEnc,o=(e,t)=>e.endsWith("/")?e+t:e+"/"+t;switch(e){case"open-folder":if(contextMenuTarget){const e=o(t,contextMenuTarget);window.currentDir=e,window.updateCurrentPath();let i=document.getElementById("itemLimit"),l=i?i.value:"50";loadDirectory(e,1,n,a,r,l),window.updateActiveTabPath(e)}break;case"open-folder-new-tab":if(contextMenuTarget){const e=o(t,contextMenuTarget);if("function"==typeof window.addNewTab){window.addNewTab(contextMenuTarget);loadDirectory(e,1,n,a,r),window.updateActiveTabPath(e)}else window.currentDir=e,window.updateCurrentPath(),loadDirectory(e,1,n,a,r),window.updateActiveTabPath(e)}break;case"rename":case"rename-folder":contextMenuTarget&&renameFile(contextMenuTarget,n,t,a,r);break;case"download":contextMenuTarget&&dwn(o(t,contextMenuTarget),n,a,r);break;case"copy":if("multiple"===currentContextMenuType){const e=Array.from(document.querySelectorAll(".file-checkbox:checked")).map((e=>{const n=e.dataset.file;return o(t,n)}));saveToLocalStorage(e)}else contextMenuTarget&&saveToLocalStorage([o(t,contextMenuTarget)]);triggerAlert("success","Item(s) copied to clipboard");break;case"cut":if("multiple"===currentContextMenuType){const e=Array.from(document.querySelectorAll(".file-checkbox:checked")).map((e=>{const n=e.dataset.file;return o(t,n)}));saveToLocalStorage(e),localStorage.setItem("clipboard-action","cut")}else contextMenuTarget&&(saveToLocalStorage([o(t,contextMenuTarget)]),localStorage.setItem("clipboard-action","cut"));triggerAlert("info","Item(s) ready to move");break;case"paste":const e=getFromLocalStorage();e&&e.length>0?(triggerAlert("info",`Pasting ${e.length} item(s)...`),performBulkAction("paste",e,t,n,a,r),freeclipbroad(),localStorage.removeItem("clipboard-action")):triggerAlert("warning","No items in clipboard");break;case"delete":if("multiple"===currentContextMenuType){const e=Array.from(document.querySelectorAll(".file-checkbox:checked")).map((e=>e.dataset.file));showConfirmation("Delete Files",`Are you sure you want to delete ${e.length} file(s)?`,"Delete",(()=>{performBulkAction("delete",e,t,n,a,r)}))}else contextMenuTarget&&deleteFile(contextMenuTarget,n,t,a,r);break;case"refresh":loadDirectory(t,1,n,a,r);break}}function getLanguageFromFileName(e){if(!e)return"plaintext";return{js:"javascript",mjs:"javascript",cjs:"javascript",jsx:"javascript",ts:"javascript",tsx:"javascript",html:"htmlmixed",htm:"htmlmixed",css:"css",scss:"css",less:"css",json:"javascript",xml:"xml",svg:"xml",php:"php",py:"python",rb:"ruby",java:"clike",c:"clike",cpp:"clike",cs:"clike",h:"clike",hpp:"clike",sh:"shell",bash:"shell",zsh:"shell",fish:"shell",conf:"shell",ini:"shell",yaml:"yaml",yml:"yaml",md:"markdown",markdown:"markdown",sql:"sql",txt:"plaintext",log:"plaintext"}[e.split(".").pop().toLowerCase()]||"plaintext"}function formatPermissions(e,t=null,n=!0){if(!e||"string"!=typeof e||9!==e.length)return'<span class="text-blue-600 dark:text-blue-400">invalid</span>';let a;a=null!==t?t?"text-green-600 dark:text-green-400":n?"text-yellow-600 dark:text-yellow-400":"text-blue-600 dark:text-blue-400":e.includes("w")?"text-green-600 dark:text-green-400":e.includes("r")?"text-yellow-600 dark:text-yellow-400":"text-blue-600 dark:text-blue-400";let r="";for(let t=0;t<e.length;t++)r+=e[t],2!==t&&5!==t||(r+=" ");return`<span class="${a} font-mono">${r}</span>`}function diagnoseFileSorting(){window.fileManagerState;const e=document.querySelectorAll("th[data-sort]");return e.forEach((e=>{})),{fileManagerState:window.fileManagerState?"Available":"Missing",sortFiles:"function"==typeof window.sortFiles?"Available":"Missing",renderFiles:"function"==typeof window.renderFiles?"Available":"Missing",createFileRow:"function"==typeof window.createFileRow?"Available":"Missing",headers:Array.from(e).map((e=>({text:e.textContent.trim(),sort:e.dataset.sort})))}}function debounce(e,t=300){let n;return function(...a){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...a)}),t)}}function diagnoseSearch(){const e=document.getElementById("searchBar")||document.querySelector("#searchBar"),t=document.getElementById("clearSearch");if(window.fileManagerState,"function"==typeof window.searchFiles&&window.fileManagerState&&window.fileManagerState.files){const e="test";window.searchFiles(window.fileManagerState.files,e)}return{searchBarFound:!!e,searchValue:e?e.value:null,clearButtonFound:!!t,clearButtonVisible:!!t&&"none"!==t.style.display,fileManagerStateExists:!!window.fileManagerState,fileCount:window.fileManagerState&&window.fileManagerState.files?window.fileManagerState.files.length:0,searchFunctionExists:"function"==typeof window.searchFiles}}function updateFileTableFooter(){const e=document.querySelector(".overflow-x-auto table");if(!e)return;const t=window.fileManagerState||{},n=t.totalItems||0,a=t.currentPage||1,r=t.itemsPerPage||50,o=t.files?t.files.length:0;let i,l;"all"===r?(i=n>0?1:0,l=n):(i=0===n?0:(a-1)*parseInt(r,10)+1,l=Math.min(i+o-1,n));let s=e.querySelector("tfoot");s&&s.remove(),s=document.createElement("tfoot"),s.className="bg-gray-50 dark:bg-gray-700 text-xs text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700",s.innerHTML=`\n        <tr> \n            <td colspan="7" class="py-3 px-6">\n                <div class="flex justify-between items-center">\n                    <div>\n                        <span class="font-medium">Showing:</span> \n                        <span class="text-blue-600 dark:text-blue-400 font-medium">${l}</span> \n                        of \n                        <span class="text-blue-600 dark:text-blue-400 font-medium">${n}</span> items\n                    </div>\n                </div>\n            </td>\n        </tr>\n    `,e.appendChild(s);const c=document.getElementById("fileTableFooter");c&&c.remove()}function exposeGlobalFunctions(){window.initializeFileManager=initializeFileManager,window.showDialog=showDialog,window.showConfirmation=showConfirmation,window.progr=progr,window.dprogr=dprogr,window.loadDirectory=loadDirectory,window.handleDirectoryResponse=handleDirectoryResponse,window.createFileRow=createFileRow,window.triggerAlert=triggerAlert,window.encrypt=encrypt,window.decrypt=decrypt,window.searchFiles=searchFiles,window.renderFiles=renderFiles,window.appendFiles=appendFiles,window.viewEditFile=viewEditFile,window.saveFileContent=saveFileContent,window.updateSelectedFiles=updateSelectedFiles,window.getLanguageFromFileName=getLanguageFromFileName,window.formatPermissions=formatPermissions}function saveOpenedFilesState(e,t="add"){try{let n=JSON.parse(localStorage.getItem("fileManager_openFiles")||"[]");return"add"===t?n.includes(e)||n.push(e):"remove"===t&&(n=n.filter((t=>t!==e))),localStorage.setItem("fileManager_openFiles",JSON.stringify(n)),!0}catch(e){return!1}}function dwn(e,t,n,a){fetch("",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({csrf:t,action:"download",file:e,dir:"",key:n,isEnc:a})}).then((t=>{const n=e.split("/").pop();return t.blob().then((e=>({blob:e,filename:n})))})).then((({blob:e,filename:t})=>{const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),URL.revokeObjectURL(n),a.remove()})).catch((e=>{triggerAlert("warning","Download failed")}))}window.initContextMenu=initContextMenu,window.renderFiles=renderFiles,exposeGlobalFunctions(),window.saveOpenedFilesState=saveOpenedFilesState,window.showFilePreviewModal=showFilePreviewModal;
